<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-architecture/storage-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Storage Design | Spectre</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://moolen.github.io/spectre/img/spectre-social-card.png"><meta data-rh="true" name="twitter:image" content="https://moolen.github.io/spectre/img/spectre-social-card.png"><meta data-rh="true" property="og:url" content="https://moolen.github.io/spectre/docs/architecture/storage-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Storage Design | Spectre"><meta data-rh="true" name="description" content="Deep dive into Spectre&#x27;s storage architecture and design decisions"><meta data-rh="true" property="og:description" content="Deep dive into Spectre&#x27;s storage architecture and design decisions"><meta data-rh="true" name="keywords" content="architecture,storage,design,blocks,hourly files"><link data-rh="true" rel="icon" href="/spectre/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://moolen.github.io/spectre/docs/architecture/storage-design"><link data-rh="true" rel="alternate" href="https://moolen.github.io/spectre/docs/architecture/storage-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://moolen.github.io/spectre/docs/architecture/storage-design" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Architecture","item":"https://moolen.github.io/spectre/docs/architecture/"},{"@type":"ListItem","position":2,"name":"Storage Design","item":"https://moolen.github.io/spectre/docs/architecture/storage-design"}]}</script><link rel="stylesheet" href="/spectre/assets/css/styles.d42b8c2d.css">
<script src="/spectre/assets/js/runtime~main.2344fe77.js" defer="defer"></script>
<script src="/spectre/assets/js/main.7008b389.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/spectre/"><div class="navbar__logo"><img src="/spectre/img/ghost.svg" alt="Spectre Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/spectre/img/ghost.svg" alt="Spectre Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Spectre</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/spectre/docs/intro">Documentation</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/moolen/spectre" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/spectre/docs/intro"><span title="Introduction to Spectre" class="linkLabel_WmDU">Introduction to Spectre</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/getting-started/"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a><button aria-label="Collapse sidebar category &#x27;Getting Started&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/getting-started/quick-start"><span title="Quick Start" class="linkLabel_WmDU">Quick Start</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/getting-started/demo-mode"><span title="Demo Mode" class="linkLabel_WmDU">Demo Mode</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/installation/"><span title="Installation" class="categoryLinkLabel_W154">Installation</span></a><button aria-label="Expand sidebar category &#x27;Installation&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/configuration/"><span title="Configuration" class="categoryLinkLabel_W154">Configuration</span></a><button aria-label="Expand sidebar category &#x27;Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/user-guide/"><span title="User Guide" class="categoryLinkLabel_W154">User Guide</span></a><button aria-label="Expand sidebar category &#x27;User Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/use-cases/"><span title="Use Cases" class="categoryLinkLabel_W154">Use Cases</span></a><button aria-label="Expand sidebar category &#x27;Use Cases&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/mcp-integration/"><span title="MCP Integration" class="categoryLinkLabel_W154">MCP Integration</span></a><button aria-label="Expand sidebar category &#x27;MCP Integration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/spectre/docs/architecture/"><span title="Architecture" class="categoryLinkLabel_W154">Architecture</span></a><button aria-label="Collapse sidebar category &#x27;Architecture&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/overview"><span title="Architecture Overview" class="linkLabel_WmDU">Architecture Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/spectre/docs/architecture/storage-design"><span title="Storage Design" class="linkLabel_WmDU">Storage Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/block-format"><span title="Block Format Reference" class="linkLabel_WmDU">Block Format Reference</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/indexing-strategy"><span title="Indexing Strategy" class="linkLabel_WmDU">Indexing Strategy</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/compression"><span title="Compression" class="linkLabel_WmDU">Compression</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/query-execution"><span title="Query Execution" class="linkLabel_WmDU">Query Execution</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/data-flow"><span title="Data Flow" class="linkLabel_WmDU">Data Flow</span></a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/spectre/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/spectre/docs/architecture/"><span>Architecture</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Storage Design</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Storage Design</h1></header>
<p>This document provides a comprehensive overview of Spectre&#x27;s storage architecture, explaining the design philosophy, implementation details, and performance characteristics.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="design-philosophy">Design Philosophy<a href="#design-philosophy" class="hash-link" aria-label="Direct link to Design Philosophy" title="Direct link to Design Philosophy" translate="no">​</a></h2>
<p>Spectre&#x27;s storage engine is designed with three primary goals:</p>
<ol>
<li class=""><strong>High Write Throughput:</strong> Handle continuous streams of Kubernetes audit events with minimal latency</li>
<li class=""><strong>Fast Query Access:</strong> Execute filtered queries efficiently without scanning entire dataset</li>
<li class=""><strong>Storage Efficiency:</strong> Compress data effectively while maintaining read performance</li>
</ol>
<p>The design draws inspiration from log-structured storage systems like Loki and VictoriaMetrics, adapted specifically for Kubernetes resource state tracking.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="file-organization">File Organization<a href="#file-organization" class="hash-link" aria-label="Direct link to File Organization" title="Direct link to File Organization" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="hourly-file-strategy">Hourly File Strategy<a href="#hourly-file-strategy" class="hash-link" aria-label="Direct link to Hourly File Strategy" title="Direct link to Hourly File Strategy" translate="no">​</a></h3>
<p>Events are organized into <strong>hourly files</strong> with the naming convention:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">YYYY-MM-DD-HH.bin</span><br></span></code></pre></div></div>
<p><strong>Examples:</strong></p>
<ul>
<li class=""><code>2025-12-12-10.bin</code> - Events from 10:00-10:59</li>
<li class=""><code>2025-12-12-11.bin</code> - Events from 11:00-11:59</li>
<li class=""><code>2025-12-12-12.bin</code> - Events from 12:00-12:59</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-hourly-files">Why Hourly Files?<a href="#why-hourly-files" class="hash-link" aria-label="Direct link to Why Hourly Files?" title="Direct link to Why Hourly Files?" translate="no">​</a></h3>
<table><thead><tr><th>Benefit</th><th>Description</th></tr></thead><tbody><tr><td><strong>Retention Granularity</strong></td><td>Delete old data by hour, not day or all-at-once</td></tr><tr><td><strong>Query Optimization</strong></td><td>Skip entire files that fall outside query time range</td></tr><tr><td><strong>Crash Recovery</strong></td><td>Limit blast radius - only current hour affected if crash occurs</td></tr><tr><td><strong>Parallelization</strong></td><td>Future: Query multiple hourly files concurrently</td></tr><tr><td><strong>Manageability</strong></td><td>Smaller files are easier to backup, move, or analyze</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="directory-structure">Directory Structure<a href="#directory-structure" class="hash-link" aria-label="Direct link to Directory Structure" title="Direct link to Directory Structure" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/data/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 2025-12-11-10.bin                    # Complete file (with footer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 2025-12-11-11.bin                    # Complete file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 2025-12-11-12.bin                    # Incomplete (currently writing)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 2025-12-11-09.bin.incomplete.1733915200  # Backup from crash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── 2025-12-10-15.bin.corrupted.1733828800   # Corrupted file backup</span><br></span></code></pre></div></div>
<p><strong>File States:</strong></p>
<ul>
<li class=""><strong>Complete:</strong> Has valid header and footer, can be reopened for appending</li>
<li class=""><strong>Incomplete:</strong> Missing footer (crash during write), renamed with <code>.incomplete.&lt;timestamp&gt;</code></li>
<li class=""><strong>Corrupted:</strong> Invalid header or structure, renamed with <code>.corrupted.&lt;timestamp&gt;</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="file-lifecycle">File Lifecycle<a href="#file-lifecycle" class="hash-link" aria-label="Direct link to File Lifecycle" title="Direct link to File Lifecycle" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Created    │ Write header (77 bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────┬───────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Writing    │ Buffer events → Finalize blocks → Write compressed data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────┬───────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    Closing   │ Finalize last block → Build indexes → Write index → Write footer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────┬───────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Complete   │ Has footer, can be queried or reopened for appending</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────┬───────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Archived   │ Outside query window, ready for deletion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────┘</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="hour-rotation">Hour Rotation<a href="#hour-rotation" class="hash-link" aria-label="Direct link to Hour Rotation" title="Direct link to Hour Rotation" translate="no">​</a></h3>
<p>When the clock advances to a new hour:</p>
<ol>
<li class=""><strong>Finalize current file:</strong> Flush buffer, build indexes, write footer</li>
<li class=""><strong>Extract state snapshots:</strong> Capture final resource states</li>
<li class=""><strong>Create new file:</strong> Generate filename for new hour</li>
<li class=""><strong>Carry over states:</strong> Transfer state snapshots to new file</li>
<li class=""><strong>Continue writing:</strong> New events go to new file</li>
</ol>
<p><strong>Code Path:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">storage.go:getOrCreateCurrentFile()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Check if currentHour has changed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Close previous file (extracts finalResourceStates)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Create new file for current hour</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → Transfer finalResourceStates to new file</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="block-based-architecture">Block-Based Architecture<a href="#block-based-architecture" class="hash-link" aria-label="Direct link to Block-Based Architecture" title="Direct link to Block-Based Architecture" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="block-lifecycle">Block Lifecycle<a href="#block-lifecycle" class="hash-link" aria-label="Direct link to Block Lifecycle" title="Direct link to Block Lifecycle" translate="no">​</a></h3>
<p>Events are buffered in memory until they reach the configured block size, then compressed and written to disk.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                        Event Flow                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Watcher Event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Storage.WriteEvent()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BlockStorageFile.WriteEvent()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EventBuffer.AddEvent()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  ┌─────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  │ Buffer Events (JSON)                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  │ - Track metadata (kinds, ns, etc)  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  │ - Update Bloom filters             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  │ - Monitor buffer size              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  └─────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Buffer Full?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ├─ No  ─&gt; Continue buffering</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     └─ Yes ─&gt; Finalize Block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               Encode Protobuf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               Compress (gzip)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               Write to Disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               Store Metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               Create New Buffer</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="eventbuffer-design">EventBuffer Design<a href="#eventbuffer-design" class="hash-link" aria-label="Direct link to EventBuffer Design" title="Direct link to EventBuffer Design" translate="no">​</a></h3>
<p>The <code>EventBuffer</code> accumulates events until the block size threshold is reached:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> EventBuffer </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    events       </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// JSON-encoded events</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockSize    </span><span class="token builtin">int64</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">// Target uncompressed size</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    currentSize  </span><span class="token builtin">int64</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">// Current uncompressed size</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Metadata tracking</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timestampMin </span><span class="token builtin">int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timestampMax </span><span class="token builtin">int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kindSet      </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespaceSet </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    groupSet     </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Bloom filters (built incrementally)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bloomKinds      </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">StandardBloomFilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bloomNamespaces </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">StandardBloomFilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bloomGroups     </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">StandardBloomFilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Key Behaviors:</strong></p>
<ul>
<li class=""><strong>Incremental Metadata:</strong> Kinds, namespaces, groups tracked as events arrive</li>
<li class=""><strong>Bloom Filter Building:</strong> Filters updated with each event for space efficiency</li>
<li class=""><strong>Size Monitoring:</strong> Checks if adding next event would exceed block size</li>
<li class=""><strong>First Event Exception:</strong> Never full on first event (prevents zero-event blocks)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="block-structure">Block Structure<a href="#block-structure" class="hash-link" aria-label="Direct link to Block Structure" title="Direct link to Block Structure" translate="no">​</a></h3>
<p>Once finalized, a block contains:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Block </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ID                 </span><span class="token builtin">int32</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Sequential within file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Offset             </span><span class="token builtin">int64</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Byte offset in file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Length             </span><span class="token builtin">int64</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Compressed data length</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UncompressedLength </span><span class="token builtin">int64</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Original size</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EventCount         </span><span class="token builtin">int32</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Number of events</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TimestampMin       </span><span class="token builtin">int64</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Time range for filtering</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TimestampMax       </span><span class="token builtin">int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CompressedData     </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// gzip-compressed protobuf stream</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Metadata           </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">BlockMetadata   </span><span class="token comment" style="color:#999988;font-style:italic">// For indexing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Block Size Trade-offs:</strong></p>
<table><thead><tr><th>Block Size</th><th>Pros</th><th>Cons</th></tr></thead><tbody><tr><td>Small (1 MB)</td><td>Fine-grained filtering, fast decompress</td><td>More blocks, larger index overhead</td></tr><tr><td>Medium (10 MB)</td><td>Balanced compression and granularity</td><td>Moderate decompression latency</td></tr><tr><td>Large (100 MB)</td><td>Fewer blocks, better compression</td><td>Slow decompression, coarse filtering</td></tr></tbody></table>
<p><strong>Default:</strong> 10 MB (configurable via <code>--segment-size</code> flag)</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="write-path">Write Path<a href="#write-path" class="hash-link" aria-label="Direct link to Write Path" title="Direct link to Write Path" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="complete-write-flow">Complete Write Flow<a href="#complete-write-flow" class="hash-link" aria-label="Direct link to Complete Write Flow" title="Direct link to Complete Write Flow" translate="no">​</a></h3>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 1. Application calls WriteEvent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WriteEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 2. Get or create hourly file (rotates at hour boundary)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">getOrCreateCurrentFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 3. Write to block storage file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blockStorageFile</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WriteEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 4. Serialize event to JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eventJSON </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Marshal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 5. Check if buffer is full</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> currentBuffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsFull</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventJSON</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">finalizeBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// Flush current buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    currentBuffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewEventBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 6. Add to buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">currentBuffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventJSON</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 7. Update metadata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> Add kind</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">namespace</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">group to sets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> Add to Bloom filters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> Update timestamp min</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">max</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 8. Write buffered (returns immediately)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="block-finalization">Block Finalization<a href="#block-finalization" class="hash-link" aria-label="Direct link to Block Finalization" title="Direct link to Block Finalization" translate="no">​</a></h3>
<p>When buffer is full (triggered by next event):</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">finalizeBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 1. Create block from buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">block </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> currentBuffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Finalize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gzip&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 2. Encode events as protobuf stream</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protobufData </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">encodeProtobuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 3. Compress with gzip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compressedData </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> gzip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Compress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">protobufData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 4. Get current file offset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">offset </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Seek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SEEK_CUR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 5. Write compressed data to disk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">compressedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 6. Store metadata for index</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blockMetadataList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">block</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Metadata</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 7. Increment block ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blockID</span><span class="token operator" style="color:#393A34">++</span><br></span></code></pre></div></div>
<p><strong>Performance Characteristics:</strong></p>
<ul>
<li class=""><strong>Event buffering:</strong> O(1) per event</li>
<li class=""><strong>Block finalization:</strong> O(N) where N = events in block (protobuf encode + gzip compress)</li>
<li class=""><strong>Typical latency:</strong> &lt;50ms for 10MB block on modern hardware</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="file-closing">File Closing<a href="#file-closing" class="hash-link" aria-label="Direct link to File Closing" title="Direct link to File Closing" translate="no">​</a></h3>
<p>When hour changes or application shuts down:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">blockStorageFile</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 1. Finalize last buffer (if non-empty)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> currentBuffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventCount </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">finalizeBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 2. Build inverted indexes from block metadata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">BuildInvertedIndexes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockMetadataList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 3. Extract final resource states</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">finalResourceStates </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">extractFinalResourceStates</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 4. Create index section</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">indexSection </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> IndexSection</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BlockMetadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> blockMetadataList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    InvertedIndexes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Statistics</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> stats</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FinalResourceStates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> finalResourceStates</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 5. Write index section (JSON)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">indexOffset </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CurrentOffset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">indexLength </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">WriteIndexSection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> indexSection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 6. Write footer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">footer </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> FileFooter</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IndexSectionOffset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> indexOffset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IndexSectionLength</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> indexLength</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MagicBytes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;RPKEND&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">WriteFileFooter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> footer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 7. Close file handle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="state-snapshots">State Snapshots<a href="#state-snapshots" class="hash-link" aria-label="Direct link to State Snapshots" title="Direct link to State Snapshots" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="problem-pre-existing-resources">Problem: Pre-Existing Resources<a href="#problem-pre-existing-resources" class="hash-link" aria-label="Direct link to Problem: Pre-Existing Resources" title="Direct link to Problem: Pre-Existing Resources" translate="no">​</a></h3>
<p>Consider this scenario:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Hour 10:00-10:59:  Deployment &quot;nginx&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hour 11:00-11:59:  No events for &quot;nginx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query [11:30-12:00]: Should &quot;nginx&quot; appear in results?</span><br></span></code></pre></div></div>
<p><strong>Answer:</strong> Yes! The Deployment still exists, even if no events occurred.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="solution-final-resource-states">Solution: Final Resource States<a href="#solution-final-resource-states" class="hash-link" aria-label="Direct link to Solution: Final Resource States" title="Direct link to Solution: Final Resource States" translate="no">​</a></h3>
<p>Each file stores the <strong>final state</strong> of every resource at file close time:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> ResourceLastState </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UID          </span><span class="token builtin">string</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Resource UID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EventType    </span><span class="token builtin">string</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// CREATE, UPDATE, or DELETE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Timestamp    </span><span class="token builtin">int64</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// Last observed timestamp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ResourceData json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RawMessage </span><span class="token comment" style="color:#999988;font-style:italic">// Full resource object (null for DELETE)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Map Key:</strong> <code>group/version/kind/namespace/name</code>
<strong>Example:</strong> <code>apps/v1/Deployment/default/nginx</code></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="state-carryover">State Carryover<a href="#state-carryover" class="hash-link" aria-label="Direct link to State Carryover" title="Direct link to State Carryover" translate="no">​</a></h3>
<p>When creating a new hourly file:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Close previous file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">previousFile</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Extract its final states</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">carryoverStates </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> previousFile</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">finalResourceStates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Create new file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">newFile </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewBlockStorageFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Transfer states to new file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">newFile</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">finalResourceStates </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> carryoverStates</span><br></span></code></pre></div></div>
<p><strong>Why This Works:</strong></p>
<ul>
<li class="">Resources that exist but have no events: Carried forward hour-to-hour</li>
<li class="">Resources that are deleted: State shows <code>EventType = &quot;DELETE&quot;</code></li>
<li class="">Resources with new events: State updated during event processing</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="query-integration">Query Integration<a href="#query-integration" class="hash-link" aria-label="Direct link to Query Integration" title="Direct link to Query Integration" translate="no">​</a></h3>
<p>When querying <code>[startTime, endTime]</code>:</p>
<ol>
<li class=""><strong>Identify files</strong> that overlap the time range</li>
<li class=""><strong>Include one file before</strong> <code>startTime</code> (for state snapshots)</li>
<li class=""><strong>Merge events</strong> from files with state snapshots</li>
<li class=""><strong>Generate synthetic &quot;state-&quot; events</strong> for resources that exist but have no events in range</li>
</ol>
<p><strong>Example:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Query: [11:30, 12:30]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Files: 2025-12-12-10.bin (for states)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       2025-12-12-11.bin (events + states)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       2025-12-12-12.bin (events + states)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="file-restoration">File Restoration<a href="#file-restoration" class="hash-link" aria-label="Direct link to File Restoration" title="Direct link to File Restoration" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="reopening-complete-files">Reopening Complete Files<a href="#reopening-complete-files" class="hash-link" aria-label="Direct link to Reopening Complete Files" title="Direct link to Reopening Complete Files" translate="no">​</a></h3>
<p>When starting the application, existing complete files can be reopened for appending:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 1. Check if file exists</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fileExists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 2. Read footer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    footer </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ReadFileFooter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 3. Verify magic bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> footer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MagicBytes </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;RPKEND&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Incomplete file - rename and create new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Rename</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.incomplete.&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createNewFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 4. Read index section</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    index </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ReadIndexSection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> footer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IndexOffset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> footer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IndexLength</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 5. Restore state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockMetadata </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BlockMetadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finalResourceStates </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FinalResourceStates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nextBlockID </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockMetadata</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 6. Truncate at blocks end (remove old index + footer)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Truncate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">footer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IndexSectionOffset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 7. Seek to end for appending</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Seek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">footer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IndexSectionOffset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SEEK_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 8. Continue writing new blocks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> blockStorageFile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Use Cases:</strong></p>
<ul>
<li class=""><strong>Application restart:</strong> Resume writing to current hour&#x27;s file</li>
<li class=""><strong>Hot reload:</strong> Reload configuration without losing buffered data</li>
<li class=""><strong>Testing:</strong> Inject historical events into existing files</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="crash-recovery">Crash Recovery<a href="#crash-recovery" class="hash-link" aria-label="Direct link to Crash Recovery" title="Direct link to Crash Recovery" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="incomplete-files">Incomplete Files<a href="#incomplete-files" class="hash-link" aria-label="Direct link to Incomplete Files" title="Direct link to Incomplete Files" translate="no">​</a></h4>
<p>If the application crashes before closing a file:</p>
<p><strong>Detection:</strong></p>
<ul>
<li class="">Footer is missing (can&#x27;t read 324 bytes from end)</li>
<li class="">Footer magic bytes != &quot;RPKEND&quot;</li>
</ul>
<p><strong>Recovery:</strong></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">timestamp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backupPath </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s.incomplete.%d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Rename</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> backupPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Create new empty file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">createNewFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Result:</strong></p>
<ul>
<li class="">Original incomplete file preserved for debugging/recovery</li>
<li class="">New empty file created for writing</li>
<li class="">No data loss for previously closed files</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="corrupted-files">Corrupted Files<a href="#corrupted-files" class="hash-link" aria-label="Direct link to Corrupted Files" title="Direct link to Corrupted Files" translate="no">​</a></h4>
<p>If the header or structure is invalid:</p>
<p><strong>Detection:</strong></p>
<ul>
<li class="">Can&#x27;t read 77-byte header</li>
<li class="">Header magic bytes != &quot;RPKBLOCK&quot;</li>
<li class="">Version is unsupported</li>
</ul>
<p><strong>Recovery:</strong></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">timestamp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backupPath </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s.corrupted.%d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Rename</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> backupPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Create new empty file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">createNewFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="performance-characteristics">Performance Characteristics<a href="#performance-characteristics" class="hash-link" aria-label="Direct link to Performance Characteristics" title="Direct link to Performance Characteristics" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="write-performance">Write Performance<a href="#write-performance" class="hash-link" aria-label="Direct link to Write Performance" title="Direct link to Write Performance" translate="no">​</a></h3>
<table><thead><tr><th>Operation</th><th>Complexity</th><th>Typical Latency</th></tr></thead><tbody><tr><td>Event buffering</td><td>O(1)</td><td>&lt;1 µs</td></tr><tr><td>JSON marshal</td><td>O(N)</td><td>~10 µs</td></tr><tr><td>Bloom filter update</td><td>O(k)</td><td>~1 µs</td></tr><tr><td>Block finalization</td><td>O(N)</td><td>~50 ms (10 MB)</td></tr><tr><td>Protobuf encode</td><td>O(N)</td><td>~20 ms</td></tr><tr><td>gzip compress</td><td>O(N)</td><td>~100 ms</td></tr><tr><td>Disk write</td><td>O(1)</td><td>~10 ms</td></tr><tr><td>Index build (close)</td><td>O(N × M)</td><td>~500 ms</td></tr></tbody></table>
<p><strong>Throughput:</strong> 10,000+ events/second (typical Kubernetes cluster)</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="space-efficiency">Space Efficiency<a href="#space-efficiency" class="hash-link" aria-label="Direct link to Space Efficiency" title="Direct link to Space Efficiency" translate="no">​</a></h3>
<p>For a typical hourly file with 60,000 events:</p>
<table><thead><tr><th>Component</th><th>Size</th><th>Percentage</th></tr></thead><tbody><tr><td>Compressed Events</td><td>18 MB</td><td>~94%</td></tr><tr><td>Block Metadata</td><td>800 KB</td><td>~4%</td></tr><tr><td>Inverted Indexes</td><td>200 KB</td><td>~1%</td></tr><tr><td>Bloom Filters</td><td>150 KB</td><td>~0.8%</td></tr><tr><td>State Snapshots</td><td>100 KB</td><td>~0.5%</td></tr><tr><td>Header + Footer</td><td>401 bytes</td><td>&lt;0.001%</td></tr><tr><td><strong>Total</strong></td><td><strong>~19 MB</strong></td><td><strong>100%</strong></td></tr></tbody></table>
<p><strong>Compression Ratio:</strong> 0.25 (75% reduction from uncompressed)</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="read-performance">Read Performance<a href="#read-performance" class="hash-link" aria-label="Direct link to Read Performance" title="Direct link to Read Performance" translate="no">​</a></h3>
<table><thead><tr><th>Operation</th><th>Complexity</th><th>Typical Latency</th></tr></thead><tbody><tr><td>Header read</td><td>O(1)</td><td>&lt;1 ms</td></tr><tr><td>Footer read</td><td>O(1)</td><td>&lt;1 ms</td></tr><tr><td>Index read</td><td>O(N)</td><td>~10 ms (2 MB)</td></tr><tr><td>Index parse (JSON)</td><td>O(N)</td><td>~20 ms</td></tr><tr><td>Block read</td><td>O(1) seek</td><td>~5 ms</td></tr><tr><td>Block decompress</td><td>O(M)</td><td>~30 ms (10 MB)</td></tr><tr><td>Protobuf decode</td><td>O(M)</td><td>~20 ms</td></tr></tbody></table>
<p><strong>Query Performance:</strong> See <a class="" href="/spectre/docs/architecture/query-execution">Query Execution</a> for details</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="design-decisions-qa">Design Decisions (Q&amp;A)<a href="#design-decisions-qa" class="hash-link" aria-label="Direct link to Design Decisions (Q&amp;A)" title="Direct link to Design Decisions (Q&amp;A)" translate="no">  ​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="q-why-10mb-default-block-size">Q: Why 10MB default block size?<a href="#q-why-10mb-default-block-size" class="hash-link" aria-label="Direct link to Q: Why 10MB default block size?" title="Direct link to Q: Why 10MB default block size?" translate="no">​</a></h3>
<p><strong>A:</strong> Balances three competing factors:</p>
<ol>
<li class="">
<p><strong>Compression Ratio:</strong> Larger blocks compress better (more context for gzip)</p>
<ul>
<li class="">1 MB: ~65% reduction</li>
<li class="">10 MB: ~75% reduction</li>
<li class="">100 MB: ~78% reduction</li>
</ul>
</li>
<li class="">
<p><strong>Query Granularity:</strong> Smaller blocks enable finer filtering</p>
<ul>
<li class="">1 MB block = ~80 events → better filtering precision</li>
<li class="">10 MB block = ~800 events → balanced</li>
<li class="">100 MB block = ~8000 events → coarse filtering</li>
</ul>
</li>
<li class="">
<p><strong>Decompression Latency:</strong> Smaller blocks decompress faster</p>
<ul>
<li class="">1 MB: ~3 ms</li>
<li class="">10 MB: ~30 ms</li>
<li class="">100 MB: ~300 ms</li>
</ul>
</li>
</ol>
<p><strong>10 MB provides good compression (75%) with acceptable latency (&lt;50ms).</strong></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="q-why-gzip-over-zstd">Q: Why gzip over zstd?<a href="#q-why-gzip-over-zstd" class="hash-link" aria-label="Direct link to Q: Why gzip over zstd?" title="Direct link to Q: Why gzip over zstd?" translate="no">​</a></h3>
<p><strong>A:</strong> Implementation maturity and compatibility:</p>
<ul>
<li class="">
<p><strong>gzip:</strong></p>
<ul>
<li class="">Excellent Go library support (<code>klauspost/compress/gzip</code>)</li>
<li class="">Universal compatibility</li>
<li class="">Good compression ratio (75%)</li>
<li class="">Battle-tested in production</li>
</ul>
</li>
<li class="">
<p><strong>zstd</strong> (planned for v2.0):</p>
<ul>
<li class="">Slightly better compression (78%)</li>
<li class="">Faster compression (~2x)</li>
<li class="">Faster decompression (~1.5x)</li>
<li class="">Requires migration strategy for existing files</li>
</ul>
</li>
</ul>
<p><strong>Current choice: gzip for stability. Future: zstd as opt-in with migration path.</strong></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="q-why-hourly-files-instead-of-daily">Q: Why hourly files instead of daily?<a href="#q-why-hourly-files-instead-of-daily" class="hash-link" aria-label="Direct link to Q: Why hourly files instead of daily?" title="Direct link to Q: Why hourly files instead of daily?" translate="no">​</a></h3>
<p><strong>A:</strong> Operational flexibility:</p>
<table><thead><tr><th>Hourly</th><th>Daily</th></tr></thead><tbody><tr><td>Delete specific hours</td><td>Delete entire days only</td></tr><tr><td>Smaller files (~20 MB)</td><td>Larger files (~500 MB)</td></tr><tr><td>Hour-level query optimization</td><td>Day-level only</td></tr><tr><td>Fast rotation (low risk)</td><td>Rotation once/day (higher risk)</td></tr><tr><td>Easier backup/restore</td><td>Harder to manage</td></tr></tbody></table>
<p><strong>Hourly provides finer control without excessive file count.</strong></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="q-why-json-index-instead-of-binary">Q: Why JSON index instead of binary?<a href="#q-why-json-index-instead-of-binary" class="hash-link" aria-label="Direct link to Q: Why JSON index instead of binary?" title="Direct link to Q: Why JSON index instead of binary?" translate="no">​</a></h3>
<p><strong>A:</strong> Developer experience and flexibility:</p>
<ul>
<li class="">
<p><strong>Pros:</strong></p>
<ul>
<li class="">Human-readable (debugging, inspection)</li>
<li class="">Easy schema evolution (add fields without breaking)</li>
<li class="">Standard tooling (jq, JSON parsers)</li>
<li class="">Compact enough for typical indexes (&lt;2 MB)</li>
</ul>
</li>
<li class="">
<p><strong>Cons:</strong></p>
<ul>
<li class="">Slightly larger than binary (10-20%)</li>
<li class="">Slightly slower to parse (~20ms vs ~5ms)</li>
</ul>
</li>
</ul>
<p><strong>Trade-off: Flexibility and debuggability over ~15ms latency.</strong></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="q-why-not-use-a-database-sqlite-rocksdb">Q: Why not use a database (SQLite, RocksDB)?<a href="#q-why-not-use-a-database-sqlite-rocksdb" class="hash-link" aria-label="Direct link to Q: Why not use a database (SQLite, RocksDB)?" title="Direct link to Q: Why not use a database (SQLite, RocksDB)?" translate="no">​</a></h3>
<p><strong>A:</strong> Specialized requirements and simplicity:</p>
<ul>
<li class=""><strong>Append-only workload:</strong> Blocks never modified after write</li>
<li class=""><strong>Compression at block level:</strong> Databases compress at page level (less efficient)</li>
<li class=""><strong>Custom indexing:</strong> Inverted indexes + Bloom filters tailored for our queries</li>
<li class=""><strong>No dependencies:</strong> Single binary deployment</li>
<li class=""><strong>Portability:</strong> Files can be copied, archived, analyzed offline</li>
</ul>
<p><strong>Custom storage provides better compression and simpler deployment.</strong></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="future-enhancements">Future Enhancements<a href="#future-enhancements" class="hash-link" aria-label="Direct link to Future Enhancements" title="Direct link to Future Enhancements" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="version-11-planned">Version 1.1 (Planned)<a href="#version-11-planned" class="hash-link" aria-label="Direct link to Version 1.1 (Planned)" title="Direct link to Version 1.1 (Planned)" translate="no">​</a></h3>
<ul>
<li class=""><strong>Automatic Retention Policies:</strong> Delete files older than N days via configuration</li>
<li class=""><strong>Background Compaction:</strong> Merge small blocks from low-traffic hours</li>
<li class=""><strong>Enhanced Metadata:</strong> Track more dimensions (verbs, users, source IPs)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="version-20-planned">Version 2.0 (Planned)<a href="#version-20-planned" class="hash-link" aria-label="Direct link to Version 2.0 (Planned)" title="Direct link to Version 2.0 (Planned)" translate="no">​</a></h3>
<ul>
<li class=""><strong>zstd Compression:</strong> Opt-in faster compression with migration tool</li>
<li class=""><strong>Concurrent File Writing:</strong> Parallel writes to multiple hourly files</li>
<li class=""><strong>Block-Level Encryption:</strong> Encrypt sensitive events at rest</li>
<li class=""><strong>Multi-Tier Storage:</strong> Hot (SSD), warm (HDD), cold (object storage)</li>
<li class=""><strong>Distributed Queries:</strong> Query across multiple Spectre instances</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="beyond-20">Beyond 2.0<a href="#beyond-20" class="hash-link" aria-label="Direct link to Beyond 2.0" title="Direct link to Beyond 2.0" translate="no">​</a></h3>
<ul>
<li class=""><strong>Column-Oriented Blocks:</strong> Store fields separately for better compression</li>
<li class=""><strong>Dictionary Learning:</strong> Pre-build compression dictionaries for common patterns</li>
<li class=""><strong>Adaptive Block Sizing:</strong> Tune block size based on event rate</li>
<li class=""><strong>Incremental Indexes:</strong> Update indexes without rebuilding entire file</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="related-documentation">Related Documentation<a href="#related-documentation" class="hash-link" aria-label="Direct link to Related Documentation" title="Direct link to Related Documentation" translate="no">​</a></h2>
<ul>
<li class=""><a class="" href="/spectre/docs/architecture/block-format">Block Format Reference</a> - Binary file format specification</li>
<li class=""><a class="" href="/spectre/docs/architecture/indexing-strategy">Indexing Strategy</a> - Query optimization techniques</li>
<li class=""><a class="" href="/spectre/docs/architecture/compression">Compression</a> - Compression algorithms and performance</li>
<li class=""><a class="" href="/spectre/docs/architecture/query-execution">Query Execution</a> - Query pipeline and optimization</li>
<li class=""><a class="" href="/spectre/docs/configuration/storage-settings">Storage Settings</a> - Configuration guide</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/moolen/spectre/tree/master/docs/docs/architecture/storage-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-12-13T08:58:49.000Z" itemprop="dateModified">Dec 13, 2025</time></b> by <b>Moritz Johner</b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/spectre/docs/architecture/overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Architecture Overview</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/spectre/docs/architecture/block-format"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Block Format Reference</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#design-philosophy" class="table-of-contents__link toc-highlight">Design Philosophy</a></li><li><a href="#file-organization" class="table-of-contents__link toc-highlight">File Organization</a><ul><li><a href="#hourly-file-strategy" class="table-of-contents__link toc-highlight">Hourly File Strategy</a></li><li><a href="#why-hourly-files" class="table-of-contents__link toc-highlight">Why Hourly Files?</a></li><li><a href="#directory-structure" class="table-of-contents__link toc-highlight">Directory Structure</a></li><li><a href="#file-lifecycle" class="table-of-contents__link toc-highlight">File Lifecycle</a></li><li><a href="#hour-rotation" class="table-of-contents__link toc-highlight">Hour Rotation</a></li></ul></li><li><a href="#block-based-architecture" class="table-of-contents__link toc-highlight">Block-Based Architecture</a><ul><li><a href="#block-lifecycle" class="table-of-contents__link toc-highlight">Block Lifecycle</a></li><li><a href="#eventbuffer-design" class="table-of-contents__link toc-highlight">EventBuffer Design</a></li><li><a href="#block-structure" class="table-of-contents__link toc-highlight">Block Structure</a></li></ul></li><li><a href="#write-path" class="table-of-contents__link toc-highlight">Write Path</a><ul><li><a href="#complete-write-flow" class="table-of-contents__link toc-highlight">Complete Write Flow</a></li><li><a href="#block-finalization" class="table-of-contents__link toc-highlight">Block Finalization</a></li><li><a href="#file-closing" class="table-of-contents__link toc-highlight">File Closing</a></li></ul></li><li><a href="#state-snapshots" class="table-of-contents__link toc-highlight">State Snapshots</a><ul><li><a href="#problem-pre-existing-resources" class="table-of-contents__link toc-highlight">Problem: Pre-Existing Resources</a></li><li><a href="#solution-final-resource-states" class="table-of-contents__link toc-highlight">Solution: Final Resource States</a></li><li><a href="#state-carryover" class="table-of-contents__link toc-highlight">State Carryover</a></li><li><a href="#query-integration" class="table-of-contents__link toc-highlight">Query Integration</a></li></ul></li><li><a href="#file-restoration" class="table-of-contents__link toc-highlight">File Restoration</a><ul><li><a href="#reopening-complete-files" class="table-of-contents__link toc-highlight">Reopening Complete Files</a></li><li><a href="#crash-recovery" class="table-of-contents__link toc-highlight">Crash Recovery</a></li></ul></li><li><a href="#performance-characteristics" class="table-of-contents__link toc-highlight">Performance Characteristics</a><ul><li><a href="#write-performance" class="table-of-contents__link toc-highlight">Write Performance</a></li><li><a href="#space-efficiency" class="table-of-contents__link toc-highlight">Space Efficiency</a></li><li><a href="#read-performance" class="table-of-contents__link toc-highlight">Read Performance</a></li></ul></li><li><a href="#design-decisions-qa" class="table-of-contents__link toc-highlight">Design Decisions (Q&amp;A)</a><ul><li><a href="#q-why-10mb-default-block-size" class="table-of-contents__link toc-highlight">Q: Why 10MB default block size?</a></li><li><a href="#q-why-gzip-over-zstd" class="table-of-contents__link toc-highlight">Q: Why gzip over zstd?</a></li><li><a href="#q-why-hourly-files-instead-of-daily" class="table-of-contents__link toc-highlight">Q: Why hourly files instead of daily?</a></li><li><a href="#q-why-json-index-instead-of-binary" class="table-of-contents__link toc-highlight">Q: Why JSON index instead of binary?</a></li><li><a href="#q-why-not-use-a-database-sqlite-rocksdb" class="table-of-contents__link toc-highlight">Q: Why not use a database (SQLite, RocksDB)?</a></li></ul></li><li><a href="#future-enhancements" class="table-of-contents__link toc-highlight">Future Enhancements</a><ul><li><a href="#version-11-planned" class="table-of-contents__link toc-highlight">Version 1.1 (Planned)</a></li><li><a href="#version-20-planned" class="table-of-contents__link toc-highlight">Version 2.0 (Planned)</a></li><li><a href="#beyond-20" class="table-of-contents__link toc-highlight">Beyond 2.0</a></li></ul></li><li><a href="#related-documentation" class="table-of-contents__link toc-highlight">Related Documentation</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/intro">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/installation">Installation</a></li><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/mcp-integration">MCP Integration</a></li><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/architecture">Architecture</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/api">API Reference</a></li><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/operations/troubleshooting">Troubleshooting</a></li><li class="footer__item"><a href="https://github.com/moolen/spectre/tree/master/chart" target="_blank" rel="noopener noreferrer" class="footer__link-item">Helm Chart<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/moolen/spectre" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/moolen/spectre/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issues<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/moolen/spectre/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussions<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Spectre Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>