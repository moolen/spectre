<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-architecture/data-flow" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Data Flow | Spectre</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://moolen.github.io/spectre/img/spectre-social-card.png"><meta data-rh="true" name="twitter:image" content="https://moolen.github.io/spectre/img/spectre-social-card.png"><meta data-rh="true" property="og:url" content="https://moolen.github.io/spectre/docs/architecture/data-flow"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Data Flow | Spectre"><meta data-rh="true" name="description" content="End-to-end data flow through Spectre&#x27;s write and read paths"><meta data-rh="true" property="og:description" content="End-to-end data flow through Spectre&#x27;s write and read paths"><meta data-rh="true" name="keywords" content="architecture,data flow,write path,read path,pipeline"><link data-rh="true" rel="icon" href="/spectre/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://moolen.github.io/spectre/docs/architecture/data-flow"><link data-rh="true" rel="alternate" href="https://moolen.github.io/spectre/docs/architecture/data-flow" hreflang="en"><link data-rh="true" rel="alternate" href="https://moolen.github.io/spectre/docs/architecture/data-flow" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Architecture","item":"https://moolen.github.io/spectre/docs/architecture/"},{"@type":"ListItem","position":2,"name":"Data Flow","item":"https://moolen.github.io/spectre/docs/architecture/data-flow"}]}</script><link rel="stylesheet" href="/spectre/assets/css/styles.d42b8c2d.css">
<script src="/spectre/assets/js/runtime~main.2344fe77.js" defer="defer"></script>
<script src="/spectre/assets/js/main.7008b389.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/spectre/"><div class="navbar__logo"><img src="/spectre/img/ghost.svg" alt="Spectre Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/spectre/img/ghost.svg" alt="Spectre Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Spectre</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/spectre/docs/intro">Documentation</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/moolen/spectre" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/spectre/docs/intro"><span title="Introduction to Spectre" class="linkLabel_WmDU">Introduction to Spectre</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/getting-started/"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a><button aria-label="Collapse sidebar category &#x27;Getting Started&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/getting-started/quick-start"><span title="Quick Start" class="linkLabel_WmDU">Quick Start</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/getting-started/demo-mode"><span title="Demo Mode" class="linkLabel_WmDU">Demo Mode</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/installation/"><span title="Installation" class="categoryLinkLabel_W154">Installation</span></a><button aria-label="Expand sidebar category &#x27;Installation&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/configuration/"><span title="Configuration" class="categoryLinkLabel_W154">Configuration</span></a><button aria-label="Expand sidebar category &#x27;Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/user-guide/"><span title="User Guide" class="categoryLinkLabel_W154">User Guide</span></a><button aria-label="Expand sidebar category &#x27;User Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/use-cases/"><span title="Use Cases" class="categoryLinkLabel_W154">Use Cases</span></a><button aria-label="Expand sidebar category &#x27;Use Cases&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/spectre/docs/mcp-integration/"><span title="MCP Integration" class="categoryLinkLabel_W154">MCP Integration</span></a><button aria-label="Expand sidebar category &#x27;MCP Integration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/spectre/docs/architecture/"><span title="Architecture" class="categoryLinkLabel_W154">Architecture</span></a><button aria-label="Collapse sidebar category &#x27;Architecture&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/overview"><span title="Architecture Overview" class="linkLabel_WmDU">Architecture Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/storage-design"><span title="Storage Design" class="linkLabel_WmDU">Storage Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/block-format"><span title="Block Format Reference" class="linkLabel_WmDU">Block Format Reference</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/indexing-strategy"><span title="Indexing Strategy" class="linkLabel_WmDU">Indexing Strategy</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/compression"><span title="Compression" class="linkLabel_WmDU">Compression</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spectre/docs/architecture/query-execution"><span title="Query Execution" class="linkLabel_WmDU">Query Execution</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/spectre/docs/architecture/data-flow"><span title="Data Flow" class="linkLabel_WmDU">Data Flow</span></a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/spectre/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/spectre/docs/architecture/"><span>Architecture</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Data Flow</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Data Flow</h1></header>
<p>This document traces the complete journey of data through Spectre - from Kubernetes events arriving at the watcher to query results returned to the user.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="system-overview">System Overview<a href="#system-overview" class="hash-link" aria-label="Direct link to System Overview" title="Direct link to System Overview" translate="no">​</a></h2>
<p>Spectre processes data through two independent paths:</p>
<ol>
<li class=""><strong>Write Path</strong>: Kubernetes events → Watcher → Storage</li>
<li class=""><strong>Read Path</strong>: API request → Query engine → Response</li>
</ol>
<p>These paths are designed to minimize interference - writes happen continuously in the background while queries execute concurrently without blocking writes.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="write-path-events-to-storage">Write Path: Events to Storage<a href="#write-path-events-to-storage" class="hash-link" aria-label="Direct link to Write Path: Events to Storage" title="Direct link to Write Path: Events to Storage" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="complete-write-flow">Complete Write Flow<a href="#complete-write-flow" class="hash-link" aria-label="Direct link to Complete Write Flow" title="Direct link to Complete Write Flow" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                         Write Path                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kubernetes API Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ (Resource ADD/UPDATE/DELETE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────── ────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 1. Watcher Component (internal/watcher/)                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ResourceEventHandler.OnAdd/OnUpdate/OnDelete                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Receives: Kubernetes runtime.Object                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Converts: Object → ResourceEvent struct                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        - ExtractMetadata(name, namespace, kind, apiVersion)        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        - Capture timestamp, operation type, UID                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        - Marshal full object to JSON                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ ResourceEvent (with managedFields ~10KB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 2. Pruning (internal/watcher/pruner.go)                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Remove metadata.managedFields                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Typical size reduction: 80-90%                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Example: 10KB → 1-2KB                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ Pruned ResourceEvent (~1-2KB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────── ──────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 3. Validation (internal/watcher/validator.go)                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Check required fields exist:                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   - UID, timestamp, kind, namespace, name                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Invalid events: Logged and discarded                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ Valid ResourceEvent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 4. Event Queue (internal/watcher/event_queue.go)                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Concurrent buffering: Channel-based queue                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Buffer size: 10000 events (configurable)                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Backpressure: Blocks watcher if queue full                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Batch drain: Worker goroutine processes events               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ Batched events (up to 100 at a time)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 5. Storage Layer (internal/storage/)                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ storage.WriteEvent(event)                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Get or Create Hourly File                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Check current hour: time.Now().Truncate(time.Hour)         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - If hour changed: Close previous file, create new           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Carryover finalResourceStates to new file                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; blockStorageFile.WriteEvent(event)                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├─&gt; Marshal event to JSON                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   └─&gt; json.Marshal(event) → []byte                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├─&gt; Check buffer capacity                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   └─&gt; if currentBuffer.IsFull(len(eventJSON)):             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │       - Finalize current block (compress + write)          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │       - Create new EventBuffer                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├─&gt; Add to EventBuffer                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Append event JSON to buffer                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Update metadata sets (kinds, namespaces, groups)       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Update Bloom filters                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Track timestamp min/max                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └─&gt; Update Final Resource States                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       - Map key: group/version/kind/namespace/name             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       - Store: UID, EventType, Timestamp, ResourceData         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Return (non-blocking)                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ Event buffered in memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 6. Block Finalization (when buffer full)                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ currentBuffer.Finalize(blockID, &quot;gzip&quot;)                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Encode events as Protobuf stream                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Length-prefixed messages                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Each event: [length(4B)][protobuf_data]                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Compress with gzip                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Algorithm: klauspost/compress/gzip                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Level: DefaultCompression (6)                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Typical ratio: 75% reduction                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Create Block structure                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - ID: sequential block number                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Offset: current file position                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Length: compressed data size                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - UncompressedLength: original size                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - EventCount: number of events                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - TimestampMin/Max: time range                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Metadata: kinds, namespaces, groups, Bloom filters         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Write compressed data to disk                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Append to hourly file                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - fsync() for durability (optional)                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Store block metadata for index                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       - Append to blockMetadataList (in-memory)                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ Block written to disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 7. File Closing (hour boundary or shutdown)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ blockStorageFile.Close()                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Finalize last buffer (if non-empty)                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Build Inverted Indexes                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - KindToBlocks: &quot;Pod&quot; → [0, 2, 5, ...]                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - NamespaceToBlocks: &quot;default&quot; → [0, 1, 3, ...]              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - GroupToBlocks: &quot;apps&quot; → [1, 2, 4, ...]                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Create IndexSection                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - BlockMetadata: Array of block metadata                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - InvertedIndexes: Kind/namespace/group maps                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Statistics: Event counts, compression ratios               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - FinalResourceStates: Last state of each resource           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Write index section (JSON)                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Record indexOffset = currentFilePosition                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Write JSON-encoded IndexSection                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Record indexLength = bytes written                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Write File Footer (324 bytes)                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - IndexSectionOffset: int64 (8 bytes)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - IndexSectionLength: int32 (4 bytes)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Checksum: MD5 hash (256 bytes)                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Reserved: padding (16 bytes)                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - MagicBytes: &quot;RPKEND&quot; (8 bytes)                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Close file handle                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ File sealed (immutable)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Ready for queries</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="write-path-timing">Write Path Timing<a href="#write-path-timing" class="hash-link" aria-label="Direct link to Write Path Timing" title="Direct link to Write Path Timing" translate="no">​</a></h3>
<p>For a typical event processing cycle:</p>
<table><thead><tr><th>Stage</th><th>Time</th><th>Notes</th></tr></thead><tbody><tr><td>Kubernetes API → Watcher</td><td>&lt;1 ms</td><td>Watch stream notification</td></tr><tr><td>Event conversion</td><td>~10 µs</td><td>Object → ResourceEvent struct</td></tr><tr><td>Pruning</td><td>~5 µs</td><td>Remove managedFields</td></tr><tr><td>Validation</td><td>~1 µs</td><td>Check required fields</td></tr><tr><td>Queue buffering</td><td>&lt;1 µs</td><td>Channel send</td></tr><tr><td>Queue drain</td><td>~100 µs</td><td>Batch processing</td></tr><tr><td>JSON marshal</td><td>~10 µs</td><td>Event → JSON bytes</td></tr><tr><td>Buffer accumulation</td><td>~1 µs</td><td>Append + metadata update</td></tr><tr><td><strong>Total (per event)</strong></td><td><strong>~130 µs</strong></td><td><strong>Sustained: 7,500 events/sec</strong></td></tr></tbody></table>
<p><strong>Block finalization (periodic)</strong>:</p>
<table><thead><tr><th>Stage</th><th>Time</th><th>Notes</th></tr></thead><tbody><tr><td>Protobuf encode</td><td>~20 ms</td><td>10 MB uncompressed</td></tr><tr><td>gzip compression</td><td>~100 ms</td><td>10 MB → 2.5 MB</td></tr><tr><td>Disk write</td><td>~10 ms</td><td>Append to file</td></tr><tr><td>Metadata tracking</td><td>~1 ms</td><td>Update indexes</td></tr><tr><td><strong>Total</strong></td><td><strong>~130 ms</strong></td><td><strong>Every ~800 events</strong></td></tr></tbody></table>
<p><strong>File closing (hourly)</strong>:</p>
<table><thead><tr><th>Stage</th><th>Time</th><th>Notes</th></tr></thead><tbody><tr><td>Finalize last block</td><td>~130 ms</td><td>Same as block finalization</td></tr><tr><td>Build inverted indexes</td><td>~50 ms</td><td>Process ~300 blocks</td></tr><tr><td>Encode index JSON</td><td>~20 ms</td><td>Serialize index</td></tr><tr><td>Write index</td><td>~10 ms</td><td>Write to disk</td></tr><tr><td>Write footer</td><td>&lt;1 ms</td><td>324 bytes</td></tr><tr><td><strong>Total</strong></td><td><strong>~210 ms</strong></td><td><strong>Once per hour</strong></td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="concurrency-model-write-path">Concurrency Model (Write Path)<a href="#concurrency-model-write-path" class="hash-link" aria-label="Direct link to Concurrency Model (Write Path)" title="Direct link to Concurrency Model (Write Path)" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                         Goroutines                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Watcher Goroutines (one per resource type):                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ Pod Watcher  │  │ Deploy Watch │  │ Service Watch│          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         └─────────────────┼─────────────────┘                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                           │ Events                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                           v                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   ┌───────────────┐                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   │  Event Queue  │ (buffered channel)          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   │  cap=10000    │                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   └───────┬───────┘                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                           │                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                           v                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   ┌───────────────┐                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   │ Queue Worker  │ (single goroutine)          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   │ Drains queue  │                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   └───────┬───────┘                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                           │                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                           v                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   ┌───────────────┐                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   │ Storage Writer│ (synchronized)              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   │ Single writer │                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   └───────────────┘                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────────┘</span><br></span></code></pre></div></div>
<p><strong>Key Points</strong>:</p>
<ul>
<li class=""><strong>Multiple watchers</strong>: One goroutine per resource type (parallelism)</li>
<li class=""><strong>Single queue</strong>: All watchers feed into one event queue (serialization)</li>
<li class=""><strong>Single writer</strong>: Only one goroutine writes to storage (no locking)</li>
<li class=""><strong>Buffered channel</strong>: Decouples watchers from storage (backpressure tolerance)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="error-handling-write-path">Error Handling (Write Path)<a href="#error-handling-write-path" class="hash-link" aria-label="Direct link to Error Handling (Write Path)" title="Direct link to Error Handling (Write Path)" translate="no">​</a></h3>
<table><thead><tr><th>Error Type</th><th>Handling</th><th>Impact</th></tr></thead><tbody><tr><td><strong>Invalid event</strong></td><td>Log warning, discard event</td><td>Single event lost</td></tr><tr><td><strong>Queue full</strong></td><td>Block watcher until space available</td><td>Watcher backpressure</td></tr><tr><td><strong>Disk full</strong></td><td>Log error, return error to caller</td><td>Stops all writes</td></tr><tr><td><strong>Compression error</strong></td><td>Log error, skip block finalization</td><td>Block data lost</td></tr><tr><td><strong>File write error</strong></td><td>Retry 3 times with exponential backoff</td><td>Potential data loss if persistent</td></tr><tr><td><strong>Index build error</strong></td><td>Log error, file marked incomplete</td><td>File can&#x27;t be queried</td></tr><tr><td><strong>Hour rotation error</strong></td><td>Log error, continue with same file</td><td>No new file created</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="read-path-query-to-results">Read Path: Query to Results<a href="#read-path-query-to-results" class="hash-link" aria-label="Direct link to Read Path: Query to Results" title="Direct link to Read Path: Query to Results" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="complete-read-flow">Complete Read Flow<a href="#complete-read-flow" class="hash-link" aria-label="Direct link to Complete Read Flow" title="Direct link to Complete Read Flow" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                          Read Path                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP Client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ GET /api/search?start=X&amp;end=Y&amp;kind=Pod&amp;namespace=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 1. API Server (internal/api/)                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ search_handler.go:ServeHTTP()                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Parse query parameters                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - start (required): Unix timestamp (seconds or ms)           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - end (required): Unix timestamp                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - kind (optional): e.g., &quot;Pod&quot;, &quot;Deployment&quot;                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - namespace (optional): e.g., &quot;default&quot;, &quot;kube-system&quot;       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - group (optional): e.g., &quot;apps&quot;, &quot;&quot;                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - version (optional): e.g., &quot;v1&quot;                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Validate parameters                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - start &lt; end (time range valid)                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Range not too large (max 30 days)                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Timestamps in valid format                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Create Filter struct                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       - TimeRange: [start, end]                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       - ResourceFilters: {kind, namespace, group, version}         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ Filter{start, end, kind, namespace, group}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 2. Query Engine (internal/storage/query.go)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ storage.Query(filter)                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Select Files by Time Window                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Hourly files: YYYY-MM-DD-HH.bin                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Example: [10:00-14:00] → [10.bin, 11.bin, 12.bin, 13.bin] │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Include one file before start (for state snapshots)        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; For each file (sequential):                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       query_file.go:queryFile(path, filter)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────── ──────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ File paths: [file1.bin, file2.bin, ...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 3. Per-File Query (internal/storage/query_file.go)                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ For each file:                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Read File Header (77 bytes)                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Validate magic bytes: &quot;RPKBLOCK&quot;                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Check format version                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Read compression algorithm                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Read File Footer (324 bytes from end)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Validate magic bytes: &quot;RPKEND&quot;                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Extract indexSectionOffset                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Extract indexSectionLength                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Read Index Section                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Seek to indexSectionOffset                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Read indexSectionLength bytes                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Parse JSON → IndexSection struct                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Load: BlockMetadata, InvertedIndexes, FinalResourceStates  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Filter Blocks (by inverted indexes)                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - If filter.kind specified:                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │     candidates = InvertedIndexes.KindToBlocks[filter.kind]     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - If filter.namespace specified:                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │     candidates ∩= InvertedIndexes.NamespaceToBlocks[ns]        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - If filter.group specified:                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │     candidates ∩= InvertedIndexes.GroupToBlocks[group]         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Result: Subset of block IDs to decompress                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Binary Search Timestamp Index                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - BlockMetadata sorted by timestampMin                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Find first block: block.timestampMax &gt;= filter.start       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Find last block: block.timestampMin &lt;= filter.end          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Intersect with candidates from inverted indexes            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; For each candidate block:                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├─&gt; Read Block Data                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Seek to block.offset                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Read block.length bytes                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├─&gt; Decompress Block                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - gzip.Decompress(compressedData)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Result: Protobuf-encoded event stream                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├─&gt; Decode Protobuf Events                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Read length-prefixed messages                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Unmarshal each: protobuf → ResourceEvent               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├─&gt; Filter Events (exact match)                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Check timestamp in [filter.start, filter.end]          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Check kind == filter.kind (if specified)               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Check namespace == filter.namespace (if specified)     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   - Check group == filter.group (if specified)             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └─&gt; Collect matching events                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       - Append to results array                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Include Final Resource States (if in time range)             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       - For resources with no events in window but state exists    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       - Generate synthetic &quot;state-&quot; events                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ Events from all files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 4. Result Aggregation (internal/storage/query.go)                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Combine results from all files                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Merge event arrays                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Concatenate results from each file                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Sort by timestamp (ascending)                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Sort all events chronologically                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├─&gt; Apply result limit (if specified)                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   - Truncate to max results (e.g., 10000)                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─&gt; Collect metrics                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       - Total events returned                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       - Files searched                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       - Blocks scanned (decompressed)                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       - Blocks skipped (via indexes)                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       - Execution time (milliseconds)                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ Sorted events + metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 5. Response Formatting (internal/api/)                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ Format JSON response:                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   {                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     &quot;events&quot;: [...],           // Array of ResourceEvent objects   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     &quot;count&quot;: 150,               // Total events returned           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     &quot;executionTimeMs&quot;: 45,      // Query duration                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     &quot;filesSearched&quot;: 4,         // Hourly files accessed           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     &quot;segmentsScanned&quot;: 12,      // Blocks decompressed             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     &quot;segmentsSkipped&quot;: 88       // Blocks skipped (indexes)        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   }                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │ JSON response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP Client receives results</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="read-path-timing">Read Path Timing<a href="#read-path-timing" class="hash-link" aria-label="Direct link to Read Path Timing" title="Direct link to Read Path Timing" translate="no">​</a></h3>
<p><strong>Single-hour query with filters</strong> (best case):</p>
<table><thead><tr><th>Stage</th><th>Time</th><th>Notes</th></tr></thead><tbody><tr><td>Parameter parsing</td><td>&lt;1 ms</td><td>Parse query string</td></tr><tr><td>File selection</td><td>&lt;1 ms</td><td>Calculate hourly file names</td></tr><tr><td>Read header/footer</td><td>~1 ms</td><td>77 + 324 bytes</td></tr><tr><td>Read index section</td><td>~10 ms</td><td>~2 MB JSON, parse</td></tr><tr><td>Binary search timestamp</td><td>&lt;1 ms</td><td>O(log N) on ~300 blocks</td></tr><tr><td>Inverted index intersection</td><td>~1 ms</td><td>Set operations</td></tr><tr><td><strong>Block filtering result</strong></td><td><strong>2-10 blocks</strong></td><td><strong>90-98% skipped</strong></td></tr><tr><td>Read block data</td><td>~2 ms</td><td>Seek + read compressed</td></tr><tr><td>Decompress blocks</td><td>~30 ms</td><td>gzip decompress 10 MB total</td></tr><tr><td>Decode protobuf</td><td>~20 ms</td><td>Parse events</td></tr><tr><td>Event filtering</td><td>~5 ms</td><td>Exact match checks</td></tr><tr><td>Sort + format</td><td>~5 ms</td><td>Sort by timestamp</td></tr><tr><td><strong>Total</strong></td><td><strong>~75 ms</strong></td><td><strong>Typical filtered query</strong></td></tr></tbody></table>
<p><strong>24-hour query with filters</strong> (multi-file):</p>
<table><thead><tr><th>Stage</th><th>Time</th><th>Notes</th></tr></thead><tbody><tr><td>File selection</td><td>~1 ms</td><td>24 hourly files</td></tr><tr><td>Per-file processing</td><td>~75 ms × 24</td><td>Sequential file reads</td></tr><tr><td>Result merge</td><td>~50 ms</td><td>Combine + sort results</td></tr><tr><td><strong>Total</strong></td><td><strong>~1.8 seconds</strong></td><td><strong>24 files</strong></td></tr></tbody></table>
<p><strong>Optimization opportunity</strong>: Parallel file reads (planned v2.0)</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="concurrency-model-read-path">Concurrency Model (Read Path)<a href="#concurrency-model-read-path" class="hash-link" aria-label="Direct link to Concurrency Model (Read Path)" title="Direct link to Concurrency Model (Read Path)" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                     Concurrent Queries                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  HTTP Request 1                HTTP Request 2                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         │                              │                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         v                              v                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────┐              ┌─────────────┐                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ Query 1     │              │ Query 2     │                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ Goroutine   │              │ Goroutine   │                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────┬───────┘              └─────┬───────┘                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        │                            │                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        v                            v                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────┐                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │   Read Files (immutable)                │                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │   - No locking required                 │                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │   - Each query reads independently      │                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │   - OS page cache shared                │                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────┘                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────────┘</span><br></span></code></pre></div></div>
<p><strong>Key Points</strong>:</p>
<ul>
<li class=""><strong>One goroutine per request</strong>: Each HTTP request handled independently</li>
<li class=""><strong>No coordination</strong>: Files are immutable, no locks needed</li>
<li class=""><strong>Shared page cache</strong>: OS caches frequently accessed blocks</li>
<li class=""><strong>Unlimited concurrency</strong>: Only limited by OS resources</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="query-optimization-examples">Query Optimization Examples<a href="#query-optimization-examples" class="hash-link" aria-label="Direct link to Query Optimization Examples" title="Direct link to Query Optimization Examples" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-1-no-filters-full-scan">Example 1: No Filters (Full Scan)<a href="#example-1-no-filters-full-scan" class="hash-link" aria-label="Direct link to Example 1: No Filters (Full Scan)" title="Direct link to Example 1: No Filters (Full Scan)" translate="no">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Query: All events from 10:00-11:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">File: 2025-12-12-10.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Total blocks: 300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Blocks matching time range: 300 (all)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Blocks to decompress: 300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Events scanned: 60,000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Events returned: 60,000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution time: ~400ms (decompress all blocks)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-2-kind-filter">Example 2: Kind Filter<a href="#example-2-kind-filter" class="hash-link" aria-label="Direct link to Example 2: Kind Filter" title="Direct link to Example 2: Kind Filter" translate="no">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Query: kind=Pod, 10:00-11:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">File: 2025-12-12-10.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Inverted index: KindToBlocks[&quot;Pod&quot;] = [0, 2, 5, 7, ..., 290] (30 blocks)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Blocks to decompress: 30 (90% skip rate!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Events scanned: 6,000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Events returned: 6,000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution time: ~50ms (decompress 10% of blocks)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-3-kind--namespace-filter">Example 3: Kind + Namespace Filter<a href="#example-3-kind--namespace-filter" class="hash-link" aria-label="Direct link to Example 3: Kind + Namespace Filter" title="Direct link to Example 3: Kind + Namespace Filter" translate="no">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Query: kind=Pod, namespace=default, 10:00-11:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">File: 2025-12-12-10.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- KindToBlocks[&quot;Pod&quot;] = [0, 2, 5, 7, ..., 290] (30 blocks)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- NamespaceToBlocks[&quot;default&quot;] = [0, 1, 2, 3, 4, 5] (50 blocks)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Intersection: [0, 2, 5] (3 blocks, 99% skip rate!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Blocks to decompress: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Events scanned: 600</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Events returned: 200 (after exact match)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution time: ~15ms (decompress 1% of blocks)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="error-handling-read-path">Error Handling (Read Path)<a href="#error-handling-read-path" class="hash-link" aria-label="Direct link to Error Handling (Read Path)" title="Direct link to Error Handling (Read Path)" translate="no">​</a></h3>
<table><thead><tr><th>Error Type</th><th>Handling</th><th>Response</th></tr></thead><tbody><tr><td><strong>Invalid parameters</strong></td><td>Return 400 Bad Request</td><td>Error message to client</td></tr><tr><td><strong>File not found</strong></td><td>Skip file, continue query</td><td>Partial results returned</td></tr><tr><td><strong>Corrupted header</strong></td><td>Skip file, log error</td><td>Partial results</td></tr><tr><td><strong>Corrupted footer</strong></td><td>Skip file, log error</td><td>Partial results</td></tr><tr><td><strong>Invalid index JSON</strong></td><td>Skip file, log error</td><td>Partial results</td></tr><tr><td><strong>Decompression error</strong></td><td>Skip block, log error</td><td>Partial results</td></tr><tr><td><strong>Protobuf decode error</strong></td><td>Skip event, log error</td><td>Partial results</td></tr><tr><td><strong>Timeout</strong></td><td>Return 504 Gateway Timeout</td><td>Client can retry</td></tr></tbody></table>
<p><strong>Philosophy</strong>: Partial results better than no results. Errors logged for debugging.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="data-transformations">Data Transformations<a href="#data-transformations" class="hash-link" aria-label="Direct link to Data Transformations" title="Direct link to Data Transformations" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="event-size-transformations">Event Size Transformations<a href="#event-size-transformations" class="hash-link" aria-label="Direct link to Event Size Transformations" title="Direct link to Event Size Transformations" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Original Kubernetes Object (with managedFields)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Size: ~10 KB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Format: runtime.Object (Go struct)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pruned ResourceEvent (managedFields removed)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Size: ~1-2 KB (80-90% reduction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Format: ResourceEvent struct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JSON-encoded Event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Size: ~1.5 KB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Format: JSON bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Protobuf-encoded Event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Size: ~1.2 KB (20% smaller than JSON)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Format: Protobuf bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Compressed Block (gzip)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Size: ~300 bytes per event (~75% reduction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Format: gzip-compressed protobuf stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stored on Disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Size: ~300 bytes per event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Includes: Event data + metadata + indexes</span><br></span></code></pre></div></div>
<p><strong>Total reduction: 10 KB → 300 bytes = 97% savings</strong></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="metadata-evolution">Metadata Evolution<a href="#metadata-evolution" class="hash-link" aria-label="Direct link to Metadata Evolution" title="Direct link to Metadata Evolution" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ResourceEvent (original)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Fields: UID, Kind, Namespace, Name, Timestamp, Operation, Object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EventBuffer Metadata (aggregated)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Fields: KindSet, NamespaceSet, GroupSet, TimestampMin/Max</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Purpose: Track block contents for indexing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Block Metadata (per block)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Fields: ID, Offset, Length, EventCount, TimestampRange, Sets, Bloom filters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Purpose: Enable filtering without decompression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Inverted Indexes (per file)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Fields: KindToBlocks, NamespaceToBlocks, GroupToBlocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Purpose: Map filters → candidate blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query Results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Fields: Events[], Count, ExecutionTimeMs, FilesSearched, SegmentsScanned</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │  Purpose: Provide results + performance metrics</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="performance-characteristics">Performance Characteristics<a href="#performance-characteristics" class="hash-link" aria-label="Direct link to Performance Characteristics" title="Direct link to Performance Characteristics" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="write-path-throughput">Write Path Throughput<a href="#write-path-throughput" class="hash-link" aria-label="Direct link to Write Path Throughput" title="Direct link to Write Path Throughput" translate="no">​</a></h3>
<table><thead><tr><th>Component</th><th>Throughput</th><th>Bottleneck</th></tr></thead><tbody><tr><td>Watcher</td><td>10,000 events/sec</td><td>Kubernetes API rate limit</td></tr><tr><td>Pruning</td><td>50,000 events/sec</td><td>CPU (JSON parsing)</td></tr><tr><td>Validation</td><td>100,000 events/sec</td><td>Minimal overhead</td></tr><tr><td>Event queue</td><td>Unlimited</td><td>Memory-based channel</td></tr><tr><td>JSON marshal</td><td>20,000 events/sec</td><td>CPU (serialization)</td></tr><tr><td>Buffer accumulation</td><td>50,000 events/sec</td><td>Memory operations</td></tr><tr><td>Block finalization</td><td>~800 events/130ms</td><td>gzip compression (CPU)</td></tr><tr><td><strong>Sustained write rate</strong></td><td><strong>7,500 events/sec</strong></td><td><strong>Bottleneck: compression</strong></td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="read-path-latency">Read Path Latency<a href="#read-path-latency" class="hash-link" aria-label="Direct link to Read Path Latency" title="Direct link to Read Path Latency" translate="no">​</a></h3>
<table><thead><tr><th>Query Type</th><th>Latency (P50)</th><th>Latency (P99)</th><th>Bottleneck</th></tr></thead><tbody><tr><td>1-hour, no filters</td><td>350 ms</td><td>500 ms</td><td>Decompression</td></tr><tr><td>1-hour, kind filter</td><td>45 ms</td><td>80 ms</td><td>I/O (block reads)</td></tr><tr><td>1-hour, multi-filter</td><td>12 ms</td><td>25 ms</td><td>Inverted index ops</td></tr><tr><td>24-hour, filtered</td><td>180 ms</td><td>400 ms</td><td>Sequential file reads</td></tr><tr><td>7-day, filtered</td><td>1.2 s</td><td>2.5 s</td><td>File count</td></tr></tbody></table>
<p><strong>Optimization</strong>: Parallel file reads can reduce 24-hour query to ~50ms (planned v2.0)</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="related-documentation">Related Documentation<a href="#related-documentation" class="hash-link" aria-label="Direct link to Related Documentation" title="Direct link to Related Documentation" translate="no">​</a></h2>
<ul>
<li class=""><a class="" href="/spectre/docs/architecture/overview">Architecture Overview</a> - System design and components</li>
<li class=""><a class="" href="/spectre/docs/architecture/storage-design">Storage Design</a> - File organization and blocks</li>
<li class=""><a class="" href="/spectre/docs/architecture/query-execution">Query Execution</a> - Query optimization details</li>
<li class=""><a class="" href="/spectre/docs/architecture/indexing-strategy">Indexing Strategy</a> - Inverted indexes and bloom filters</li>
<li class=""><a class="" href="/spectre/docs/architecture/compression">Compression</a> - Compression algorithms and performance</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/moolen/spectre/tree/master/docs/docs/architecture/data-flow.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-12-13T08:58:49.000Z" itemprop="dateModified">Dec 13, 2025</time></b> by <b>Moritz Johner</b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/spectre/docs/architecture/query-execution"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Query Execution</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#system-overview" class="table-of-contents__link toc-highlight">System Overview</a></li><li><a href="#write-path-events-to-storage" class="table-of-contents__link toc-highlight">Write Path: Events to Storage</a><ul><li><a href="#complete-write-flow" class="table-of-contents__link toc-highlight">Complete Write Flow</a></li><li><a href="#write-path-timing" class="table-of-contents__link toc-highlight">Write Path Timing</a></li><li><a href="#concurrency-model-write-path" class="table-of-contents__link toc-highlight">Concurrency Model (Write Path)</a></li><li><a href="#error-handling-write-path" class="table-of-contents__link toc-highlight">Error Handling (Write Path)</a></li></ul></li><li><a href="#read-path-query-to-results" class="table-of-contents__link toc-highlight">Read Path: Query to Results</a><ul><li><a href="#complete-read-flow" class="table-of-contents__link toc-highlight">Complete Read Flow</a></li><li><a href="#read-path-timing" class="table-of-contents__link toc-highlight">Read Path Timing</a></li><li><a href="#concurrency-model-read-path" class="table-of-contents__link toc-highlight">Concurrency Model (Read Path)</a></li><li><a href="#query-optimization-examples" class="table-of-contents__link toc-highlight">Query Optimization Examples</a></li><li><a href="#error-handling-read-path" class="table-of-contents__link toc-highlight">Error Handling (Read Path)</a></li></ul></li><li><a href="#data-transformations" class="table-of-contents__link toc-highlight">Data Transformations</a><ul><li><a href="#event-size-transformations" class="table-of-contents__link toc-highlight">Event Size Transformations</a></li><li><a href="#metadata-evolution" class="table-of-contents__link toc-highlight">Metadata Evolution</a></li></ul></li><li><a href="#performance-characteristics" class="table-of-contents__link toc-highlight">Performance Characteristics</a><ul><li><a href="#write-path-throughput" class="table-of-contents__link toc-highlight">Write Path Throughput</a></li><li><a href="#read-path-latency" class="table-of-contents__link toc-highlight">Read Path Latency</a></li></ul></li><li><a href="#related-documentation" class="table-of-contents__link toc-highlight">Related Documentation</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/intro">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/installation">Installation</a></li><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/mcp-integration">MCP Integration</a></li><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/architecture">Architecture</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/api">API Reference</a></li><li class="footer__item"><a class="footer__link-item" href="/spectre/docs/operations/troubleshooting">Troubleshooting</a></li><li class="footer__item"><a href="https://github.com/moolen/spectre/tree/master/chart" target="_blank" rel="noopener noreferrer" class="footer__link-item">Helm Chart<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/moolen/spectre" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/moolen/spectre/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issues<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/moolen/spectre/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussions<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Spectre Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>