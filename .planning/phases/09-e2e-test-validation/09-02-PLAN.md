---
phase: 09-e2e-test-validation
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - tests/e2e/mcp_stdio_test.go (deleted)
  - tests/e2e/mcp_stdio_stage_test.go (deleted)
  - tests/e2e/helpers/mcp_subprocess.go (deleted)
autonomous: true

must_haves:
  truths:
    - "MCP stdio tests are removed (command no longer exists)"
    - "E2E test suite compiles successfully with stdio tests removed"
    - "E2E test suite runs successfully against consolidated server"
    - "MCP HTTP tests verify tools work on port 8080 at /v1/mcp"
    - "Config reload tests verify integration hot-reload in consolidated architecture"
  artifacts:
    - path: "tests/e2e/mcp_stdio_test.go"
      provides: "DELETED - stdio transport test entry point"
      exists: false
    - path: "tests/e2e/mcp_stdio_stage_test.go"
      provides: "DELETED - stdio transport test implementation"
      exists: false
    - path: "tests/e2e/helpers/mcp_subprocess.go"
      provides: "DELETED - stdio subprocess helper"
      exists: false
  key_links:
    - from: "E2E test suite"
      to: "consolidated MCP server"
      via: "HTTP transport on port 8080"
      pattern: "TestMCPHTTPTransport.*8080"
    - from: "Config reload tests"
      to: "integration manager"
      via: "ConfigMap update triggers hot-reload"
      pattern: "UpdateConfigMap.*hot-reload"
---

<objective>
Remove stdio transport tests and verify E2E test suite works with consolidated MCP architecture.

Purpose: Phase 8 removed standalone `spectre mcp` command, making stdio transport tests obsolete. E2E suite must validate HTTP transport and config reload work with consolidated server.

Output: Clean test suite with stdio tests removed, all remaining tests passing against port 8080 /v1/mcp endpoint.
</objective>

<execution_context>
@/home/moritz/.claude/get-shit-done/workflows/execute-plan.md
@/home/moritz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/moritz/dev/spectre-via-ssh/.planning/PROJECT.md
@/home/moritz/dev/spectre-via-ssh/.planning/ROADMAP.md
@/home/moritz/dev/spectre-via-ssh/.planning/STATE.md
@/home/moritz/dev/spectre-via-ssh/.planning/phases/09-e2e-test-validation/09-CONTEXT.md
@/home/moritz/dev/spectre-via-ssh/.planning/phases/09-e2e-test-validation/09-RESEARCH.md

# Prior plan result
@/home/moritz/dev/spectre-via-ssh/.planning/phases/09-e2e-test-validation/09-01-SUMMARY.md

# Files to be deleted
@/home/moritz/dev/spectre-via-ssh/tests/e2e/mcp_stdio_test.go
@/home/moritz/dev/spectre-via-ssh/tests/e2e/mcp_stdio_stage_test.go
@/home/moritz/dev/spectre-via-ssh/tests/e2e/helpers/mcp_subprocess.go

# Tests that should still work
@/home/moritz/dev/spectre-via-ssh/tests/e2e/mcp_http_test.go
@/home/moritz/dev/spectre-via-ssh/tests/e2e/config_reload_test.go
</context>

<tasks>

<task type="auto">
  <name>Delete stdio transport test files</name>
  <files>
    tests/e2e/mcp_stdio_test.go
    tests/e2e/mcp_stdio_stage_test.go
    tests/e2e/helpers/mcp_subprocess.go
  </files>
  <action>
    Remove stdio transport tests that depend on the deleted `spectre mcp` standalone command:

    ```bash
    cd /home/moritz/dev/spectre-via-ssh
    rm -f tests/e2e/mcp_stdio_test.go
    rm -f tests/e2e/mcp_stdio_stage_test.go
    rm -f tests/e2e/helpers/mcp_subprocess.go
    ```

    Why delete:
    - Phase 8 (plan 08-01) removed standalone `spectre mcp` command
    - Stdio transport tests invoke `spectre mcp --transport stdio` which no longer exists
    - mcp_subprocess.go helper is only used by stdio tests (verified via grep)
    - Phase 6-8 consolidated MCP into main server (HTTP transport only)

    Research verification: grep confirmed these 3 files only reference each other, no other tests import them.

    Verification: Confirm files are deleted and test suite compiles.
  </action>
  <verify>
    cd /home/moritz/dev/spectre-via-ssh && \
    ! test -f tests/e2e/mcp_stdio_test.go && \
    ! test -f tests/e2e/mcp_stdio_stage_test.go && \
    ! test -f tests/e2e/helpers/mcp_subprocess.go && \
    go test -c ./tests/e2e -o /tmp/e2e-test-binary && \
    rm /tmp/e2e-test-binary && \
    echo "Stdio test files deleted and suite compiles"
  </verify>
  <done>Stdio test files removed, E2E test suite compiles without them, no broken imports</done>
</task>

<task type="auto">
  <name>Run E2E test compilation and local validation</name>
  <files>tests/e2e/</files>
  <action>
    Validate test suite integrity after stdio removal and endpoint/port updates:

    1. **Compile test binary:**
       ```bash
       cd /home/moritz/dev/spectre-via-ssh
       go test -c ./tests/e2e -o e2e.test
       ```
       Expected: Clean compilation with no errors

    2. **List available tests:**
       ```bash
       ./e2e.test -test.list '.*'
       ```
       Expected output should include:
       - TestMCPHTTPTransport (HTTP transport test)
       - TestMCPFailureScenarios (failure handling test)
       - TestConfigReload (config hot-reload test)

       Should NOT include:
       - TestMCPStdioTransport (deleted)

    3. **Verify test prerequisites:**
       Check that tests reference correct infrastructure:
       - Port 8080 for MCP endpoint
       - /v1/mcp path in MCP client
       - No references to port 8082

    4. **Clean up:**
       ```bash
       rm e2e.test
       ```

    Why local validation: Full E2E tests require kind cluster with FalkorDB/VictoriaLogs (cluster setup), but compilation and test listing verify structure is correct.

    Note: Full test execution with `make test-e2e` will be verified by human in checkpoint - requires cluster infrastructure.
  </action>
  <verify>
    cd /home/moritz/dev/spectre-via-ssh && \
    go test -c ./tests/e2e -o e2e.test && \
    ./e2e.test -test.list '.*' | grep -q "TestMCPHTTPTransport" && \
    ./e2e.test -test.list '.*' | grep -q "TestConfigReload" && \
    ! ./e2e.test -test.list '.*' | grep -q "TestMCPStdioTransport" && \
    rm e2e.test && \
    echo "Test suite structure validated"
  </verify>
  <done>E2E test compilation succeeds, HTTP and config reload tests present, stdio tests absent</done>
</task>

<task type="auto">
  <name>Execute E2E test suite with log analysis</name>
  <files>tests/e2e/</files>
  <action>
    Run the full E2E test suite against kind cluster and analyze results:

    1. **Execute tests:**
       ```bash
       cd /home/moritz/dev/spectre-via-ssh
       make test-e2e 2>&1 | tee /tmp/e2e-test-output.log
       ```

    2. **Capture exit code:**
       ```bash
       echo ${PIPESTATUS[0]} > /tmp/e2e-test-exit-code.txt
       ```

    3. **Analyze results:**
       - Parse test output for PASS/FAIL status
       - Check for "connection refused" errors (indicates port misconfiguration)
       - Check for "404" errors (indicates endpoint path issues)
       - Verify TestMCPHTTPTransport passed
       - Verify TestConfigReload passed
       - Verify TestMCPStdioTransport did NOT run (deleted)

    4. **Log key metrics:**
       - Total tests run
       - Pass count
       - Fail count (should be 0)
       - Duration

    Expected: All remaining tests pass with exit code 0. Tests connect to port 8080 at /v1/mcp successfully.

    If tests fail: Log analysis will capture specific failures for debugging. Common issues:
    - Kind cluster not running
    - FalkorDB/VictoriaLogs not deployed
    - Helm chart deployment issues
    - Port/endpoint configuration errors from Plan 09-01
  </action>
  <verify>
    cd /home/moritz/dev/spectre-via-ssh && \
    EXIT_CODE=$(cat /tmp/e2e-test-exit-code.txt 2>/dev/null || echo "1") && \
    if [ "$EXIT_CODE" -eq "0" ]; then \
      echo "E2E tests PASSED - exit code 0" && \
      grep -i "PASS.*TestMCPHTTPTransport" /tmp/e2e-test-output.log && \
      grep -i "PASS.*TestConfigReload" /tmp/e2e-test-output.log; \
    else \
      echo "E2E tests FAILED - exit code $EXIT_CODE" && \
      echo "Review /tmp/e2e-test-output.log for details" && \
      exit 1; \
    fi
  </verify>
  <done>E2E test suite executes successfully, all tests pass, logs confirm correct port/endpoint usage</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Consolidated MCP E2E test suite with:
    1. Updated endpoint: /v1/mcp (was /mcp)
    2. Updated port: 8080 (was 8082)
    3. Removed stdio tests: TestMCPStdioTransport deleted
    4. Retained HTTP tests: TestMCPHTTPTransport, TestMCPFailureScenarios
    5. Retained config tests: TestConfigReload
    6. Autonomous test execution completed (see Task 3 results)
  </what-built>
  <how-to-verify>
    Review the autonomous test execution results from Task 3:

    1. **Check test output log:**
       ```bash
       cat /tmp/e2e-test-output.log
       ```

    2. **Verify test outcomes:**
       - All tests should show PASS status
       - TestMCPHTTPTransport: Validates HTTP transport on port 8080 at /v1/mcp
       - TestConfigReload: Validates config hot-reload in consolidated architecture
       - TestMCPFailureScenarios: Validates error handling
       - TestMCPStdioTransport: Should NOT appear (deleted)

    3. **Check for warnings/errors:**
       - No "connection refused" errors (port misconfiguration)
       - No "404" errors (endpoint path issues)
       - No "command not found: mcp" errors (stdio test references)

    4. **Functional verification (optional manual test):**
       If you want to manually verify beyond automated tests:
       ```bash
       # Port-forward to deployed spectre
       kubectl port-forward -n e2e-shared svc/spectre-e2e-shared-spectre 8080:8080

       # In another terminal, test MCP endpoint
       curl -X POST http://localhost:8080/v1/mcp \
         -H "Content-Type: application/json" \
         -d '{"jsonrpc":"2.0","id":1,"method":"ping"}'

       # Should return: {"jsonrpc":"2.0","id":1,"result":{}}
       ```

    **Requirements validated:**
    - TEST-01: MCP HTTP tests connect to main server port 8080 at /v1/mcp ✓
    - TEST-02: MCP stdio tests removed (standalone command deleted in Phase 8) ✓
    - TEST-03: Config reload tests work with consolidated architecture ✓
    - TEST-04: MCP sidecar-specific test assumptions removed (port 8082 refs deleted) ✓

    **Success criteria:**
    - Autonomous test run (Task 3) shows exit code 0
    - All remaining tests PASS
    - Test output log shows correct port (8080) and endpoint (/v1/mcp)
    - No stdio test execution attempts
  </how-to-verify>
  <resume-signal>
    Type "approved" if autonomous tests passed and log review looks good, or describe specific test failures if issues found.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **File deletion verification:**
   ```bash
   ls tests/e2e/mcp_stdio*.go tests/e2e/helpers/mcp_subprocess.go 2>&1
   # Should return "No such file or directory"
   ```

2. **Test suite structure:**
   ```bash
   go test -c ./tests/e2e && ./e2e.test -test.list '.*' && rm e2e.test
   # Should list HTTP and config tests, NOT stdio tests
   ```

3. **Autonomous E2E execution:**
   ```bash
   cat /tmp/e2e-test-exit-code.txt
   # Should show: 0
   ```

4. **Requirements coverage:**
   - TEST-01: HTTP tests use port 8080 /v1/mcp ✓
   - TEST-02: Stdio tests removed (command deleted in Phase 8) ✓
   - TEST-03: Config reload tests pass ✓
   - TEST-04: Port 8082 references removed ✓
</verification>

<success_criteria>
Plan complete when:
- [ ] mcp_stdio_test.go deleted
- [ ] mcp_stdio_stage_test.go deleted
- [ ] helpers/mcp_subprocess.go deleted
- [ ] Test suite compiles successfully
- [ ] Test list shows HTTP and config tests, no stdio tests
- [ ] Autonomous test execution: `make test-e2e` completes with exit code 0
- [ ] Test logs show correct port (8080) and endpoint (/v1/mcp)
- [ ] Human verification: Test output review confirms quality
- [ ] TEST-01 verified: MCP HTTP tests work on port 8080 at /v1/mcp
- [ ] TEST-02 satisfied: Stdio tests removed (standalone command deleted in Phase 8)
- [ ] TEST-03 verified: Config reload tests pass with consolidated architecture
- [ ] TEST-04 verified: No port 8082 or sidecar assumptions remain
- [ ] Phase 9 goal achieved: E2E tests validate consolidated architecture
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-test-validation/09-02-SUMMARY.md`
</output>
