---
phase: 09-e2e-test-validation
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - tests/e2e/mcp_stdio_test.go (deleted)
  - tests/e2e/mcp_stdio_stage_test.go (deleted)
  - tests/e2e/helpers/mcp_subprocess.go (deleted)
autonomous: false

must_haves:
  truths:
    - "MCP stdio tests are removed (command no longer exists)"
    - "E2E test suite runs successfully against consolidated server"
    - "MCP HTTP tests verify tools work on port 8080 at /v1/mcp"
    - "Config reload tests verify integration hot-reload in consolidated architecture"
  artifacts:
    - path: "tests/e2e/mcp_stdio_test.go"
      provides: "DELETED - stdio transport test entry point"
      exists: false
    - path: "tests/e2e/mcp_stdio_stage_test.go"
      provides: "DELETED - stdio transport test implementation"
      exists: false
    - path: "tests/e2e/helpers/mcp_subprocess.go"
      provides: "DELETED - stdio subprocess helper"
      exists: false
  key_links:
    - from: "E2E test suite"
      to: "consolidated MCP server"
      via: "HTTP transport on port 8080"
      pattern: "TestMCPHTTPTransport.*8080"
    - from: "Config reload tests"
      to: "integration manager"
      via: "ConfigMap update triggers hot-reload"
      pattern: "UpdateConfigMap.*hot-reload"
---

<objective>
Remove stdio transport tests and verify E2E test suite works with consolidated MCP architecture.

Purpose: Phase 8 removed standalone `spectre mcp` command, making stdio transport tests obsolete. E2E suite must validate HTTP transport and config reload work with consolidated server.

Output: Clean test suite with stdio tests removed, all remaining tests passing against port 8080 /v1/mcp endpoint.
</objective>

<execution_context>
@/home/moritz/.claude/get-shit-done/workflows/execute-plan.md
@/home/moritz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/moritz/dev/spectre-via-ssh/.planning/PROJECT.md
@/home/moritz/dev/spectre-via-ssh/.planning/ROADMAP.md
@/home/moritz/dev/spectre-via-ssh/.planning/STATE.md
@/home/moritz/dev/spectre-via-ssh/.planning/phases/09-e2e-test-validation/09-CONTEXT.md
@/home/moritz/dev/spectre-via-ssh/.planning/phases/09-e2e-test-validation/09-RESEARCH.md

# Prior plan result
@/home/moritz/dev/spectre-via-ssh/.planning/phases/09-e2e-test-validation/09-01-SUMMARY.md

# Files to be deleted
@/home/moritz/dev/spectre-via-ssh/tests/e2e/mcp_stdio_test.go
@/home/moritz/dev/spectre-via-ssh/tests/e2e/mcp_stdio_stage_test.go
@/home/moritz/dev/spectre-via-ssh/tests/e2e/helpers/mcp_subprocess.go

# Tests that should still work
@/home/moritz/dev/spectre-via-ssh/tests/e2e/mcp_http_test.go
@/home/moritz/dev/spectre-via-ssh/tests/e2e/config_reload_test.go
</context>

<tasks>

<task type="auto">
  <name>Delete stdio transport test files</name>
  <files>
    tests/e2e/mcp_stdio_test.go
    tests/e2e/mcp_stdio_stage_test.go
    tests/e2e/helpers/mcp_subprocess.go
  </files>
  <action>
    Remove stdio transport tests that depend on the deleted `spectre mcp` standalone command:

    ```bash
    cd /home/moritz/dev/spectre-via-ssh
    rm -f tests/e2e/mcp_stdio_test.go
    rm -f tests/e2e/mcp_stdio_stage_test.go
    rm -f tests/e2e/helpers/mcp_subprocess.go
    ```

    Why delete:
    - Phase 8 (plan 08-01) removed standalone `spectre mcp` command
    - Stdio transport tests invoke `spectre mcp --transport stdio` which no longer exists
    - mcp_subprocess.go helper is only used by stdio tests (verified via grep)
    - Phase 6-8 consolidated MCP into main server (HTTP transport only)

    Research verification: grep confirmed these 3 files only reference each other, no other tests import them.

    Verification: Confirm files are deleted and test suite compiles.
  </action>
  <verify>
    cd /home/moritz/dev/spectre-via-ssh && \
    ! test -f tests/e2e/mcp_stdio_test.go && \
    ! test -f tests/e2e/mcp_stdio_stage_test.go && \
    ! test -f tests/e2e/helpers/mcp_subprocess.go && \
    go test -c ./tests/e2e -o /tmp/e2e-test-binary && \
    rm /tmp/e2e-test-binary && \
    echo "Stdio test files deleted and suite compiles"
  </verify>
  <done>Stdio test files removed, E2E test suite compiles without them, no broken imports</done>
</task>

<task type="auto">
  <name>Run E2E test compilation and local validation</name>
  <files>tests/e2e/</files>
  <action>
    Validate test suite integrity after stdio removal and endpoint/port updates:

    1. **Compile test binary:**
       ```bash
       cd /home/moritz/dev/spectre-via-ssh
       go test -c ./tests/e2e -o e2e.test
       ```
       Expected: Clean compilation with no errors

    2. **List available tests:**
       ```bash
       ./e2e.test -test.list '.*'
       ```
       Expected output should include:
       - TestMCPHTTPTransport (HTTP transport test)
       - TestMCPFailureScenarios (failure handling test)
       - TestConfigReload (config hot-reload test)

       Should NOT include:
       - TestMCPStdioTransport (deleted)

    3. **Verify test prerequisites:**
       Check that tests reference correct infrastructure:
       - Port 8080 for MCP endpoint
       - /v1/mcp path in MCP client
       - No references to port 8082

    4. **Clean up:**
       ```bash
       rm e2e.test
       ```

    Why local validation: Full E2E tests require kind cluster with FalkorDB/VictoriaLogs (cluster setup), but compilation and test listing verify structure is correct.

    Note: Full test execution with `make test-e2e` will be verified by human in checkpoint - requires cluster infrastructure.
  </action>
  <verify>
    cd /home/moritz/dev/spectre-via-ssh && \
    go test -c ./tests/e2e -o e2e.test && \
    ./e2e.test -test.list '.*' | grep -q "TestMCPHTTPTransport" && \
    ./e2e.test -test.list '.*' | grep -q "TestConfigReload" && \
    ! ./e2e.test -test.list '.*' | grep -q "TestMCPStdioTransport" && \
    rm e2e.test && \
    echo "Test suite structure validated"
  </verify>
  <done>E2E test compilation succeeds, HTTP and config reload tests present, stdio tests absent</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Consolidated MCP E2E test suite with:
    1. Updated endpoint: /v1/mcp (was /mcp)
    2. Updated port: 8080 (was 8082)
    3. Removed stdio tests: TestMCPStdioTransport deleted
    4. Retained HTTP tests: TestMCPHTTPTransport, TestMCPFailureScenarios
    5. Retained config tests: TestConfigReload
  </what-built>
  <how-to-verify>
    Run the full E2E test suite against a kind cluster with deployed Spectre:

    **Prerequisites:**
    - kind cluster running (verify: `kind get clusters`)
    - FalkorDB and VictoriaLogs deployed (E2E infrastructure)
    - Helm available

    **Execute tests:**
    ```bash
    cd /home/moritz/dev/spectre-via-ssh
    make test-e2e
    ```

    **Expected results:**

    1. **MCP HTTP Transport Tests (TEST-01):**
       - TestMCPHTTPTransport should PASS
       - Tests connect to port 8080 (not 8082)
       - MCP client sends to /v1/mcp endpoint
       - Tools respond correctly: cluster_health, resource_timeline, etc.
       - Server info and capabilities return expected data

    2. **Config Reload Tests (TEST-03):**
       - TestConfigReload should PASS
       - ConfigMap updates trigger integration hot-reload
       - New watcher configurations take effect
       - No server restart required

    3. **MCP Failure Scenarios:**
       - TestMCPFailureScenarios should PASS
       - Error handling works correctly
       - Timeouts and invalid requests handled gracefully

    4. **Tests NOT present:**
       - TestMCPStdioTransport should NOT run (deleted)

    5. **Overall:**
       - All tests PASS (100% pass rate for remaining tests)
       - No connection refused errors
       - No 404 errors on /v1/mcp endpoint
       - Test logs show "port 8080" not "port 8082"

    **If tests fail:**
    - Check error messages for endpoint or port issues
    - Verify Helm chart deployed with Phase 8 updates (no MCP sidecar)
    - Check pod logs: `kubectl logs -n <test-namespace> <spectre-pod>`
    - Verify /v1/mcp endpoint exists: `kubectl port-forward -n <ns> svc/spectre 8080:8080` then `curl http://localhost:8080/v1/mcp`

    **Requirements validated:**
    - TEST-01: MCP HTTP tests connect to main server port 8080 at /v1/mcp
    - TEST-02: MCP stdio tests removed (N/A - command deleted)
    - TEST-03: Config reload tests work with consolidated architecture
    - TEST-04: MCP sidecar-specific test assumptions removed (port 8082 refs deleted)
  </how-to-verify>
  <resume-signal>
    Type "approved" if all tests pass, or describe specific test failures with error messages for debugging.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **File deletion verification:**
   ```bash
   ls tests/e2e/mcp_stdio*.go tests/e2e/helpers/mcp_subprocess.go 2>&1
   # Should return "No such file or directory"
   ```

2. **Test suite structure:**
   ```bash
   go test -c ./tests/e2e && ./e2e.test -test.list '.*' && rm e2e.test
   # Should list HTTP and config tests, NOT stdio tests
   ```

3. **Full E2E execution (human checkpoint):**
   ```bash
   make test-e2e
   # All remaining tests should PASS
   ```

4. **Requirements coverage:**
   - TEST-01: HTTP tests use port 8080 /v1/mcp ✓
   - TEST-02: Stdio tests removed ✓
   - TEST-03: Config reload tests pass ✓
   - TEST-04: Port 8082 references removed ✓
</verification>

<success_criteria>
Plan complete when:
- [ ] mcp_stdio_test.go deleted
- [ ] mcp_stdio_stage_test.go deleted
- [ ] helpers/mcp_subprocess.go deleted
- [ ] Test suite compiles successfully
- [ ] Test list shows HTTP and config tests, no stdio tests
- [ ] Human verification: `make test-e2e` passes all remaining tests
- [ ] TEST-01 verified: MCP HTTP tests work on port 8080 at /v1/mcp
- [ ] TEST-02 satisfied: Stdio tests removed (command no longer exists)
- [ ] TEST-03 verified: Config reload tests pass with consolidated architecture
- [ ] TEST-04 verified: No port 8082 or sidecar assumptions remain
- [ ] Phase 9 goal achieved: E2E tests validate consolidated architecture
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-test-validation/09-02-SUMMARY.md`
</output>
