---
phase: 09-e2e-test-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/e2e/helpers/mcp_client.go
  - tests/e2e/mcp_http_stage_test.go
  - tests/e2e/mcp_failure_scenarios_stage_test.go
  - tests/e2e/main_test.go
  - tests/e2e/helpers/shared_setup.go
autonomous: true

must_haves:
  truths:
    - "MCP HTTP tests connect to port 8080 instead of 8082"
    - "MCP client sends requests to /v1/mcp endpoint instead of /mcp"
    - "Test deployment configuration reflects consolidated architecture"
  artifacts:
    - path: "tests/e2e/helpers/mcp_client.go"
      provides: "MCP HTTP client with /v1/mcp endpoint"
      contains: "BaseURL+\"/v1/mcp\""
      min_lines: 100
    - path: "tests/e2e/mcp_http_stage_test.go"
      provides: "HTTP transport test with port 8080"
      contains: "8080"
      min_lines: 200
    - path: "tests/e2e/mcp_failure_scenarios_stage_test.go"
      provides: "Failure scenario test with port 8080"
      contains: "8080"
      min_lines: 400
    - path: "tests/e2e/main_test.go"
      provides: "Test suite setup without MCP-specific port config"
      min_lines: 100
  key_links:
    - from: "tests/e2e/mcp_http_stage_test.go"
      to: "helpers.NewPortForwarder"
      via: "port-forward to main server"
      pattern: "NewPortForwarder.*8080"
    - from: "tests/e2e/helpers/mcp_client.go"
      to: "/v1/mcp endpoint"
      via: "HTTP POST request"
      pattern: "BaseURL.*\"/v1/mcp\""
---

<objective>
Update E2E test configuration to connect to consolidated MCP server on port 8080 at /v1/mcp endpoint.

Purpose: E2E tests must reflect Phase 6-8 consolidated architecture where MCP runs in-process on main server port, not on separate port 8082.

Output: Test files reference correct port (8080) and endpoint (/v1/mcp), matching production deployment.
</objective>

<execution_context>
@/home/moritz/.claude/get-shit-done/workflows/execute-plan.md
@/home/moritz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/moritz/dev/spectre-via-ssh/.planning/PROJECT.md
@/home/moritz/dev/spectre-via-ssh/.planning/ROADMAP.md
@/home/moritz/dev/spectre-via-ssh/.planning/STATE.md
@/home/moritz/dev/spectre-via-ssh/.planning/phases/09-e2e-test-validation/09-CONTEXT.md
@/home/moritz/dev/spectre-via-ssh/.planning/phases/09-e2e-test-validation/09-RESEARCH.md

# Current test files with incorrect config
@/home/moritz/dev/spectre-via-ssh/tests/e2e/helpers/mcp_client.go
@/home/moritz/dev/spectre-via-ssh/tests/e2e/mcp_http_stage_test.go
@/home/moritz/dev/spectre-via-ssh/tests/e2e/mcp_failure_scenarios_stage_test.go
@/home/moritz/dev/spectre-via-ssh/tests/e2e/main_test.go
@/home/moritz/dev/spectre-via-ssh/tests/e2e/helpers/shared_setup.go
</context>

<tasks>

<task type="auto">
  <name>Update MCP endpoint path from /mcp to /v1/mcp</name>
  <files>tests/e2e/helpers/mcp_client.go</files>
  <action>
    Update the HTTP request path in the Call method:
    - Line 94: Change `m.BaseURL+"/mcp"` to `m.BaseURL+"/v1/mcp"`

    Why /v1/mcp: Phase 6 decision (06-01) established /v1/mcp for API versioning consistency with /api/v1/* endpoints. The /mcp path was never implemented - implementation always used /v1/mcp.

    Verification: After change, grep confirms "/v1/mcp" appears in HTTP request construction.
  </action>
  <verify>grep -n '"/v1/mcp"' /home/moritz/dev/spectre-via-ssh/tests/e2e/helpers/mcp_client.go</verify>
  <done>MCP client sends JSON-RPC requests to /v1/mcp endpoint matching server implementation</done>
</task>

<task type="auto">
  <name>Update port references from 8082 to 8080</name>
  <files>
    tests/e2e/mcp_http_stage_test.go
    tests/e2e/mcp_failure_scenarios_stage_test.go
    tests/e2e/main_test.go
    tests/e2e/helpers/shared_setup.go
  </files>
  <action>
    Update port references across test files to reflect consolidated architecture:

    1. tests/e2e/mcp_http_stage_test.go (line 65):
       - Change: `helpers.NewPortForwarder(s.T, s.TestCtx.Cluster.GetContext(), mcpNamespace, serviceName, 8082)`
       - To: `helpers.NewPortForwarder(s.T, s.TestCtx.Cluster.GetContext(), mcpNamespace, serviceName, 8080)`

    2. tests/e2e/mcp_failure_scenarios_stage_test.go (line 87):
       - Change: `helpers.NewPortForwarder(s.t, s.testCtx.Cluster.GetContext(), mcpNamespace, serviceName, 8082)`
       - To: `helpers.NewPortForwarder(s.t, s.testCtx.Cluster.GetContext(), mcpNamespace, serviceName, 8080)`

    3. tests/e2e/main_test.go (lines 89-94):
       - Remove the entire MCP config block from Helm values:
       ```go
       "mcp": map[string]interface{}{
           "enabled":  true,
           "httpAddr": ":8082",
       },
       ```
       - Reason: MCP is now integrated on main server port 8080 by default, no separate config needed

    4. tests/e2e/main_test.go (line 107):
       - Update log message from "MCP server (port 8082)" to "MCP server (integrated on port 8080)"

    5. tests/e2e/helpers/shared_setup.go (line 45):
       - Update comment from "with MCP server enabled on port 8082" to "with MCP server integrated on port 8080"

    Why port 8080: Phase 6-8 consolidated MCP into main server. Single port deployment eliminates separate MCP sidecar on 8082.

    Avoid: Do NOT change helpers/portforward.go or helpers/testcontext.go - these are generic utilities that work with any port.
  </action>
  <verify>
    grep -n "8080" /home/moritz/dev/spectre-via-ssh/tests/e2e/mcp_http_stage_test.go /home/moritz/dev/spectre-via-ssh/tests/e2e/mcp_failure_scenarios_stage_test.go /home/moritz/dev/spectre-via-ssh/tests/e2e/main_test.go /home/moritz/dev/spectre-via-ssh/tests/e2e/helpers/shared_setup.go && ! grep -n "8082" /home/moritz/dev/spectre-via-ssh/tests/e2e/*.go /home/moritz/dev/spectre-via-ssh/tests/e2e/helpers/*.go 2>/dev/null
  </verify>
  <done>All test files reference port 8080, no references to port 8082 remain in test suite</done>
</task>

<task type="auto">
  <name>Verify test compilation after updates</name>
  <files>tests/e2e/</files>
  <action>
    Build E2E test binary to verify no compilation errors after endpoint and port updates:

    ```bash
    cd /home/moritz/dev/spectre-via-ssh
    go test -c ./tests/e2e -o /tmp/e2e-test-binary
    ```

    Expected: Clean compilation with no errors. Binary creation confirms all imports, references, and syntax are correct.

    If compilation fails: Review error messages, likely missed reference or syntax error in port/endpoint updates.
  </action>
  <verify>cd /home/moritz/dev/spectre-via-ssh && go test -c ./tests/e2e -o /tmp/e2e-test-binary && echo "Compilation successful" && rm /tmp/e2e-test-binary</verify>
  <done>E2E test suite compiles successfully with updated endpoint and port configuration</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Endpoint verification:**
   ```bash
   grep -r "BaseURL.*\"/mcp\"" tests/e2e/
   # Should return NO results (all should be /v1/mcp)

   grep -r "BaseURL.*\"/v1/mcp\"" tests/e2e/
   # Should find mcp_client.go line with /v1/mcp
   ```

2. **Port verification:**
   ```bash
   grep -r "8082" tests/e2e/
   # Should return NO results

   grep -r "NewPortForwarder.*8080" tests/e2e/
   # Should find both HTTP and failure scenario tests
   ```

3. **Compilation verification:**
   ```bash
   go test -c ./tests/e2e
   # Should succeed without errors
   ```

4. **Configuration verification:**
   ```bash
   grep -A5 '"mcp":' tests/e2e/main_test.go
   # Should return NO results (MCP config removed)
   ```
</verification>

<success_criteria>
Plan complete when:
- [ ] mcp_client.go sends requests to /v1/mcp endpoint (not /mcp)
- [ ] mcp_http_stage_test.go port-forwards to port 8080 (not 8082)
- [ ] mcp_failure_scenarios_stage_test.go port-forwards to port 8080 (not 8082)
- [ ] main_test.go removes MCP-specific Helm values config
- [ ] main_test.go log message reflects integrated MCP on port 8080
- [ ] shared_setup.go comment reflects port 8080
- [ ] No references to port 8082 remain in test suite
- [ ] Test suite compiles without errors
- [ ] TEST-01 requirement satisfied: MCP HTTP tests connect to main server port 8080 at /v1/mcp
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-test-validation/09-01-SUMMARY.md`
</output>
