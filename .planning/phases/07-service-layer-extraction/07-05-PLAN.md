---
phase: 07-service-layer-extraction
plan: 05
type: execute
wave: 4
depends_on: ["07-01", "07-02", "07-03", "07-04"]
files_modified:
  - internal/mcp/client/client.go
autonomous: true

must_haves:
  truths:
    - "HTTP client code deleted from MCP tools"
    - "No MCP tools make localhost HTTP calls"
    - "All MCP tools use service layer directly"
    - "Server compiles without HTTP client"
  artifacts:
    - path: "internal/mcp/client/client.go"
      provides: "Deleted - HTTP client no longer needed"
      deleted: true
  key_links: []
---

<objective>
Delete HTTP client code now that all MCP tools use service layer directly.

Purpose: Complete service layer migration, remove technical debt
Output: Clean codebase with no HTTP self-calls, HTTP client code removed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-service-layer-extraction/07-CONTEXT.md
@.planning/phases/07-service-layer-extraction/07-RESEARCH.md

# Key files
@internal/mcp/client/client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify no MCP tools use HTTP client</name>
  <files>internal/mcp/tools/*.go</files>
  <action>
Verify all MCP tools have been migrated to service layer:

1. Search for HTTP client imports:
   - Run: grep -r "internal/mcp/client" internal/mcp/tools/
   - Should return zero results (all tools migrated in Plans 01-02)

2. Search for HTTP client usage:
   - Run: grep -r "client.Query\|client.Detect\|client.Ping" internal/mcp/tools/
   - Should return zero results

3. Verify service layer usage:
   - Run: grep -r "timelineService\|graphService" internal/mcp/tools/
   - Should find service references in resource_timeline, cluster_health, causal_paths, detect_anomalies

4. Document findings:
   - If any HTTP client usage found, identify which tool and which operation
   - If clean, proceed to deletion

Expected: All MCP tools now use TimelineService or GraphService from Plans 01-02.
  </action>
  <verify>
grep -r "internal/mcp/client" internal/mcp/tools/ | wc -l | grep -q "^0$"
grep -r "client.Query\|client.Detect\|client.Ping" internal/mcp/tools/ | wc -l | grep -q "^0$"
  </verify>
  <done>All MCP tools verified to use service layer, no HTTP client usage found</done>
</task>

<task type="auto">
  <name>Task 2: Delete HTTP client implementation</name>
  <files>internal/mcp/client/client.go</files>
  <action>
Delete the HTTP client code that is no longer used:

1. Remove client implementation:
   - Delete internal/mcp/client/client.go
   - This file contains Client struct with QueryTimeline, DetectAnomalies, QueryCausalPaths, Ping methods

2. Remove client directory if empty:
   - After deleting client.go, check if internal/mcp/client/ is empty
   - If empty, remove directory: rmdir internal/mcp/client/

3. Verify no imports of deleted package:
   - Run: grep -r "github.com/moolen/spectre/internal/mcp/client" . --include="*.go"
   - Should return zero results (or only in deleted files)

4. Verify server compiles:
   - Run: go build ./cmd/spectre
   - Should compile successfully without HTTP client

Rationale: HTTP client was used for MCP tools to call localhost REST endpoints. Now that tools use service layer directly, client is technical debt.
  </action>
  <verify>
test ! -f internal/mcp/client/client.go
go build -v ./cmd/spectre
grep -r "github.com/moolen/spectre/internal/mcp/client" . --include="*.go" | wc -l | grep -q "^0$"
  </verify>
  <done>HTTP client deleted, no references remain, server compiles successfully</done>
</task>

<task type="auto">
  <name>Task 3: Update documentation references</name>
  <files>README.md, docs/*.md (if any)</files>
  <action>
Check for and update any documentation mentioning HTTP client:

1. Search documentation for HTTP client references:
   - Run: grep -r "mcp/client\|HTTP client\|localhost.*8080" README.md docs/ 2>/dev/null || true
   - Identify any references to MCP HTTP self-calls

2. Update documentation if needed:
   - Replace references to "MCP tools call HTTP endpoints" with "MCP tools use service layer"
   - Update architecture diagrams if they show HTTP calls from MCP to REST

3. If no documentation references found:
   - Log that documentation is clean
   - No updates needed

Note: Most project documentation is in .planning/ which doesn't need updates here. Focus on user-facing docs.
  </action>
  <verify>
echo "Documentation check complete"
  </verify>
  <done>Documentation updated (if needed) to reflect service layer architecture</done>
</task>

</tasks>

<verification>
# Overall phase checks
1. No HTTP client code exists: `test ! -f internal/mcp/client/client.go`
2. No imports of HTTP client: `grep -r "internal/mcp/client" . --include="*.go" | wc -l` returns 0
3. All MCP tools compile: `go build ./internal/mcp/tools/...`
4. Server compiles: `go build ./cmd/spectre`
5. MCP tools use services: `grep -r "timelineService\|graphService" internal/mcp/tools/ | wc -l` returns >0
</verification>

<success_criteria>
1. internal/mcp/client/client.go deleted
2. No MCP tools import internal/mcp/client package
3. All MCP tools use TimelineService or GraphService
4. Server compiles successfully
5. No localhost HTTP calls from MCP tools
</success_criteria>

<output>
After completion, create `.planning/phases/07-service-layer-extraction/07-05-SUMMARY.md`
</output>
