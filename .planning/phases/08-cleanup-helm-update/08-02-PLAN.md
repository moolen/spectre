---
phase: 08-cleanup-helm-update
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - chart/templates/deployment.yaml
  - chart/templates/service.yaml
  - chart/templates/ingress.yaml
  - chart/values.yaml
  - tests/e2e/fixtures/helm-values-test.yaml
autonomous: true

must_haves:
  truths:
    - "Helm chart deploys single Spectre container (no MCP sidecar)"
    - "Service exposes only main port 8080 (no separate MCP port 8082)"
    - "Ingress routes /v1/mcp through main service (no separate MCP ingress)"
    - "values.yaml has no mcp.enabled, mcp.port, or mcp sidecar configuration"
    - "Test fixture deploys single-container architecture"
  artifacts:
    - path: "chart/templates/deployment.yaml"
      provides: "Deployment with single Spectre container"
      not_contains: "{{- if .Values.mcp.enabled }}"
      not_contains: "name: mcp"
    - path: "chart/templates/service.yaml"
      provides: "Service exposing only port 8080"
      not_contains: ".Values.mcp.port"
      not_contains: "name: mcp"
    - path: "chart/templates/ingress.yaml"
      provides: "Ingress with no MCP-specific routing"
      not_contains: ".Values.ingress.mcp"
      not_contains: ".Values.mcp.port"
    - path: "chart/values.yaml"
      provides: "Values with no MCP sidecar configuration"
      not_contains: "mcp:"
      not_contains: "8082"
      contains: "8080: HTTP REST API with gRPC-Web support, MCP at /v1/mcp"
    - path: "tests/e2e/fixtures/helm-values-test.yaml"
      provides: "Test values with no MCP sidecar"
      not_contains: "mcp:"
  key_links:
    - from: "chart/templates/deployment.yaml"
      to: "chart/values.yaml"
      via: ".Values.mcp.enabled conditional"
      pattern: "\\.Values\\.mcp\\.enabled"
      required_state: "removed from both files"
    - from: "chart/templates/service.yaml"
      to: "chart/values.yaml"
      via: ".Values.mcp.port reference"
      pattern: "\\.Values\\.mcp\\.port"
      required_state: "removed from both files"
    - from: "chart/templates/ingress.yaml"
      to: "chart/values.yaml"
      via: ".Values.ingress.mcp reference"
      pattern: "\\.Values\\.ingress\\.mcp"
      required_state: "removed from ingress, section never existed in values"
---

<objective>
Update Helm chart to deploy single Spectre container with integrated MCP server. Remove MCP sidecar container, MCP-specific ports, and MCP sidecar configuration values.

Purpose: Align Helm chart with Phase 6 consolidated server architecture. After Phase 6, MCP runs in-process on port 8080 at /v1/mcp path. Separate MCP container, port 8082, and sidecar configuration are obsolete.

Output: Helm chart that deploys single-container Spectre pods with MCP accessible at /v1/mcp on main service port 8080.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-cleanup-helm-update/08-CONTEXT.md
@.planning/phases/08-cleanup-helm-update/08-RESEARCH.md

@chart/templates/deployment.yaml
@chart/templates/service.yaml
@chart/templates/ingress.yaml
@chart/values.yaml
@tests/e2e/fixtures/helm-values-test.yaml
</context>

<tasks>

<task type="auto">
  <name>Remove MCP sidecar from deployment and service templates</name>
  <files>
    chart/templates/deployment.yaml
    chart/templates/service.yaml
  </files>
  <action>
**File: chart/templates/deployment.yaml**

Delete lines 158-206 completely (entire MCP container block):
```yaml
      {{- if .Values.mcp.enabled }}
      - name: mcp
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        # ... [entire MCP container definition including ports, command, env, probes, resources]
      {{- end }}
```

This removes:
- MCP container definition
- MCP port 8082 exposure
- MCP container command (spectre mcp)
- MCP environment variables (SPECTRE_URL, MCP_HTTP_ADDR)
- MCP probes (liveness, readiness)
- MCP resource limits

After deletion, the containers section should only contain the main Spectre container and optionally the FalkorDB sidecar (if graph.enabled).

**File: chart/templates/service.yaml**

Delete lines 39-44 (MCP port exposure):
```yaml
    {{- if .Values.mcp.enabled }}
    - port: {{ .Values.mcp.port }}
      targetPort: mcp
      protocol: TCP
      name: mcp
    {{- end }}
```

After deletion, the ports section should contain:
- port 8080 (http) - main service
- port 9999 (pprof) - if pprof.enabled
  </action>
  <verify>
Check template files no longer reference MCP sidecar:
```bash
# Should return no matches
grep -n "\.Values\.mcp\." chart/templates/deployment.yaml
grep -n "\.Values\.mcp\." chart/templates/service.yaml

# Verify MCP container block removed
grep -n "name: mcp" chart/templates/deployment.yaml
grep -n "targetPort: mcp" chart/templates/service.yaml

# Verify main container still present
grep -n "name: {{ include \"spectre.fullname\" . }}" chart/templates/deployment.yaml | head -1
```
  </verify>
  <done>
- MCP sidecar container removed from deployment.yaml (lines 158-206 deleted)
- MCP port removed from service.yaml (lines 39-44 deleted)
- No .Values.mcp references in deployment or service templates
- Main Spectre container remains intact
  </done>
</task>

<task type="auto">
  <name>Remove MCP-specific ingress and update values.yaml</name>
  <files>
    chart/templates/ingress.yaml
    chart/values.yaml
  </files>
  <action>
**File: chart/templates/ingress.yaml**

Remove MCP-specific ingress logic:

1. Line 1: Change condition from:
   ```yaml
   {{- if or .Values.ingress.enabled (and .Values.mcp.enabled .Values.ingress.mcp.enabled) -}}
   ```
   To:
   ```yaml
   {{- if .Values.ingress.enabled -}}
   ```

2. Lines 17-18, 28-36: Remove MCP TLS section references:
   - Delete: `(and .Values.mcp.enabled .Values.ingress.mcp.enabled .Values.ingress.mcp.tls)` from line 17 condition
   - Delete entire block lines 28-36:
     ```yaml
         {{- if and .Values.mcp.enabled .Values.ingress.mcp.enabled .Values.ingress.mcp.tls }}
         {{- range .Values.ingress.mcp.tls }}
         - hosts:
             {{- range .hosts }}
             - {{ . | quote }}
             {{- end }}
           secretName: {{ .secretName }}
         {{- end }}
         {{- end }}
     ```

3. Lines 55-68: Delete entire MCP ingress rules section:
   ```yaml
       {{- if and .Values.mcp.enabled .Values.ingress.mcp.enabled }}
       - host: {{ .Values.ingress.mcp.host | quote }}
         http:
           paths:
             {{- range .Values.ingress.mcp.paths }}
             - path: {{ .path }}
               pathType: {{ .pathType }}
               backend:
                 service:
                   name: {{ include "spectre.fullname" $ }}
                   port:
                     number: {{ $.Values.mcp.port }}
             {{- end }}
       {{- end }}
   ```

After these changes, ingress.yaml should only handle main Spectre service ingress. MCP endpoint (/v1/mcp) is accessible through main service port 8080, no special ingress routing needed.

**File: chart/values.yaml**

1. Lines 30-34: Update port allocation comment:
   ```yaml
   # Service configuration
   # Port allocation:
   #   - 8080: HTTP REST API with gRPC-Web support, MCP at /v1/mcp (main service)
   #   - 9999: pprof profiling endpoint
   ```
   Remove line: `#   - 8082: MCP HTTP server (sidecar)`

2. Lines 57-105: Delete entire mcp: section (49 lines):
   ```yaml
   # MCP (Model Context Protocol) sidecar configuration
   mcp:
     enabled: true
     spectreURL: "http://localhost:8080"
     httpAddr: ":8082"
     port: 8082
     resources:
       # ... all MCP sidecar config
     livenessProbe:
       # ...
     readinessProbe:
       # ...
   ```

After deletion, values.yaml proceeds directly from pprof section (line ~50) to graph section (line ~107).
  </action>
  <verify>
Check ingress and values.yaml changes:
```bash
# Ingress should have no MCP references
grep -n "\.Values\.mcp" chart/templates/ingress.yaml
grep -n "\.Values\.ingress\.mcp" chart/templates/ingress.yaml

# values.yaml should have no mcp: section
grep -n "^mcp:" chart/values.yaml

# values.yaml should mention MCP in port comment
grep -n "MCP at /v1/mcp" chart/values.yaml

# Verify 8082 references removed (except possibly in historical comments if any)
grep -n "8082" chart/values.yaml
```
  </verify>
  <done>
- MCP-specific ingress conditionals and rules removed from ingress.yaml
- Ingress simplified to handle only .Values.ingress.enabled
- mcp: section (lines 57-105) deleted from values.yaml
- Port comment updated to show MCP at /v1/mcp on port 8080
- No references to port 8082 in values.yaml
  </done>
</task>

<task type="auto">
  <name>Update test fixture and verify Helm rendering</name>
  <files>tests/e2e/fixtures/helm-values-test.yaml</files>
  <action>
**File: tests/e2e/fixtures/helm-values-test.yaml**

Delete lines 146-154 (MCP sidecar configuration for CI):
```yaml
# Reduced MCP sidecar resources for CI
mcp:
  enabled: true
  resources:
    requests:
      memory: "32Mi"
      cpu: "25m"
    limits:
      memory: "128Mi"
```

After deletion, line 145 (memory: "512Mi") should be followed immediately by line 155 (service: section).

**Helm Template Verification:**

After updating files, verify Helm chart renders correctly:

1. Test with default values:
   ```bash
   cd /home/moritz/dev/spectre-via-ssh
   helm template spectre chart/ --values chart/values.yaml > /tmp/spectre-default-render.yaml
   ```

2. Verify rendered output:
   - Single container named after release (not "mcp")
   - Service exposes only port 8080 (and 9999 if pprof enabled)
   - Ingress has no MCP-specific rules
   - No references to port 8082

3. Test with test fixture values:
   ```bash
   helm template spectre chart/ --values tests/e2e/fixtures/helm-values-test.yaml > /tmp/spectre-test-render.yaml
   ```

4. Verify test fixture render:
   - No MCP container in deployment
   - Graph FalkorDB sidecar still present (graph.enabled: true in test fixture)
   - Main container has all expected configuration

5. Check for rendering errors:
   ```bash
   helm lint chart/
   ```

Should show no errors or warnings related to missing .Values.mcp references.
  </action>
  <verify>
```bash
# Test fixture should have no mcp: section
grep -n "^mcp:" tests/e2e/fixtures/helm-values-test.yaml

# Helm template rendering should succeed
helm template spectre chart/ --values chart/values.yaml --debug 2>&1 | grep -i error

# Rendered deployment should have single Spectre container (plus FalkorDB if graph enabled)
helm template spectre chart/ --values chart/values.yaml | grep -A 5 "kind: Deployment" | grep "name:" | grep -v "{{ include"

# Rendered service should expose only port 8080 (and 9999 pprof)
helm template spectre chart/ --values chart/values.yaml | grep -A 20 "kind: Service" | grep "port:" | grep -v "#"

# helm lint should pass
helm lint chart/
```
  </verify>
  <done>
- mcp: section removed from helm-values-test.yaml (lines 146-154)
- helm template renders successfully with updated chart
- Rendered deployment contains single Spectre container (no MCP sidecar)
- Rendered service exposes only port 8080 and optional pprof port
- helm lint passes with no errors
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Template file verification:
   - deployment.yaml has no MCP container block
   - service.yaml has no MCP port
   - ingress.yaml has no MCP-specific routing
   - All .Values.mcp references removed

2. Values file verification:
   - chart/values.yaml has no mcp: section
   - Port comment updated to show MCP at /v1/mcp on port 8080
   - No references to port 8082

3. Test fixture verification:
   - helm-values-test.yaml has no mcp: section
   - Test deployments will use single-container architecture

4. Helm functionality verification:
   - helm template renders without errors
   - helm lint passes
   - Rendered manifests show single-container deployment
   - Service exposes only main port (8080) and optional pprof port (9999)
</verification>

<success_criteria>
- Helm chart deploys single Spectre container (no MCP sidecar)
- values.yaml removes mcp.enabled, mcp.port, mcp.resources, and all MCP sidecar config
- Service exposes MCP at /v1/mcp path on main port 8080
- Test fixture updated for single-container architecture
- Satisfies requirements: HELM-01, HELM-02, HELM-03, HELM-04
</success_criteria>

<output>
After completion, create `.planning/phases/08-cleanup-helm-update/08-02-SUMMARY.md`
</output>
