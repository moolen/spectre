---
phase: 08-cleanup-helm-update
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/spectre/commands/root.go
  - cmd/spectre/commands/mcp.go
  - cmd/spectre/commands/mcp_health_test.go
  - cmd/spectre/commands/agent.go
  - cmd/spectre/commands/mock.go
  - internal/agent/
autonomous: true

must_haves:
  truths:
    - "spectre mcp command no longer exists in CLI"
    - "spectre agent command no longer exists in CLI"
    - "spectre mock command no longer exists in CLI"
    - "internal/agent package no longer exists in codebase"
    - "spectre binary builds successfully without deleted code"
  artifacts:
    - path: "cmd/spectre/commands/root.go"
      provides: "Root command with only server and debug subcommands"
      contains: "rootCmd.AddCommand(serverCmd)"
      not_contains: "rootCmd.AddCommand(mcpCmd)"
    - path: "cmd/spectre/commands/mcp.go"
      provides: "Deleted - standalone MCP command removed"
      exists: false
    - path: "cmd/spectre/commands/agent.go"
      provides: "Deleted - agent command removed"
      exists: false
    - path: "cmd/spectre/commands/mock.go"
      provides: "Deleted - mock command removed"
      exists: false
    - path: "internal/agent/"
      provides: "Deleted - entire agent package removed"
      exists: false
  key_links:
    - from: "cmd/spectre/commands/root.go"
      to: "cmd/spectre/commands/mcp.go"
      via: "AddCommand registration"
      pattern: "rootCmd\\.AddCommand\\(mcpCmd\\)"
      required_state: "removed"
    - from: "cmd/spectre/commands/mock.go"
      to: "internal/agent/"
      via: "import statement"
      pattern: "github.com/moolen/spectre/internal/agent"
      required_state: "both deleted"
---

<objective>
Remove standalone MCP command, agent command, mock command, and entire internal/agent package from codebase.

Purpose: Clean up dead code from MCP sidecar architecture. Standalone commands were disabled in Phase 7 when HTTP client was removed. Now that consolidated server (spectre server) handles all MCP functionality, these commands and the agent package are no longer needed.

Output: Codebase with only `spectre server` and `spectre debug` commands, no internal/agent package, successful build verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-cleanup-helm-update/08-CONTEXT.md
@.planning/phases/08-cleanup-helm-update/08-RESEARCH.md

@cmd/spectre/commands/root.go
@cmd/spectre/commands/mcp.go
@cmd/spectre/commands/agent.go
@cmd/spectre/commands/mock.go
</context>

<tasks>

<task type="auto">
  <name>Delete standalone command files and agent package</name>
  <files>
    cmd/spectre/commands/mcp.go
    cmd/spectre/commands/mcp_health_test.go
    cmd/spectre/commands/agent.go
    cmd/spectre/commands/mock.go
    internal/agent/
  </files>
  <action>
Delete the following files completely:
- cmd/spectre/commands/mcp.go (standalone MCP server command, disabled in Phase 7)
- cmd/spectre/commands/mcp_health_test.go (test for deleted MCP command)
- cmd/spectre/commands/agent.go (interactive AI agent command, disabled in Phase 7)
- cmd/spectre/commands/mock.go (mock LLM command, imports agent package, has //go:build disabled tag)

Delete the entire internal/agent/ directory and all subdirectories:
- internal/agent/audit/
- internal/agent/commands/
- internal/agent/incident/
- internal/agent/model/
- internal/agent/multiagent/
- internal/agent/provider/
- internal/agent/runner/
- internal/agent/tools/
- internal/agent/tui/

All files in internal/agent/ have //go:build disabled tags. The package is build-excluded and only imported by the mock.go command being deleted. Safe for complete removal.

Use rm -rf for directory deletion. No need to preserve build tags or add TODO comments - clean deletion per user requirements.
  </action>
  <verify>
Confirm files deleted:
```bash
# These should return "No such file or directory"
ls cmd/spectre/commands/mcp.go 2>&1
ls cmd/spectre/commands/mcp_health_test.go 2>&1
ls cmd/spectre/commands/agent.go 2>&1
ls cmd/spectre/commands/mock.go 2>&1
ls internal/agent/ 2>&1

# These should still exist
ls cmd/spectre/commands/server.go
ls cmd/spectre/commands/debug.go
```
  </verify>
  <done>
- mcp.go, mcp_health_test.go, agent.go, mock.go deleted from cmd/spectre/commands/
- internal/agent/ directory completely removed
- Verification shows files no longer exist
  </done>
</task>

<task type="auto">
  <name>Remove command registrations from root.go</name>
  <files>cmd/spectre/commands/root.go</files>
  <action>
Edit cmd/spectre/commands/root.go to remove command registrations:

In the init() function (currently lines 38-42):
- Remove line: `rootCmd.AddCommand(mcpCmd)`

Keep only:
```go
func init() {
	// Global flags available to all subcommands
	// Supports per-package log levels: --log-level debug --log-level graph.sync=debug
	rootCmd.PersistentFlags().StringSliceVar(&logLevelFlags, "log-level",
		[]string{"info"},
		"Log level for packages. Use 'default=level' for default, or 'package.name=level' for per-package.\n"+
			"Examples: --log-level debug (all), --log-level graph.sync=debug --log-level controller=warn")

	// Add subcommands
	rootCmd.AddCommand(serverCmd)
	rootCmd.AddCommand(debugCmd)
}
```

Note: agentCmd and mockCmd registrations are already in their respective deleted files (agent.go:53, mock.go:42), not in root.go. Only mcpCmd is registered in root.go and needs removal.

Do NOT modify anything else in root.go - keep all other functions, imports, and logic unchanged.
  </action>
  <verify>
Verify root.go changes:
```bash
# Should NOT contain mcpCmd reference
grep -n "mcpCmd" cmd/spectre/commands/root.go

# Should contain only serverCmd and debugCmd
grep -n "AddCommand" cmd/spectre/commands/root.go
```
  </verify>
  <done>
- mcpCmd registration removed from root.go init() function
- Only serverCmd and debugCmd remain registered
- No mcpCmd references in root.go
  </done>
</task>

<task type="auto">
  <name>Verify Go build succeeds</name>
  <files>N/A</files>
  <action>
Build the spectre binary to verify all imports resolve and no compilation errors exist:

```bash
cd /home/moritz/dev/spectre-via-ssh
go build -o spectre ./cmd/spectre
```

If build succeeds, verify available commands:
```bash
./spectre --help
```

Confirm output shows only:
- server (main command)
- debug (debugging utilities)

And does NOT show:
- mcp (deleted)
- agent (deleted)
- mock (deleted)

Test that Cobra's unknown command handling works:
```bash
./spectre mcp 2>&1 || true
```

Should output: "Error: unknown command "mcp" for "spectre""
  </action>
  <verify>
```bash
# Build should succeed with exit code 0
go build -o spectre ./cmd/spectre
echo "Build exit code: $?"

# Binary should show only server and debug commands
./spectre --help | grep -E "Available Commands:" -A 5

# Unknown command handling should work
./spectre mcp 2>&1 | grep "unknown command"
```
  </verify>
  <done>
- Go build completes successfully
- spectre --help shows only server and debug commands
- spectre mcp produces "unknown command" error from Cobra
- No compilation errors or missing imports
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. File deletion verification:
   - mcp.go, agent.go, mock.go, mcp_health_test.go do not exist
   - internal/agent/ directory does not exist
   - server.go and debug.go still exist

2. Build verification:
   - `go build ./cmd/spectre` succeeds
   - Binary produces only server and debug in --help output
   - `spectre mcp` produces "unknown command" error

3. Code cleanliness:
   - root.go contains no references to mcpCmd
   - No TODO comments or deprecation stubs added
   - Clean deletion with no traces (per Phase 8 context decisions)
</verification>

<success_criteria>
- Standalone mcp command no longer accessible via CLI
- Agent and mock commands removed
- internal/agent package completely deleted
- spectre binary builds without errors
- Only server and debug commands available
- Cobra handles unknown commands automatically
- Satisfies requirements: SRVR-05 (remove standalone mcp command)
</success_criteria>

<output>
After completion, create `.planning/phases/08-cleanup-helm-update/08-01-SUMMARY.md`
</output>
