---
phase: 19-anomaly-detection
plan: 04
type: execute
wave: 4
depends_on: ["19-01", "19-02", "19-03"]
files_modified:
  - internal/integration/grafana/grafana.go
  - internal/integration/grafana/anomaly_service_test.go
autonomous: false

must_haves:
  truths:
    - "AnomalyService is instantiated with all dependencies"
    - "OverviewTool receives AnomalyService on construction"
    - "Integration tests validate anomaly detection flow"
    - "Tool registration includes updated Overview tool"
  artifacts:
    - path: "internal/integration/grafana/grafana.go"
      provides: "Wiring of anomaly service and tool dependencies"
      contains: "NewAnomalyService"
      min_lines: 250
    - path: "internal/integration/grafana/anomaly_service_test.go"
      provides: "Integration tests for anomaly detection"
      contains: "TestDetectAnomalies"
      min_lines: 80
  key_links:
    - from: "internal/integration/grafana/grafana.go"
      to: "anomaly_service.go"
      via: "NewAnomalyService constructor call"
      pattern: "NewAnomalyService"
    - from: "internal/integration/grafana/grafana.go"
      to: "tools_metrics_overview.go"
      via: "Pass anomalyService to NewOverviewTool"
      pattern: "NewOverviewTool.*anomalyService"
---

<objective>
Wire anomaly service into integration lifecycle, create integration tests, and verify end-to-end anomaly detection.

Purpose: Complete the integration of anomaly detection into MCP tools with automated and human verification.
Output: Fully wired anomaly service, integration tests, verified tool behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-anomaly-detection/19-CONTEXT.md
@.planning/phases/19-anomaly-detection/19-RESEARCH.md
@.planning/phases/19-anomaly-detection/19-01-SUMMARY.md
@.planning/phases/19-anomaly-detection/19-02-SUMMARY.md
@.planning/phases/19-anomaly-detection/19-03-SUMMARY.md
@.planning/phases/18-query-execution-mcp-tools/18-03-SUMMARY.md
@internal/integration/grafana/grafana.go
</context>

<tasks>

<task type="auto">
  <name>Wire anomaly service into integration lifecycle</name>
  <files>internal/integration/grafana/grafana.go</files>
  <action>
Update GrafanaIntegration to instantiate and wire anomaly detection components.

**Changes to GrafanaIntegration struct:**
Add fields (if not present):
```go
type GrafanaIntegration struct {
    // ... existing fields ...
    queryService  *GrafanaQueryService
    detector      *StatisticalDetector
    baselineCache *BaselineCache
    anomalyService *AnomalyService
}
```

**Changes to NewGrafanaIntegration or Start method:**
1. After creating queryService (existing code from Phase 18):
   - Create StatisticalDetector: `detector := NewStatisticalDetector(logger)`
   - Create BaselineCache: `baselineCache := NewBaselineCache(graphClient, logger)`
   - Create AnomalyService: `anomalyService := NewAnomalyService(queryService, detector, baselineCache, logger)`
   - Store in integration struct

2. Update OverviewTool construction:
   - Find existing `NewOverviewTool` call
   - Add anomalyService parameter
   - Update: `overviewTool := NewOverviewTool(queryService, graphClient, anomalyService, logger)`

3. Verify other tool registrations unchanged (AggregatedTool, DetailsTool don't need anomaly service)

**Dependency order:**
- Graph client and logger already exist
- Query service already created (Phase 18)
- Detector has no dependencies (just logger)
- BaselineCache needs graph client
- AnomalyService needs queryService, detector, baselineCache
- OverviewTool needs queryService, graphClient, anomalyService

**Conditional logic (if applicable):**
- If queryService is nil (integration requires Grafana connection), anomalyService should also be nil
- Tools should handle nil anomalyService gracefully (already implemented in 19-03)

**Follow existing patterns:**
- Integration lifecycle follows Start/Stop methods from `internal/integration/interface.go`
- Tool registration follows `internal/mcp/tools/` pattern
- Logger component naming: `logger.With("component", "anomaly_service")`
  </action>
  <verify>
Build and check wiring:
```bash
go build ./internal/integration/grafana/...
grep "NewStatisticalDetector" internal/integration/grafana/grafana.go
grep "NewBaselineCache" internal/integration/grafana/grafana.go
grep "NewAnomalyService" internal/integration/grafana/grafana.go
grep "anomalyService" internal/integration/grafana/grafana.go | grep "NewOverviewTool"
```
  </verify>
  <done>
AnomalyService, StatisticalDetector, and BaselineCache instantiated in integration lifecycle, OverviewTool receives anomalyService parameter, all components wired with proper dependency order, compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Create integration tests for anomaly detection</name>
  <files>internal/integration/grafana/anomaly_service_test.go</files>
  <action>
Create integration test validating anomaly detection flow with mock data.

**Test: TestDetectAnomaliesBasic**
- Setup:
  - Create mock baseline with mean=100, stddev=10
  - Create mock current metric value=130 (z-score=3.0)
  - Mock queryService to return dashboard with single panel, single metric
  - Create real StatisticalDetector
  - Create mock BaselineCache that returns predefined baseline
- Execute:
  - Call anomalyService.DetectAnomalies with test dashboard UID, time range
- Assert:
  - Result contains 1 anomaly
  - Anomaly has correct metric name
  - Anomaly z-score ≈ 3.0
  - Anomaly severity = "critical"

**Test: TestDetectAnomaliesNoAnomalies**
- Setup:
  - Create mock baseline with mean=100, stddev=10
  - Create mock current metric value=102 (z-score=0.2, within normal)
- Execute:
  - Call anomalyService.DetectAnomalies
- Assert:
  - Result.Anomalies is empty
  - MetricsChecked > 0
  - SkipCount = 0

**Test: TestDetectAnomaliesInsufficientHistory**
- Setup:
  - Mock queryService to return only 2 historical data points (< minimum 3)
- Execute:
  - Call anomalyService.DetectAnomalies
- Assert:
  - Metric is silently skipped (not in anomalies)
  - SkipCount incremented

**Test structure:**
Follow existing test patterns from `dashboard_syncer_test.go` or `graph_builder_test.go`:
- Use testify/assert for assertions (if available in codebase)
- OR use standard Go testing with manual comparisons
- Table-driven tests for multiple scenarios
- Clean setup/teardown

**Mock strategy:**
- Mock queryService interface (return predefined DashboardQueryResult)
- Mock baselineCache interface (return predefined Baseline)
- Use real StatisticalDetector (no mocking needed, pure functions)

**Edge cases to cover:**
- Empty dashboard (no panels)
- Query errors (fail fast, skip metric)
- Zero stddev baseline (avoid division by zero)
  </action>
  <verify>
Run tests:
```bash
go test -v ./internal/integration/grafana/... -run TestDetectAnomalies
```
  </verify>
  <done>
Integration tests exist for anomaly detection, cover basic detection, no anomalies, insufficient history, tests pass, validate z-score computation and severity classification.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete anomaly detection system integrated into Grafana Overview MCP tool:
- Statistical detector with z-score computation (TDD)
- Graph-backed baseline cache with TTL
- Anomaly service orchestrating detection flow
- Updated Overview tool returning ranked anomalies with severity
  </what-built>
  <how-to-verify>
**1. Verify compilation:**
```bash
cd /home/moritz/dev/spectre-via-ssh
go build ./internal/integration/grafana/...
```
Expected: No errors

**2. Run unit tests:**
```bash
go test ./internal/integration/grafana/... -v
```
Expected: All tests pass, including TDD tests for statistical detector and integration tests for anomaly service

**3. Check wiring in integration:**
```bash
grep -A 5 "NewAnomalyService" internal/integration/grafana/grafana.go
grep -A 3 "NewOverviewTool.*anomaly" internal/integration/grafana/grafana.go
```
Expected: AnomalyService instantiated with queryService, detector, baselineCache; passed to OverviewTool

**4. Verify Overview tool integration:**
```bash
grep "anomalyService.DetectAnomalies" internal/integration/grafana/tools_metrics_overview.go
```
Expected: DetectAnomalies called in Overview tool's Call method

**5. Check requirements coverage:**
- ANOM-01: 7-day baseline → `grep "7.*24.*time.Hour\|168" internal/integration/grafana/anomaly_service.go`
- ANOM-02: Time-of-day matching → `grep "matchTimeWindows\|windowHour\|dayType" internal/integration/grafana/anomaly_service.go`
- ANOM-03: Z-score comparison → `grep "computeZScore" internal/integration/grafana/statistical_detector.go`
- ANOM-04: Severity classification → `grep "classifySeverity\|critical\|warning\|info" internal/integration/grafana/statistical_detector.go`
- ANOM-05: Baseline cache with TTL → `grep "expires_at\|TTL" internal/integration/grafana/baseline_cache.go`
- ANOM-06: Graceful handling → `grep "skipCount\|SkipCount" internal/integration/grafana/anomaly_service.go`
- TOOL-02: Overview detects anomalies → `grep "anomalyService" internal/integration/grafana/tools_metrics_overview.go`
- TOOL-03: Ranked anomalies with severity → `grep "severity\|Severity" internal/integration/grafana/tools_metrics_overview.go`

**6. Code quality checks:**
- Files created: statistical_detector.go, baseline.go, statistical_detector_test.go, baseline_cache.go, anomaly_service.go, anomaly_service_test.go
- Files modified: grafana.go, tools_metrics_overview.go
- Total lines added: ~800-1000 LOC

**7. If Spectre server is running with Grafana integration:**
Test anomaly detection via MCP tool (optional, requires live Grafana):
- Call `grafana_{name}_metrics_overview` with valid time range and cluster/region
- Verify response includes "anomalies" array with severity field
- Check summary stats: metrics_checked, anomalies_found, metrics_skipped
  </how-to-verify>
  <resume-signal>
Type "approved" if all verifications pass, or describe any issues found for remediation.
  </resume-signal>
</task>

</tasks>

<verification>
Automated verification:
```bash
# Full test suite
go test ./internal/integration/grafana/... -v -cover

# Integration lifecycle
go build ./cmd/spectre

# Verify no regressions in existing tools
go test ./internal/integration/grafana/... -run TestOverviewTool
go test ./internal/integration/grafana/... -run TestAggregatedTool
go test ./internal/integration/grafana/... -run TestDetailsTool
```
</verification>

<success_criteria>
- AnomalyService, StatisticalDetector, BaselineCache wired into integration lifecycle
- OverviewTool receives and uses anomalyService
- Integration tests pass for anomaly detection flow
- All requirements (ANOM-01 through ANOM-06, TOOL-02, TOOL-03) implemented
- No regressions in existing tools (Aggregated, Details)
- Code compiles, tests pass
- Human verification confirms end-to-end functionality
</success_criteria>

<output>
After completion, create `.planning/phases/19-anomaly-detection/19-04-SUMMARY.md`
</output>
