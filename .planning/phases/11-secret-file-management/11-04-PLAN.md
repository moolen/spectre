---
phase: 11-secret-file-management
plan: 04
type: execute
wave: 3
depends_on: ["11-03"]
files_modified:
  - chart/templates/role.yaml
  - chart/templates/rolebinding.yaml
  - chart/values.yaml
autonomous: true

must_haves:
  truths:
    - "Helm chart creates Role granting get/watch/list on secrets in Spectre's namespace"
    - "RoleBinding connects ServiceAccount to Role"
    - "RBAC is namespace-scoped (not ClusterRole) for security"
    - "Role is only created when integrations require secret access"
  artifacts:
    - path: "chart/templates/role.yaml"
      provides: "Namespace-scoped Role for secret access"
      contains: "kind: Role"
    - path: "chart/templates/rolebinding.yaml"
      provides: "RoleBinding for ServiceAccount"
      contains: "kind: RoleBinding"
  key_links:
    - from: "rolebinding.yaml"
      to: "serviceaccount.yaml"
      via: "subjects[].name references ServiceAccount"
      pattern: "serviceAccountName"
    - from: "rolebinding.yaml"
      to: "role.yaml"
      via: "roleRef.name references Role"
      pattern: "roleRef.*Role"
---

<objective>
Add namespace-scoped RBAC (Role + RoleBinding) to Helm chart for Kubernetes Secret access.

Purpose: Grant Spectre ServiceAccount permission to get/watch/list secrets in its namespace, enabling SecretWatcher to fetch and watch integration credentials.

Output: Helm chart with conditional RBAC templates that deploy Role and RoleBinding when integrations use secret-based authentication.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP-v1.2.md
@.planning/STATE.md
@.planning/phases/11-secret-file-management/11-CONTEXT.md
@.planning/phases/11-secret-file-management/11-RESEARCH.md

# Outputs from previous plans
@.planning/phases/11-secret-file-management/11-03-PLAN.md

# Existing Helm chart structure
@chart/values.yaml
@chart/templates/serviceaccount.yaml
@chart/templates/clusterrole.yaml
@chart/templates/clusterrolebinding.yaml
</context>

<tasks>

<task type="auto">
  <name>Create Role template for secret access</name>
  <files>
    chart/templates/role.yaml
  </files>
  <action>
Create namespace-scoped Role for secret access:

**File: chart/templates/role.yaml**
```yaml
{{- if .Values.rbac.secretAccess.enabled }}
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "spectre.fullname" . }}-secret-reader
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "spectre.labels" . | nindent 4 }}
rules:
# Secret access for integration credential management
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "watch", "list"]
{{- end }}
```

**Key design decisions:**
- Namespace-scoped Role (not ClusterRole) for security - only secrets in Spectre's namespace
- Conditional rendering via .Values.rbac.secretAccess.enabled
- Name suffix "-secret-reader" to distinguish from cluster-level permissions
- Uses same label helpers as other templates (include "spectre.labels")
- verbs: get (initial fetch), watch (hot-reload), list (informer cache sync)

**Why namespace-scoped:**
- More secure than ClusterRole (can't read secrets from other namespaces)
- Follows principle of least privilege
- Integrations only need secrets in same namespace (from 11-CONTEXT.md)
- Simplifies RBAC setup (no cluster-admin required)
  </action>
  <verify>
helm template spectre ./chart --set rbac.secretAccess.enabled=true | grep -A 10 "kind: Role"
  </verify>
  <done>
- chart/templates/role.yaml exists
- Role is namespace-scoped (kind: Role, not ClusterRole)
- Rules grant get/watch/list on secrets
- Conditional rendering based on .Values.rbac.secretAccess.enabled
- helm template renders Role correctly
  </done>
</task>

<task type="auto">
  <name>Create RoleBinding template</name>
  <files>
    chart/templates/rolebinding.yaml
  </files>
  <action>
Create RoleBinding to connect ServiceAccount to Role:

**File: chart/templates/rolebinding.yaml**
```yaml
{{- if .Values.rbac.secretAccess.enabled }}
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "spectre.fullname" . }}-secret-reader
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "spectre.labels" . | nindent 4 }}
subjects:
- kind: ServiceAccount
  name: {{ include "spectre.serviceAccountName" . }}
  namespace: {{ .Values.namespace }}
roleRef:
  kind: Role
  name: {{ include "spectre.fullname" . }}-secret-reader
  apiGroup: rbac.authorization.k8s.io
{{- end }}
```

**Key design decisions:**
- Conditional rendering matches role.yaml (same .Values flag)
- subjects[].name uses existing "spectre.serviceAccountName" helper (consistent with deployment)
- roleRef.name matches Role metadata.name from role.yaml
- Same namespace for subject and roleRef (namespace-scoped binding)

**Important notes:**
- ServiceAccount name comes from values.yaml serviceAccount.name or default
- RoleBinding must be in same namespace as ServiceAccount and Role
- roleRef cannot be changed after creation (immutable field)
  </action>
  <verify>
helm template spectre ./chart --set rbac.secretAccess.enabled=true | grep -A 15 "kind: RoleBinding"
  </verify>
  <done>
- chart/templates/rolebinding.yaml exists
- RoleBinding references ServiceAccount via "spectre.serviceAccountName" helper
- RoleBinding references Role with matching name
- Conditional rendering based on .Values.rbac.secretAccess.enabled
- helm template renders RoleBinding correctly
- subject namespace matches .Values.namespace
  </done>
</task>

<task type="auto">
  <name>Add values.yaml configuration for RBAC</name>
  <files>
    chart/values.yaml
  </files>
  <action>
Add RBAC configuration section to values.yaml:

**Find or create rbac section (likely exists for existing ClusterRole):**

If rbac section exists, add secretAccess:
```yaml
rbac:
  # Existing fields (create, annotations, etc.)
  create: true

  # Secret access for integration credential management
  # Enable when integrations use Kubernetes Secrets for API tokens
  secretAccess:
    enabled: true  # Default to enabled for v1.2+ (Logz.io integration)
```

If rbac section doesn't exist, create it:
```yaml
# RBAC configuration
rbac:
  # Create RBAC resources
  create: true

  # Secret access for integration credential management
  # Enable when integrations use Kubernetes Secrets for API tokens
  secretAccess:
    enabled: true  # Default to enabled for v1.2+ (Logz.io integration)
```

**Rationale for enabled: true default:**
- v1.2 milestone introduces secret-based authentication (Logz.io)
- Existing installations without secret-based integrations: no impact (Role created but unused)
- New installations: ready for secret-based integrations out of box
- Can be disabled via --set rbac.secretAccess.enabled=false if not needed

**Alternative (more conservative):** Default to false, require opt-in
- Users must explicitly enable for secret-based integrations
- More secure for existing installations
- More friction for new users

Choose enabled: true default (matches research recommendation: "just work when I rotate secrets").
  </action>
  <verify>
helm template spectre ./chart | grep -A 5 "secretAccess"
cat chart/values.yaml | grep -A 3 "secretAccess"
  </verify>
  <done>
- chart/values.yaml has rbac.secretAccess.enabled field
- Default value is true (enabled by default)
- Comments explain when to enable/disable
- helm template respects the value
  </done>
</task>

</tasks>

<verification>
- [ ] helm template spectre ./chart renders without errors
- [ ] Role exists with get/watch/list verbs on secrets
- [ ] Role is namespace-scoped (kind: Role, not ClusterRole)
- [ ] RoleBinding connects ServiceAccount to Role
- [ ] RoleBinding subject name matches ServiceAccount name
- [ ] values.yaml has rbac.secretAccess.enabled (default true)
- [ ] Conditional rendering works (both enabled=true and enabled=false)
- [ ] Role and RoleBinding use same namespace (.Values.namespace)
</verification>

<success_criteria>
**RBAC configured:**
- Helm chart includes Role template (namespace-scoped)
- Role grants get/watch/list on secrets in Spectre's namespace
- RoleBinding connects ServiceAccount to Role
- values.yaml controls RBAC via rbac.secretAccess.enabled
- Default enabled for v1.2+ (Logz.io integration)
- helm template renders correctly
- Follows Kubernetes RBAC best practices (least privilege, namespace-scoped)
</success_criteria>

<output>
After completion, create `.planning/phases/11-secret-file-management/11-04-SUMMARY.md`
</output>
