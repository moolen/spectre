---
phase: 02-config-management-ui
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - cmd/spectre/commands/server.go
autonomous: false

must_haves:
  truths:
    - "Server starts with --integrations-config flag working"
    - "REST API endpoints accessible at /api/config/integrations"
    - "UI integrations page loads and displays correctly"
    - "User can add new integration via UI"
    - "Config persists to integrations.yaml file"
    - "Server hot-reloads when config changes"
  artifacts:
    - path: "cmd/spectre/commands/server.go"
      provides: "Integration of config handler into server startup"
      contains: "RegisterHandlers.*configPath.*integrationManager"
  key_links:
    - from: "cmd/spectre/commands/server.go"
      to: "internal/api/handlers/register.go"
      via: "RegisterHandlers call with config params"
      pattern: "RegisterHandlers\\("
    - from: "UI /integrations page"
      to: "/api/config/integrations endpoint"
      via: "fetch calls from React components"
      pattern: "fetch.*api/config"
---

<objective>
Wire REST API into server startup and verify end-to-end integration with UI.

Purpose: Connect backend (Plan 02-01) and frontend (Plan 02-02) into working system. Server must pass config path and manager to handler registration. Human verification confirms full flow works.

Output: Running server with functional integration management UI and verified config persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-config-management-ui/02-CONTEXT.md
@.planning/phases/02-config-management-ui/02-RESEARCH.md

# Prior plans in this phase
@.planning/phases/02-config-management-ui/02-01-PLAN.md
@.planning/phases/02-config-management-ui/02-02-PLAN.md

# Phase 1 server integration
@.planning/phases/01-plugin-infrastructure-foundation/01-04-SUMMARY.md

# Server command
@cmd/spectre/commands/server.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate config handler into server startup</name>
  <files>
    cmd/spectre/commands/server.go
  </files>
  <action>
Update cmd/spectre/commands/server.go to pass config handler parameters:

1. Locate RegisterHandlers call (should be in server startup sequence)

2. Update RegisterHandlers call to include new parameters:
   ```go
   handlers.RegisterHandlers(
       router,
       // ... existing parameters (storageExecutor, graphExecutor, etc.)
       *integrationsConfig,     // config path from --integrations-config flag
       integrationManager,      // manager instance from Phase 1
   )
   ```

3. The --integrations-config flag and integrationManager already exist from Phase 1 (01-04-SUMMARY.md confirms server.go integration).

4. Verify parameter order matches RegisterHandlers signature from 02-01 Task 3.

5. No other changes needed - Phase 1 already set up:
   - Manager creation with config path
   - Manager registered as lifecycle component
   - Config watcher initialized

Why this works: RegisterHandlers will now have access to configPath and manager to construct IntegrationConfigHandler. The handler will use the same config file and manager instance that Phase 1 infrastructure uses.
  </action>
  <verify>
go build ./cmd/spectre
Build succeeds with no errors
./spectre server --help
Shows --integrations-config flag in help output
  </verify>
  <done>
RegisterHandlers call in server.go passes configPath and integrationManager parameters. Server builds successfully.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete integration management system: REST API (Plan 02-01) + React UI (Plan 02-02) + server integration (Task 1).

Backend provides CRUD endpoints with atomic config writes and health status enrichment. Frontend provides modal-based add/edit flow with connection testing. Config changes trigger hot-reload via Phase 1 file watcher.
  </what-built>
  <how-to-verify>
**Pre-verification setup:**

1. Create test config file (if not exists):
   ```bash
   cat > integrations.yaml <<EOF
   schema_version: v1
   instances: []
   EOF
   ```

2. Start server with config flag:
   ```bash
   ./spectre server --integrations-config ./integrations.yaml
   ```
   Server should start without errors

3. Open browser to Spectre UI (typically http://localhost:8080 or similar)

**Verification steps:**

**Step 1: Empty state display**
- Navigate to /integrations page
- Expected: See original mock integration tiles (Slack, PagerDuty, Grafana, etc)
- Expected: See "+ Add Integration" button at top right (NOT disabled anymore)

**Step 2: Add integration flow**
- Click "+ Add Integration" button
- Expected: Modal opens with integration form
- Fill in fields:
  - Name: "test-victorialogs"
  - Type: Select "VictoriaLogs" from dropdown
  - Enabled: Check the checkbox (should be default checked)
  - URL: "http://localhost:9428"

**Step 3: Test connection (will fail - VictoriaLogs not running)**
- Click "Test Connection" button
- Expected: Button shows "Testing..." during request
- Expected: Red error message appears (connection refused or timeout)
- This is CORRECT - we're not running VictoriaLogs, just verifying test endpoint works

**Step 4: Save integration**
- Click "Save" button (should work even with failed test)
- Expected: Modal closes
- Expected: Tiles disappear, table appears
- Expected: Table shows one row with:
  - Name: test-victorialogs
  - Type: victorialogs
  - URL: http://localhost:9428
  - Date Added: Today's date
  - Status: Red dot + "Degraded" (connection failed)

**Step 5: Config persistence**
- Check integrations.yaml file:
  ```bash
  cat integrations.yaml
  ```
- Expected: File contains new instance with correct fields
- Expected: schema_version: v1, instances array with one entry

**Step 6: Edit integration**
- Click on table row
- Expected: Modal opens with pre-filled values
- Change URL to: "http://localhost:9429"
- Click "Save"
- Expected: Table updates with new URL

**Step 7: Hot-reload verification**
- Edit integrations.yaml manually (change URL to "http://localhost:9999")
- Wait 1 second (debounce delay)
- Refresh browser page
- Expected: Table shows updated URL from file
- This confirms Phase 1 hot-reload wiring works

**Step 8: Delete integration**
- Click on table row to open edit modal
- Look for Delete button (if not implemented, skip this step)
- OR manually edit integrations.yaml to remove instance
- Expected: Table becomes empty, tiles reappear

**Expected behavior summary:**
- ✅ Modal opens/closes correctly
- ✅ Form validation works (required fields)
- ✅ Test connection endpoint responds (fail is OK)
- ✅ Save creates/updates config file atomically
- ✅ Table displays integrations with status
- ✅ File watcher triggers UI update on manual file edit
- ✅ Empty state ↔ table state transitions work

**Known acceptable behaviors:**
- Status shows "Degraded" (VictoriaLogs not running - expected)
- Test connection fails (no real service - expected)
- Delete might need manual file edit (if DELETE endpoint not in UI yet)
  </how-to-verify>
  <resume-signal>
Reply with:
- "approved" if all verification steps pass
- Describe specific issues if any step fails (e.g., "Modal doesn't open", "Save button throws error")
  </resume-signal>
</task>

</tasks>

<verification>
After Task 1 completes and before human verification:

1. **Server builds:**
   ```bash
   go build ./cmd/spectre
   echo "Exit code: $?"
   ```
   Exit code 0 (success)

2. **UI builds:**
   ```bash
   cd ui && npm run build
   echo "Exit code: $?"
   ```
   Exit code 0 (success)

3. **Routes registered:**
   ```bash
   go run ./cmd/spectre server --help 2>&1 | grep integrations-config
   ```
   Shows flag documentation

Human verification (Task 2) confirms end-to-end flow works correctly.
</verification>

<success_criteria>
- [ ] Server.go passes configPath and integrationManager to RegisterHandlers
- [ ] Server builds and starts with --integrations-config flag
- [ ] UI builds with no TypeScript errors
- [ ] Human verifies: Modal opens and form fields work
- [ ] Human verifies: Save creates config file with correct YAML structure
- [ ] Human verifies: Table displays integration with status
- [ ] Human verifies: Manual file edit triggers UI update (hot-reload)
- [ ] Human verifies: Empty state ↔ table state transitions correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-config-management-ui/02-03-SUMMARY.md` following the summary template.
</output>
