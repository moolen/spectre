---
phase: 14-ui-helm-chart
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ui/src/components/IntegrationConfigForm.tsx
  - chart/values.yaml
autonomous: false

must_haves:
  truths:
    - "User can select Logz.io region from dropdown (5 regions: US, EU, UK, AU, CA)"
    - "User can configure SecretRef with separate Secret Name and Key fields"
    - "Connection test validates token from Kubernetes Secret before saving"
    - "Test shows specific error messages for authentication failures and missing Secrets"
    - "Helm chart includes copy-paste example for mounting Kubernetes Secrets"
  artifacts:
    - path: "ui/src/components/IntegrationConfigForm.tsx"
      provides: "Logzio configuration form with region selector and SecretRef fields"
      min_lines: 250
    - path: "chart/values.yaml"
      provides: "Commented Secret mounting example"
      contains: "logzio"
  key_links:
    - from: "ui/src/components/IntegrationConfigForm.tsx"
      to: "config.type === 'logzio'"
      via: "conditional rendering based on type"
      pattern: "config\\.type === 'logzio'"
    - from: "IntegrationConfigForm region select"
      to: "config.config.region"
      via: "handleRegionChange updates nested config object"
      pattern: "config\\.config\\.region"
    - from: "IntegrationConfigForm SecretRef fields"
      to: "config.config.apiTokenRef"
      via: "handleSecretNameChange and handleSecretKeyChange update nested object"
      pattern: "apiTokenRef"
---

<objective>
Complete Phase 14 by adding Logzio configuration form in the UI and documenting Kubernetes Secret mounting in the Helm chart. This finalizes the v1.2 milestone.

Purpose: Enable platform engineers to configure Logzio integrations through the UI and deploy with proper secret management in Kubernetes.

Output:
- Logzio form section in IntegrationConfigForm.tsx with region dropdown and SecretRef fields
- Connection test validates token from Kubernetes Secret with specific error messages
- Helm chart values.yaml includes commented Secret mounting example for copy-paste deployment
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP-v1.2.md
@.planning/STATE.md
@.planning/phases/14-ui-helm-chart/14-CONTEXT.md
@.planning/phases/14-ui-helm-chart/14-RESEARCH.md

# Existing UI patterns
@ui/src/components/IntegrationConfigForm.tsx
@ui/src/components/IntegrationModal.tsx

# Logzio types for config structure
@internal/integration/logzio/types.go

# Helm chart patterns
@chart/values.yaml
@chart/templates/deployment.yaml

# Prior phase context
@.planning/phases/12-mcp-tools-overview-logs/12-01-SUMMARY.md
@.planning/phases/02-config-management-ui/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Logzio form section with region dropdown and SecretRef fields</name>
  <files>ui/src/components/IntegrationConfigForm.tsx</files>
  <action>
Extend IntegrationConfigForm.tsx with Logzio-specific form section following the existing VictoriaLogs pattern.

**Add after line 138 (after victorialogs type option):**
```typescript
<option value="logzio">Logz.io</option>
```

**Add after line 217 (after victorialogs config section, before closing </div>):**
```typescript
{config.type === 'logzio' && (
  <>
    {/* Region selector */}
    <div style={{ marginBottom: '20px' }}>
      <label
        htmlFor="integration-region"
        style={{
          display: 'block',
          fontSize: '14px',
          fontWeight: 500,
          color: 'var(--color-text-primary)',
          marginBottom: '8px',
        }}
      >
        Region
      </label>
      <select
        id="integration-region"
        value={config.config.region || ''}
        onChange={handleRegionChange}
        style={{
          width: '100%',
          padding: '12px',
          borderRadius: '8px',
          border: '1px solid var(--color-border-soft)',
          backgroundColor: 'var(--color-surface-elevated)',
          color: 'var(--color-text-primary)',
          fontSize: '14px',
          outline: 'none',
          cursor: 'pointer',
          transition: 'border-color 0.15s',
        }}
        onFocus={(e) => {
          e.currentTarget.style.borderColor = '#3b82f6';
        }}
        onBlur={(e) => {
          e.currentTarget.style.borderColor = 'var(--color-border-soft)';
        }}
      >
        <option value="">Select a region...</option>
        <option value="us">US (United States)</option>
        <option value="eu">EU (Europe)</option>
        <option value="uk">UK (United Kingdom)</option>
        <option value="au">AU (Australia)</option>
        <option value="ca">CA (Canada)</option>
      </select>
      <p
        style={{
          marginTop: '6px',
          fontSize: '12px',
          color: 'var(--color-text-muted)',
        }}
      >
        Logz.io regional API endpoint
      </p>
    </div>

    {/* Authentication Section */}
    <div style={{
      marginBottom: '20px',
      padding: '16px',
      borderRadius: '8px',
      border: '1px solid var(--color-border-soft)',
      backgroundColor: 'var(--color-surface-muted)',
    }}>
      <h4 style={{
        margin: '0 0 16px 0',
        fontSize: '14px',
        fontWeight: 600,
        color: 'var(--color-text-primary)',
      }}>
        Authentication
      </h4>

      {/* Secret Name */}
      <div style={{ marginBottom: '12px' }}>
        <label
          htmlFor="integration-secret-name"
          style={{
            display: 'block',
            fontSize: '14px',
            fontWeight: 500,
            color: 'var(--color-text-primary)',
            marginBottom: '8px',
          }}
        >
          Secret Name
        </label>
        <input
          id="integration-secret-name"
          type="text"
          value={config.config.apiTokenRef?.secretName || ''}
          onChange={handleSecretNameChange}
          placeholder="logzio-creds"
          style={{
            width: '100%',
            padding: '12px',
            borderRadius: '8px',
            border: '1px solid var(--color-border-soft)',
            backgroundColor: 'var(--color-surface-elevated)',
            color: 'var(--color-text-primary)',
            fontSize: '14px',
            outline: 'none',
            transition: 'border-color 0.15s',
          }}
          onFocus={(e) => {
            e.currentTarget.style.borderColor = '#3b82f6';
          }}
          onBlur={(e) => {
            e.currentTarget.style.borderColor = 'var(--color-border-soft)';
          }}
        />
        <p
          style={{
            marginTop: '6px',
            fontSize: '12px',
            color: 'var(--color-text-muted)',
          }}
        >
          Name of Kubernetes Secret in Spectre's namespace
        </p>
      </div>

      {/* Secret Key */}
      <div>
        <label
          htmlFor="integration-secret-key"
          style={{
            display: 'block',
            fontSize: '14px',
            fontWeight: 500,
            color: 'var(--color-text-primary)',
            marginBottom: '8px',
          }}
        >
          Key
        </label>
        <input
          id="integration-secret-key"
          type="text"
          value={config.config.apiTokenRef?.key || ''}
          onChange={handleSecretKeyChange}
          placeholder="api-token"
          style={{
            width: '100%',
            padding: '12px',
            borderRadius: '8px',
            border: '1px solid var(--color-border-soft)',
            backgroundColor: 'var(--color-surface-elevated)',
            color: 'var(--color-text-primary)',
            fontSize: '14px',
            outline: 'none',
            transition: 'border-color 0.15s',
          }}
          onFocus={(e) => {
            e.currentTarget.style.borderColor = '#3b82f6';
          }}
          onBlur={(e) => {
            e.currentTarget.style.borderColor = 'var(--color-border-soft)';
          }}
        />
        <p
          style={{
            marginTop: '6px',
            fontSize: '12px',
            color: 'var(--color-text-muted)',
          }}
        >
          Key within the Secret containing the API token
        </p>
      </div>
    </div>
  </>
)}
```

**Add event handlers after line 41 (after handleUrlChange):**
```typescript
const handleRegionChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
  onChange({
    ...config,
    config: { ...config.config, region: e.target.value },
  });
};

const handleSecretNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  onChange({
    ...config,
    config: {
      ...config.config,
      apiTokenRef: {
        ...config.config.apiTokenRef,
        secretName: e.target.value,
      },
    },
  });
};

const handleSecretKeyChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  onChange({
    ...config,
    config: {
      ...config.config,
      apiTokenRef: {
        ...config.config.apiTokenRef,
        key: e.target.value,
      },
    },
  });
};
```

**Why this approach:**
- Follows existing VictoriaLogs pattern (lines 169-217) for consistency
- Native select element (no external dependencies, handles accessibility automatically)
- Nested config object structure matches backend types.go (apiTokenRef.secretName, apiTokenRef.key)
- Inline styles match existing component patterns
- Authentication section has visual grouping (border, background) to separate from connection settings

**Why NOT add type dropdown option for Logzio yet:**
The dropdown is populated from the backend factory registry. Add the option inline in the existing select element (line 138).

**Connection test already works:**
IntegrationModal.tsx (lines 113-136) POSTs to /api/config/integrations/test which creates temporary instance and validates SecretRef. Backend returns specific errors like "Secret 'my-secret' not found" or "401 Unauthorized - Invalid API token".
  </action>
  <verify>
npm run dev
# Open browser to http://localhost:3001
# Click "Add Integration" button
# Select "Logz.io" from Type dropdown
# Verify region dropdown shows 5 options
# Verify Secret Name and Key fields render in Authentication section
# Type values and verify state updates work
  </verify>
  <done>
- Logzio appears as option in Type dropdown
- Region dropdown renders with 5 regions (US, EU, UK, AU, CA)
- Secret Name and Key fields render in bordered Authentication section
- Form fields update state correctly when typing
- Layout matches VictoriaLogs pattern (spacing, styling, help text)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Helm Secret mounting documentation</name>
  <files>chart/values.yaml</files>
  <action>
Add commented Secret mounting example in values.yaml following existing extraVolumes/extraVolumeMounts pattern.

**Add after line 329 (after extraVolumeMounts: []):**

```yaml
# Example: Mount Kubernetes Secret for Logz.io API token
#
# 1. Create Secret in Spectre's namespace:
#    kubectl create secret generic logzio-creds \
#      --from-literal=api-token=YOUR_TOKEN_HERE \
#      --namespace monitoring
#
# 2. Uncomment and configure:
# extraVolumes:
#   - name: logzio-secret
#     secret:
#       secretName: logzio-creds
#       defaultMode: 0400
#
# extraVolumeMounts:
#   - name: logzio-secret
#     mountPath: /var/secrets/logzio
#     readOnly: true
#
# 3. Configure Logz.io integration in UI:
#    - Region: Select your Logz.io account region
#    - Secret Name: logzio-creds
#    - Key: api-token
#
# 4. Secret rotation workflow:
#    a. Create new Secret version: kubectl create secret generic logzio-creds-v2 ...
#    b. Update extraVolumes.secretName to logzio-creds-v2
#    c. Apply: helm upgrade spectre ...
#    d. Pods restart automatically, SecretWatcher picks up new token
```

**Why inline comments (not separate section):**
- Research shows values.yaml already uses extraVolumes/extraVolumeMounts pattern
- Copy-paste friendly - users uncomment and fill in their values
- Consistent with existing Helm chart patterns (no new helper templates)
- Target audience (platform engineers) familiar with this documentation style

**Why this example structure:**
- Step 1: kubectl command for Secret creation (immediately actionable)
- Step 2: YAML for mounting (copy-paste into values.yaml)
- Step 3: UI configuration (connects Secret to integration config)
- Step 4: Rotation workflow (covers complete lifecycle per 14-CONTEXT.md)
  </action>
  <verify>
cat chart/values.yaml | grep -A 30 "extraVolumeMounts"
# Verify commented example appears after extraVolumeMounts
# Verify kubectl command syntax is correct
# Verify YAML indentation matches chart conventions
  </verify>
  <done>
- Commented Secret mounting example added after extraVolumeMounts in values.yaml
- Example includes kubectl command for Secret creation
- YAML syntax valid (proper indentation for values.yaml structure)
- Documentation covers complete workflow: create → mount → configure → rotate
- defaultMode: 0400 and readOnly: true security best practices included
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Logzio configuration form in UI with:
- Region dropdown (5 options: US, EU, UK, AU, CA)
- SecretRef fields (Secret Name, Key) in bordered Authentication section
- Connection test validates token from Kubernetes Secret

Helm chart documentation for Secret mounting with copy-paste example.
  </what-built>
  <how-to-verify>
**UI Form Verification:**

1. Start dev server:
   ```bash
   cd ui && npm run dev
   ```

2. Open browser to http://localhost:3001

3. Click "Add Integration" button

4. Verify Type dropdown includes "Logz.io" option

5. Select "Logz.io" from Type dropdown

6. Verify form renders:
   - Region dropdown with 5 options (US, EU, UK, AU, CA) and placeholder "Select a region..."
   - Authentication section with gray background border
   - Secret Name field with placeholder "logzio-creds"
   - Key field with placeholder "api-token"
   - Help text under each field

7. Test field interactions:
   - Select a region (e.g., "US (United States)")
   - Type into Secret Name field
   - Type into Key field
   - Verify values update in form state

8. Test layout consistency:
   - Compare Logzio section layout to VictoriaLogs section (spacing, styling should match)
   - Verify responsive behavior (resize browser, check field widths)

**Connection Test (Optional - requires backend running):**

9. If backend running with Logzio integration:
   - Fill in valid region, Secret Name, Key
   - Click "Test Connection"
   - Verify specific error messages show:
     - "Secret 'my-secret' not found in namespace 'spectre'" (if Secret missing)
     - "Key 'api-token' not found in Secret 'logzio-creds'" (if key wrong)
     - "401 Unauthorized - Invalid API token" (if token invalid)

**Helm Chart Documentation Verification:**

10. Review values.yaml:
    ```bash
    cat chart/values.yaml | grep -A 35 "extraVolumeMounts:"
    ```

11. Verify documentation includes:
    - Commented example starting with "# Example: Mount Kubernetes Secret for Logz.io"
    - kubectl create secret command with proper syntax
    - extraVolumes and extraVolumeMounts YAML (commented out)
    - 4-step workflow (create → mount → configure → rotate)
    - Security best practices (defaultMode: 0400, readOnly: true)

12. Verify YAML syntax:
    ```bash
    helm template chart/ | grep -A 20 "volumes:" || echo "No syntax errors in template"
    ```

**Expected Results:**
- UI form renders correctly with all Logzio-specific fields
- Form interactions work (select region, type Secret fields)
- Connection test shows specific error messages (if tested)
- Helm documentation is copy-paste ready and syntactically valid
  </how-to-verify>
  <resume-signal>
Type "approved" when verification complete, or describe any issues found for fixing.
  </resume-signal>
</task>

</tasks>

<verification>
**Overall Phase Verification:**

1. Requirements coverage:
   - CONF-02: UI displays Logzio configuration form with region selector ✓
   - CONF-03: Connection test validates token before saving ✓ (existing /test endpoint)
   - HELM-01: Helm values include extraVolumes example for secret mounting ✓
   - HELM-02: Documentation covers secret rotation workflow ✓
   - HELM-03: Example Kubernetes Secret manifest provided ✓

2. Goal-backward validation:
   - Truth: User can select region from dropdown → Form has select with 5 options
   - Truth: User can configure SecretRef → Form has Secret Name and Key fields
   - Truth: Connection test validates token → Backend /test endpoint handles SecretRef validation
   - Truth: Helm chart has copy-paste example → values.yaml includes commented Secret mounting YAML

3. Integration with existing patterns:
   - UI follows VictoriaLogs form pattern (conditional rendering, inline styles)
   - Helm follows existing extraVolumes/extraVolumeMounts pattern
   - Config structure matches internal/integration/logzio/types.go
   - Connection test reuses existing /api/config/integrations/test endpoint

4. No blockers or external dependencies:
   - No new npm packages required
   - Backend infrastructure complete (SecretWatcher, validation, test endpoint)
   - Logzio integration already registered in factory
</verification>

<success_criteria>
**Phase 14 complete when:**

1. IntegrationConfigForm.tsx includes Logzio form section
   - Logzio option in Type dropdown
   - Region select with 5 options (us, eu, uk, au, ca)
   - Secret Name and Key input fields
   - Event handlers update nested config object structure

2. UI form tested and approved
   - Form renders without errors
   - Fields update state correctly
   - Layout matches existing VictoriaLogs pattern
   - Help text provides clear guidance

3. Helm chart includes Secret mounting documentation
   - Commented example in values.yaml after extraVolumeMounts
   - kubectl command for Secret creation
   - YAML for volume and volumeMount
   - Complete workflow documented (create → mount → configure → rotate)
   - Security best practices included (readOnly, defaultMode)

4. v1.2 milestone complete
   - All 5 requirements (CONF-02, CONF-03, HELM-01, HELM-02, HELM-03) satisfied
   - Logzio integration fully configurable via UI
   - Kubernetes secret mounting documented for production deployment

**Measurable outcomes:**
- Can create Logzio integration via UI with region and SecretRef
- Connection test validates configuration before saving
- Helm chart deploys with Secret mounted following documentation
- No manual API calls or file editing required for Logzio setup
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-helm-chart/14-01-SUMMARY.md` following summary template.

Include:
- Screenshots or description of Logzio form in UI
- Excerpt of values.yaml Secret mounting documentation
- Verification results from human checkpoint
- Any deviations or issues encountered
- Confirmation of v1.2 milestone completion
</output>
