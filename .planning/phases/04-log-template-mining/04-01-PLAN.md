---
phase: 04-log-template-mining
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/logprocessing/drain.go
  - internal/logprocessing/template.go
autonomous: true

must_haves:
  truths:
    - "Drain algorithm can cluster similar logs into templates"
    - "Templates have stable hash IDs that don't change across restarts"
    - "Configuration parameters control clustering behavior (tree depth, similarity, max children)"
  artifacts:
    - path: "internal/logprocessing/drain.go"
      provides: "Drain algorithm wrapper with configuration"
      exports: ["DrainConfig", "DrainProcessor"]
      min_lines: 60
    - path: "internal/logprocessing/template.go"
      provides: "Template types with SHA-256 hashing"
      exports: ["Template", "GenerateTemplateID"]
      min_lines: 40
  key_links:
    - from: "internal/logprocessing/drain.go"
      to: "github.com/faceair/drain"
      via: "New() constructor"
      pattern: "drain\\.New\\(config\\)"
    - from: "internal/logprocessing/template.go"
      to: "crypto/sha256"
      via: "GenerateTemplateID hashing"
      pattern: "sha256\\.Sum256"
---

<objective>
Create core template mining foundation using Drain algorithm wrapper and stable template hashing.

Purpose: Establish the fundamental building blocks for log clustering - Drain configuration, template data structures, and deterministic hash generation for cross-client consistency.

Output: Integration-agnostic log processing package with Drain wrapper and template types ready for use by storage layer.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-log-template-mining/04-RESEARCH.md
@.planning/phases/04-log-template-mining/04-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Create Drain algorithm wrapper with configuration</name>
  <files>internal/logprocessing/drain.go</files>
  <action>
Create new package `internal/logprocessing` (integration-agnostic per requirements).

Create `drain.go` with:
- DrainConfig struct with fields: LogClusterDepth (int, default 4), SimTh (float64, default 0.4), MaxChildren (int, default 100), MaxClusters (int, default 0 for unlimited), ExtraDelimiters ([]string, default ["_", "="]), ParamString (string, default "<*>")
- DrainProcessor struct wrapping github.com/faceair/drain.Drain instance
- NewDrainProcessor(config DrainConfig) *DrainProcessor constructor that creates drain.Config from DrainConfig and returns initialized processor
- Train(logMessage string) *drain.LogCluster method that delegates to drain.Train()
- Match(logMessage string) *drain.LogCluster method that delegates to drain.Match()

Research guidance: Start with sim_th=0.4 for structured logs (balanced), tree depth=4 (recommended minimum 3), maxChildren=100 (prevents branch explosion from variable-starting logs).

User decision from CONTEXT.md: "Loose clustering (fewer templates)" means prioritizing groupability - when tuning, prefer slightly higher similarity threshold if template count explodes.

Use github.com/faceair/drain (research recommendation: official Go port, stable API, configurable).
  </action>
  <verify>
go build ./internal/logprocessing
go test -run TestDrainProcessor ./internal/logprocessing (basic constructor test)
  </verify>
  <done>
DrainProcessor wraps Drain with configurable parameters, Train/Match methods delegate correctly, package compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Create template types with stable hash generation</name>
  <files>internal/logprocessing/template.go</files>
  <action>
Create `template.go` in `internal/logprocessing` with:

- Template struct with fields:
  - ID string (SHA-256 hash, hex-encoded)
  - Namespace string (Kubernetes namespace for scoping)
  - Pattern string (template pattern like "connected to <*>")
  - Tokens []string (tokenized pattern for similarity comparison)
  - Count int (occurrence count for pruning)
  - FirstSeen time.Time (timestamp of first occurrence)
  - LastSeen time.Time (timestamp of most recent occurrence)

- GenerateTemplateID(namespace, pattern string) string function:
  - Canonicalize input as "namespace|pattern" for deterministic hashing
  - Hash with crypto/sha256.Sum256()
  - Return hex.EncodeToString(hash[:]) as stable template identifier
  - Requirement MINE-03: Templates have stable hashes for cross-client consistency

- TemplateList type alias for []Template with helper methods:
  - FindByID(id string) *Template (linear search, acceptable for small lists)
  - SortByCount() (sort descending by occurrence count for ranking)

Import: crypto/sha256, encoding/hex, time, sort

User decision from CONTEXT.md: Templates scoped per-namespace (same pattern in different namespaces = different template IDs).
  </action>
  <verify>
go build ./internal/logprocessing
Test: GenerateTemplateID("default", "test pattern") returns consistent 64-char hex string across multiple calls
  </verify>
  <done>
Template struct defined with all required fields, GenerateTemplateID produces deterministic SHA-256 hashes, TemplateList helpers implemented.
  </done>
</task>

</tasks>

<verification>
Package structure:
- internal/logprocessing/ exists as new integration-agnostic package
- drain.go exports DrainConfig and DrainProcessor
- template.go exports Template and GenerateTemplateID

Functional checks:
- DrainProcessor can be created with custom config
- GenerateTemplateID returns same hash for same input (deterministic)
- Package compiles: `go build ./internal/logprocessing`

Dependencies:
- go.mod includes github.com/faceair/drain (run `go get github.com/faceair/drain` if needed)
- crypto/sha256 from stdlib (no external dep)
</verification>

<success_criteria>
- [ ] internal/logprocessing package created (new directory)
- [ ] DrainProcessor wraps github.com/faceair/drain with configurable parameters
- [ ] Template struct has ID, Namespace, Pattern, Tokens, Count, FirstSeen, LastSeen fields
- [ ] GenerateTemplateID produces stable SHA-256 hashes (same input = same hash)
- [ ] Package compiles without errors: `go build ./internal/logprocessing`
- [ ] No external dependencies beyond github.com/faceair/drain and Go stdlib
</success_criteria>

<output>
After completion, create `.planning/phases/04-log-template-mining/04-01-SUMMARY.md`
</output>
