---
phase: 18-query-execution-mcp-tools
plan: 03
type: execute
wave: 3
depends_on: ["18-02"]
files_modified:
  - internal/integration/grafana/grafana.go
autonomous: false

must_haves:
  truths:
    - "MCP server registers three Grafana tools on integration start"
    - "Tool names follow pattern: grafana_{name}_metrics_{level}"
    - "Tool schemas specify required parameters (from, to, cluster, region)"
    - "Tools are callable via MCP client"
    - "Queries execute successfully with real Grafana instance"
  artifacts:
    - path: "internal/integration/grafana/grafana.go"
      provides: "RegisterTools method updated"
      exports: ["RegisterTools"]
      contains: "grafana.*metrics_overview"
  key_links:
    - from: "internal/integration/grafana/grafana.go"
      to: "tools_metrics_overview.go"
      via: "Register overview tool"
      pattern: "NewOverviewTool"
    - from: "internal/integration/grafana/grafana.go"
      to: "tools_metrics_aggregated.go"
      via: "Register aggregated tool"
      pattern: "NewAggregatedTool"
    - from: "internal/integration/grafana/grafana.go"
      to: "tools_metrics_details.go"
      via: "Register details tool"
      pattern: "NewDetailsTool"
---

<objective>
Register three MCP tools with the integration registry and verify query execution with real Grafana instance.

Purpose: Make tools discoverable and executable via MCP client, validate end-to-end query flow from MCP call through Grafana API to time series response.

Output: Updated RegisterTools method, verified working tools with human confirmation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-query-execution-mcp-tools/18-CONTEXT.md
@.planning/phases/18-query-execution-mcp-tools/18-RESEARCH.md
@.planning/phases/18-query-execution-mcp-tools/18-01-SUMMARY.md
@.planning/phases/18-query-execution-mcp-tools/18-02-SUMMARY.md

# Existing registration pattern
@internal/integration/victorialogs/victorialogs.go
@internal/integration/logzio/logzio.go
@internal/integration/grafana/grafana.go
</context>

<tasks>

<task type="auto">
  <name>Register three MCP tools</name>
  <files>
    internal/integration/grafana/grafana.go
  </files>
  <action>
Update RegisterTools method in grafana.go to register three MCP tools following Pattern from RESEARCH.md:

In Start method, create shared query service:
```go
func (g *GrafanaIntegration) Start(ctx context.Context) error {
    // ... existing dashboard syncer setup ...

    // Create query service for MCP tools
    g.queryService = NewGrafanaQueryService(g.client, g.graphClient, g.logger)

    return nil
}
```

In RegisterTools method, register three tools:
```go
func (g *GrafanaIntegration) RegisterTools(registry integration.ToolRegistry) error {
    // Overview tool
    registry.RegisterTool(
        fmt.Sprintf("grafana_%s_metrics_overview", g.Name),
        "Get overview of key metrics from overview-level dashboards (first 5 panels per dashboard). Use this for high-level anomaly detection across all services.",
        NewOverviewTool(g.queryService, g.graphClient, g.logger).Execute,
        map[string]interface{}{
            "type": "object",
            "properties": map[string]interface{}{
                "from": map[string]interface{}{
                    "type": "string",
                    "description": "Start time (ISO8601: 2026-01-23T10:00:00Z)",
                },
                "to": map[string]interface{}{
                    "type": "string",
                    "description": "End time (ISO8601: 2026-01-23T11:00:00Z)",
                },
                "cluster": map[string]interface{}{
                    "type": "string",
                    "description": "Cluster name (required for scoping)",
                },
                "region": map[string]interface{}{
                    "type": "string",
                    "description": "Region name (required for scoping)",
                },
            },
            "required": []string{"from", "to", "cluster", "region"},
        },
    )

    // Aggregated tool
    registry.RegisterTool(
        fmt.Sprintf("grafana_%s_metrics_aggregated", g.Name),
        "Get aggregated metrics for a specific service or namespace from drill-down dashboards. Use this to focus on a particular service or namespace after detecting issues in overview.",
        NewAggregatedTool(g.queryService, g.graphClient, g.logger).Execute,
        map[string]interface{}{
            "type": "object",
            "properties": map[string]interface{}{
                "from":    /* same as overview */,
                "to":      /* same as overview */,
                "cluster": /* same as overview */,
                "region":  /* same as overview */,
                "service": map[string]interface{}{
                    "type": "string",
                    "description": "Service name (optional, specify service OR namespace)",
                },
                "namespace": map[string]interface{}{
                    "type": "string",
                    "description": "Namespace name (optional, specify service OR namespace)",
                },
            },
            "required": []string{"from", "to", "cluster", "region"},
        },
    )

    // Details tool
    registry.RegisterTool(
        fmt.Sprintf("grafana_%s_metrics_details", g.Name),
        "Get detailed metrics from detail-level dashboards (all panels). Use this for deep investigation of specific issues after narrowing scope with aggregated tool.",
        NewDetailsTool(g.queryService, g.graphClient, g.logger).Execute,
        map[string]interface{}{
            "type": "object",
            "properties": map[string]interface{}{
                "from":    /* same as overview */,
                "to":      /* same as overview */,
                "cluster": /* same as overview */,
                "region":  /* same as overview */,
            },
            "required": []string{"from", "to", "cluster", "region"},
        },
    )

    return nil
}
```

Add queryService field to GrafanaIntegration struct if not present.

Follow existing patterns from VictoriaLogs and Logz.io tool registration.
  </action>
  <verify>
go build ./internal/integration/grafana/... succeeds
grep -r "grafana.*metrics_overview" internal/integration/grafana/grafana.go shows tool registration
grep -r "grafana.*metrics_aggregated" internal/integration/grafana/grafana.go shows tool registration
grep -r "grafana.*metrics_details" internal/integration/grafana/grafana.go shows tool registration
  </verify>
  <done>
RegisterTools method registers three MCP tools with proper schemas, tool names follow pattern grafana_{name}_metrics_{level}, query service created in Start method.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete query execution system with three MCP tools:
- GrafanaQueryService executes queries via /api/ds/query endpoint
- OverviewTool executes overview dashboards (5 panels max)
- AggregatedTool executes drill-down dashboards for service/namespace
- DetailsTool executes detail dashboards (all panels)
- All tools registered with MCP server
  </what-built>
  <how-to-verify>
1. Start Spectre server with Grafana integration enabled:
   ```bash
   go run cmd/spectre/main.go server
   ```

2. Verify tools are registered - check server logs for:
   - "Registered Grafana integration tools" or similar
   - Three tool names: grafana_{name}_metrics_overview, grafana_{name}_metrics_aggregated, grafana_{name}_metrics_details

3. Test tools via MCP client (use Claude Desktop or mcp CLI):

   a) Test overview tool:
   ```json
   {
     "tool": "grafana_{name}_metrics_overview",
     "arguments": {
       "from": "2026-01-23T10:00:00Z",
       "to": "2026-01-23T11:00:00Z",
       "cluster": "prod",
       "region": "us-west"
     }
   }
   ```
   Expected: Returns dashboards array with panels (up to 5 per dashboard), each panel has metrics with labels and values, timestamps in ISO8601 format.

   b) Test aggregated tool with service:
   ```json
   {
     "tool": "grafana_{name}_metrics_aggregated",
     "arguments": {
       "from": "2026-01-23T10:00:00Z",
       "to": "2026-01-23T11:00:00Z",
       "cluster": "prod",
       "region": "us-west",
       "service": "api"
     }
   }
   ```
   Expected: Returns drill-down dashboards with all panels for the specified service.

   c) Test details tool:
   ```json
   {
     "tool": "grafana_{name}_metrics_details",
     "arguments": {
       "from": "2026-01-23T10:00:00Z",
       "to": "2026-01-23T11:00:00Z",
       "cluster": "prod",
       "region": "us-west"
     }
   }
   ```
   Expected: Returns detail dashboards with all panels.

4. Check response format:
   - Each dashboard has dashboard_uid, dashboard_title, panels array
   - Each panel has panel_id, panel_title, metrics array
   - Each metric has labels (map), values array with timestamp+value pairs
   - Timestamps are ISO8601 format ("2026-01-23T10:00:00Z")
   - Partial results: If some panels fail, they appear in errors array (not panel errors)
   - Empty panels omitted (not included in response)

5. Verify progressive disclosure:
   - Overview returns max 5 panels per dashboard
   - Aggregated and details return all panels
   - Tools find dashboards by hierarchy_level in graph

6. Test error handling:
   - Invalid time range returns clear error message
   - Missing required parameters (cluster, region) returns validation error
   - Grafana API failures appear in errors array, successful panels still returned
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. go build ./cmd/spectre succeeds
2. Server starts with Grafana integration
3. Three tools registered with MCP server
4. Tools callable via MCP client
5. Queries execute and return formatted time series data
6. Progressive disclosure works (5 panels vs all panels)
7. Partial results pattern works (errors collected, not propagated)
8. Time range validation catches invalid inputs
</verification>

<success_criteria>
- RegisterTools method registers three MCP tools
- Tools are discoverable via MCP server
- Overview tool executes overview dashboards with 5 panel limit
- Aggregated tool executes drill-down dashboards with service/namespace filter
- Details tool executes detail dashboards with all panels
- Response format matches DashboardQueryResult structure
- Time ranges validated and converted correctly
- Human verification confirms tools work end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/18-query-execution-mcp-tools/18-03-SUMMARY.md`
</output>
