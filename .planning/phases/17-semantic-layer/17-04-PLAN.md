---
phase: 17-semantic-layer
plan: 04
type: execute
wave: 2
depends_on: ["17-03"]
files_modified:
  - ui/src/components/IntegrationConfigForm.tsx
autonomous: true

must_haves:
  truths:
    - "UI displays hierarchy mapping configuration for Grafana integrations"
    - "User can add tag-to-level mappings via UI"
    - "Validation warns if level is invalid but allows save"
    - "HierarchyMap is saved to integration config"
  artifacts:
    - path: "ui/src/components/IntegrationConfigForm.tsx"
      provides: "Hierarchy mapping UI fields"
      contains: "HierarchyMap"
  key_links:
    - from: "IntegrationConfigForm.tsx"
      to: "Config.HierarchyMap"
      via: "Form state binding"
      pattern: "hierarchyMap"
---

<objective>
Add UI configuration for dashboard hierarchy fallback mapping when Grafana tags are absent.

Purpose: Allow users to configure tag-to-level mapping (e.g., "prod" → "overview") as fallback when dashboards don't have hierarchy tags.

Output:
- UI form section for hierarchy mapping in Grafana integration config
- Tag/level pairs editable by user
- Validation warnings for invalid levels (warning-only, allows save per CONTEXT.md)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-semantic-layer/17-CONTEXT.md
@.planning/phases/17-semantic-layer/17-RESEARCH.md

# Existing UI form and newly added Config structure
@ui/src/components/IntegrationConfigForm.tsx
@internal/integration/grafana/types.go
</context>

<tasks>

<task type="auto">
  <name>Add hierarchy mapping UI to Grafana integration form</name>
  <files>
ui/src/components/IntegrationConfigForm.tsx
  </files>
  <action>
1. Add hierarchy mapping state handlers after existing Grafana handlers (around line ~82):
   ```typescript
   const handleHierarchyMapChange = (newMap: Record<string, string>) => {
     onChange({
       ...config,
       config: {
         ...config.config,
         hierarchyMap: newMap,
       },
     });
   };

   const addHierarchyMapping = () => {
     const currentMap = config.config.hierarchyMap || {};
     handleHierarchyMapChange({ ...currentMap, '': '' });
   };

   const updateHierarchyMapping = (oldTag: string, newTag: string, newLevel: string) => {
     const currentMap = { ...config.config.hierarchyMap } || {};
     if (oldTag !== newTag) {
       delete currentMap[oldTag];
     }
     currentMap[newTag] = newLevel;
     handleHierarchyMapChange(currentMap);
   };

   const removeHierarchyMapping = (tag: string) => {
     const currentMap = { ...config.config.hierarchyMap } || {};
     delete currentMap[tag];
     handleHierarchyMapChange(currentMap);
   };
   ```

2. Add hierarchy mapping UI section inside Grafana config block (after Authentication section, around line ~604):
   ```tsx
   {/* Hierarchy Mapping Section */}
   <div style={{
     marginBottom: '20px',
     padding: '16px',
     borderRadius: '8px',
     border: '1px solid var(--color-border-soft)',
     backgroundColor: 'var(--color-surface-muted)',
   }}>
     <h4 style={{
       margin: '0 0 8px 0',
       fontSize: '14px',
       fontWeight: 600,
       color: 'var(--color-text-primary)',
     }}>
       Hierarchy Mapping (Optional)
     </h4>
     <p style={{
       margin: '0 0 16px 0',
       fontSize: '12px',
       color: 'var(--color-text-muted)',
     }}>
       Map dashboard tags to hierarchy levels (overview/drilldown/detail) when explicit hierarchy tags are absent.
       Example: Tag "prod" → "overview"
     </p>

     {/* List existing mappings */}
     {Object.entries(config.config.hierarchyMap || {}).map(([tag, level]) => (
       <div key={tag} style={{
         display: 'flex',
         gap: '8px',
         marginBottom: '8px',
         alignItems: 'center',
       }}>
         <input
           type="text"
           value={tag}
           onChange={(e) => updateHierarchyMapping(tag, e.target.value, level)}
           placeholder="Tag (e.g., prod)"
           style={{
             flex: 1,
             padding: '8px',
             borderRadius: '6px',
             border: '1px solid var(--color-border-soft)',
             backgroundColor: 'var(--color-surface-elevated)',
             color: 'var(--color-text-primary)',
             fontSize: '13px',
           }}
         />
         <select
           value={level}
           onChange={(e) => updateHierarchyMapping(tag, tag, e.target.value)}
           style={{
             flex: 1,
             padding: '8px',
             borderRadius: '6px',
             border: '1px solid var(--color-border-soft)',
             backgroundColor: 'var(--color-surface-elevated)',
             color: 'var(--color-text-primary)',
             fontSize: '13px',
           }}
         >
           <option value="">Select level...</option>
           <option value="overview">Overview</option>
           <option value="drilldown">Drill-down</option>
           <option value="detail">Detail</option>
         </select>
         <button
           type="button"
           onClick={() => removeHierarchyMapping(tag)}
           style={{
             padding: '8px 12px',
             borderRadius: '6px',
             border: 'none',
             backgroundColor: '#ef4444',
             color: 'white',
             fontSize: '13px',
             cursor: 'pointer',
           }}
         >
           Remove
         </button>
       </div>
     ))}

     {/* Add mapping button */}
     <button
       type="button"
       onClick={addHierarchyMapping}
       style={{
         padding: '8px 16px',
         borderRadius: '6px',
         border: '1px solid var(--color-border-soft)',
         backgroundColor: 'var(--color-surface-elevated)',
         color: 'var(--color-text-primary)',
         fontSize: '13px',
         cursor: 'pointer',
         marginTop: '8px',
       }}
     >
       + Add Mapping
     </button>
   </div>
   ```

3. Add validation helper (optional warning, per CONTEXT.md):
   - Add validation check before rendering: detect if any level is not in ["overview", "drilldown", "detail"]
   - If invalid level found, show warning message (yellow box) below hierarchy section
   - Warning text: "Warning: Some mappings use invalid levels. Valid levels are: overview, drilldown, detail."
   - Do NOT prevent save (warning-only per CONTEXT.md)

4. Initialize hierarchyMap if undefined:
   - When config.config.hierarchyMap is undefined, treat as empty object `{}`
   - No need to explicitly initialize in state (handled by `|| {}` in handlers)

**No preview UI (per CONTEXT.md):** Do not add classification preview functionality. Users configure mappings and see results after sync.

**Styling consistency:** Match existing form styling patterns from VictoriaLogs and Logz.io sections. Use same color variables and spacing.
  </action>
  <verify>
Build UI to check for compilation errors: `cd ui && npm run build`

Check hierarchy mapping handlers exist: `grep -n "handleHierarchyMapChange" ui/src/components/IntegrationConfigForm.tsx`

Verify UI section added: `grep -n "Hierarchy Mapping" ui/src/components/IntegrationConfigForm.tsx`

Test in browser (if dev server available): Navigate to Integrations page, add Grafana integration, verify hierarchy mapping section appears
  </verify>
  <done>
- Hierarchy mapping state handlers added (add, update, remove)
- UI section renders for Grafana integrations only
- Tag/level pairs editable with Add Mapping button
- Remove button deletes mappings
- Validation warning shows for invalid levels (non-blocking)
- Styling matches existing form sections
- UI builds without errors
  </done>
</task>

</tasks>

<verification>
**UI compilation:**
```bash
# Build succeeds
cd ui && npm run build

# No TypeScript errors
cd ui && npm run type-check 2>&1 | grep -i hierarchy || echo "No hierarchy-related type errors"
```

**Component structure:**
```bash
# Verify hierarchy mapping section exists
grep -n "Hierarchy Mapping" ui/src/components/IntegrationConfigForm.tsx

# Check handlers defined
grep -n "handleHierarchyMapChange\|addHierarchyMapping\|updateHierarchyMapping\|removeHierarchyMapping" ui/src/components/IntegrationConfigForm.tsx
```

**Manual verification (if dev server available):**
1. Start dev server: `cd ui && npm run dev`
2. Navigate to Integrations page
3. Click "Add Integration" and select Grafana
4. Verify "Hierarchy Mapping (Optional)" section appears
5. Click "Add Mapping" and verify new input row appears
6. Enter tag "prod" and level "overview"
7. Click "Add Mapping" again, verify multiple mappings work
8. Click "Remove" on a mapping, verify it disappears
9. Save integration and verify hierarchyMap is in config payload
</verification>

<success_criteria>
Phase 17-04 complete when:

1. **UI section added:**
   - Hierarchy Mapping section appears in Grafana config
   - Section includes description of purpose
   - Optional label indicates not required

2. **Functionality working:**
   - Add Mapping button creates new tag/level pair
   - Tag input and level dropdown editable
   - Remove button deletes mapping
   - Multiple mappings supported
   - Empty mappings allowed (no pre-validation)

3. **Integration complete:**
   - hierarchyMap saved to integration config on save
   - Config structure matches backend (map[string]string)
   - Validation warning shows for invalid levels (non-blocking)

4. **UI quality:**
   - Styling consistent with existing sections
   - No TypeScript errors
   - UI builds successfully
   - No visual regressions in other form sections
</success_criteria>

<output>
After completion, create `.planning/phases/17-semantic-layer/17-04-SUMMARY.md`
</output>
