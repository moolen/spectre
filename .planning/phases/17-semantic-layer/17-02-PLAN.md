---
phase: 17-semantic-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/integration/grafana/graph_builder.go
  - internal/graph/models.go
  - internal/integration/grafana/graph_builder_test.go
autonomous: true

must_haves:
  truths:
    - "Variable nodes exist with scoping/entity/detail classification"
    - "Variables link to Dashboard nodes via HAS_VARIABLE edges"
  artifacts:
    - path: "internal/graph/models.go"
      provides: "Variable node type definition"
      contains: "NodeTypeVariable"
    - path: "internal/integration/grafana/graph_builder.go"
      provides: "Variable classification logic"
      contains: "classifyVariable, createVariableNodes"
      min_lines: 200
  key_links:
    - from: "graph_builder.go:CreateDashboardGraph"
      to: "graph_builder.go:createVariableNodes"
      via: "Dashboard templating list"
      pattern: "createVariableNodes.*Templating"
---

<objective>
Parse dashboard variables and classify by type (scoping/entity/detail/unknown).

Purpose: Enable semantic queries about what variables control scoping vs entity selection.

Output:
- Variable nodes with scoping/entity/detail/unknown classification
- HAS_VARIABLE edges linking dashboards to variables
- Pattern-based classification logic
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-semantic-layer/17-CONTEXT.md
@.planning/phases/17-semantic-layer/17-RESEARCH.md

# Existing graph builder
@internal/integration/grafana/graph_builder.go
@internal/graph/models.go
</context>

<tasks>

<task type="auto">
  <name>Parse dashboard variables and classify by type</name>
  <files>
internal/integration/grafana/graph_builder.go
internal/graph/models.go
internal/integration/grafana/graph_builder_test.go
  </files>
  <action>
1. Add Variable node type to `internal/graph/models.go`:
   - `NodeTypeVariable = "Variable"`
   - `EdgeTypeHasVariable = "HAS_VARIABLE"` (Dashboard-[:HAS_VARIABLE]->Variable)
   - Variable node properties: `name`, `type` (query/textbox/custom/interval), `classification` (scoping/entity/detail/unknown)

2. Add `classifyVariable` function to `graph_builder.go`:
   - Input: variable name (string)
   - Use regex patterns to classify:
     - **Scoping:** cluster, region, env, environment, datacenter, zone
     - **Entity:** service, namespace, app, application, deployment, pod, container
     - **Detail:** instance, node, host, endpoint, handler, path
   - Return classification string: "scoping" | "entity" | "detail" | "unknown"
   - Case-insensitive matching (convert to lowercase before matching)

3. Add `createVariableNodes` function to `graph_builder.go`:
   - Input: `ctx`, `dashboardUID`, `[]interface{}` (Templating.List from dashboard JSON), `now`
   - For each variable in list:
     - Parse variable: check if it has `name` and `type` fields (JSON map)
     - Call `classifyVariable(name)` to get classification
     - Use MERGE to create/update Variable node: `MERGE (v:Variable {dashboardUID: $uid, name: $name})`
     - Set properties: `type`, `classification`, `firstSeen`, `lastSeen`
     - Create edge: `MERGE (d:Dashboard {uid: $uid})-[:HAS_VARIABLE]->(v)`
   - Handle malformed variables: log warning, skip that variable
   - Return variable count for logging

4. Integrate into `CreateDashboardGraph` in `graph_builder.go`:
   - After creating Dashboard node (line ~122), call `createVariableNodes(ctx, dashboard.UID, dashboard.Templating.List, now)`
   - Log variable count at Debug level: "Created N variables for dashboard %s"
   - Use graceful degradation: log errors, continue with dashboard creation

5. Add unit tests in `graph_builder_test.go`:
   - Test variable classification for all three types (scoping, entity, detail)
   - Test unknown classification for unrecognized names
   - Test case-insensitivity (Cluster == cluster)
   - Test multiple variables per dashboard
   - Test malformed variable handling (missing name field)

**Classification patterns (from CONTEXT.md):**
- Scoping: cluster, region, env
- Entity: service, namespace, app
- Detail: pod, instance

Extend patterns to include common variations (environment, datacenter, application, etc.) but mark as appropriate classification.
  </action>
  <verify>
Run tests: `go test ./internal/integration/grafana/... -v -run TestVariableClassification`

Check Variable node type exists: `grep -n "NodeTypeVariable" internal/graph/models.go`

Verify HAS_VARIABLE edge defined: `grep -n "EdgeTypeHasVariable" internal/graph/models.go`

Check integration creates variables: `grep -n "createVariableNodes" internal/integration/grafana/graph_builder.go`
  </verify>
  <done>
- Variable node type exists in models.go
- classifyVariable implements pattern matching for all three types
- createVariableNodes parses Templating.List and creates Variable nodes
- HAS_VARIABLE edges link dashboards to variables
- Tests verify classification logic and malformed variable handling
- Integration with CreateDashboardGraph logs variable count
  </done>
</task>

</tasks>

<verification>
**Graph schema verification:**
```bash
# Verify Variable node type defined
grep -E "NodeTypeVariable" internal/graph/models.go

# Verify HAS_VARIABLE edge defined
grep -E "EdgeTypeHasVariable" internal/graph/models.go
```

**Test coverage:**
```bash
# Run all Grafana integration tests
go test ./internal/integration/grafana/... -v -cover

# Verify variable classification tests exist
grep -n "TestVariableClassification" internal/integration/grafana/graph_builder_test.go
```

**Integration verification:**
```bash
# Check variable node creation integrated into dashboard graph
grep -n "createVariableNodes" internal/integration/grafana/graph_builder.go | grep -A2 "CreateDashboardGraph"
```
</verification>

<success_criteria>
Phase 17-02 complete when:

1. **Variable classification working:**
   - Variable nodes created from dashboard Templating.List
   - Classification (scoping/entity/detail/unknown) applied
   - HAS_VARIABLE edges link Dashboards to Variables
   - Malformed variables handled gracefully

2. **Tests passing:**
   - All unit tests for variable classification pass
   - Integration tests verify graph structure

3. **No regressions:**
   - Existing dashboard sync still works
   - All Phase 16 tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/17-semantic-layer/17-02-SUMMARY.md`
</output>
