---
phase: 06-consolidated-server
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can access MCP tools at http://localhost:8080/v1/mcp"
    - "Integration manager successfully registers tools on startup"
    - "Server gracefully shuts down all components on SIGTERM within 10 seconds"
    - "Stdio transport works when --stdio flag is present"
    - "REST API, UI, and MCP all respond on single port 8080"
  artifacts: []
  key_links:
    - from: "MCP client"
      to: "http://localhost:8080/v1/mcp"
      via: "StreamableHTTP protocol"
      pattern: "POST /v1/mcp"
    - from: "Integration tool"
      to: "MCP endpoint"
      via: "Dynamic registration during manager.Start()"
      pattern: "RegisterTool.*victorialogs"
---

<objective>
Verify that consolidated server works correctly with MCP endpoint, integration manager, and graceful shutdown.

Purpose: Ensure all Phase 6 requirements (SRVR-01 through INTG-03) function correctly in integrated environment before proceeding to service layer extraction.

Output: Human verification that MCP tools respond, integrations register, and shutdown is clean.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-consolidated-server/06-CONTEXT.md
@.planning/phases/06-consolidated-server/06-01-SUMMARY.md

# Code references
@cmd/spectre/commands/server.go
@internal/apiserver/server.go
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Consolidated Spectre server serving REST API, UI, and MCP on single port 8080 with in-process integration manager.

Code changes from Plan 06-01:
- MCP server initialized in server.go with MCPToolRegistry
- Integration manager wired to MCP for dynamic tool registration
- /v1/mcp endpoint registered on HTTP router
- --stdio flag for stdio transport alongside HTTP
  </what-built>

  <how-to-verify>
**Prerequisites:**
- FalkorDB running on localhost:6379 (for graph support)
- No existing Spectre processes on port 8080

**Test 1: HTTP Server Consolidation (SRVR-01, SRVR-02)**

1. Start consolidated server:
   ```bash
   cd /home/moritz/dev/spectre-via-ssh
   ./spectre server --graph-enabled --graph-host=localhost --graph-port=6379
   ```

2. Verify startup logs show:
   - "Initializing MCP server" message
   - "MCP server created" message
   - "Integration manager created with MCP tool registry" (if integrations configured)
   - "Registering MCP endpoint at /v1/mcp" message
   - "Starting Spectre" on port 8080

3. In another terminal, verify REST API works:
   ```bash
   curl http://localhost:8080/health
   # Expected: "ok" response (200 OK)
   ```

4. Verify MCP endpoint responds (StreamableHTTP protocol):
   ```bash
   curl -X POST http://localhost:8080/v1/mcp \
     -H "Content-Type: application/json" \
     -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}'
   # Expected: JSON response with server capabilities, tools list
   # Should include tools like: cluster_health, resource_timeline, etc.
   ```

5. Verify UI accessible:
   ```bash
   curl -I http://localhost:8080/
   # Expected: 200 OK with text/html content-type
   ```

**Test 2: Integration Manager Tool Registration (INTG-01, INTG-02)**

1. Check server logs for integration startup:
   - Look for "Integration manager started successfully with N instances"
   - If VictoriaLogs integration configured, should see tool registration messages

2. If integrations exist, verify their tools appear in MCP tools list:
   ```bash
   curl -X POST http://localhost:8080/v1/mcp \
     -H "Content-Type: application/json" \
     -d '{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}'
   # Expected: Response includes integration-provided tools
   # Example: victorialogs_query_logs, victorialogs_analyze_patterns
   ```

**Test 3: Graceful Shutdown (SRVR-04)**

1. With server still running, send SIGTERM:
   ```bash
   # In terminal with running server, press Ctrl+C
   # OR find PID and: kill -TERM <pid>
   ```

2. Verify shutdown logs show:
   - "Shutdown signal received, gracefully shutting down..."
   - "Stopping integration manager" (if integrations present)
   - "Shutdown complete" message
   - Process exits within 10 seconds

3. Check exit code:
   ```bash
   echo $?
   # Expected: 0 (clean exit)
   ```

**Test 4: Stdio Transport (SRVR-03)**

1. Start server with --stdio flag:
   ```bash
   ./spectre server --graph-enabled --graph-host=localhost --graph-port=6379 --stdio
   ```

2. Verify startup logs show:
   - "Starting stdio MCP transport alongside HTTP"
   - Both HTTP server starts AND stdio starts

3. Verify HTTP still works (stdio is additional, not replacement):
   ```bash
   curl http://localhost:8080/health
   # Expected: "ok" response
   ```

4. Stop server (Ctrl+C), verify clean shutdown

**Test 5: Config Hot-Reload (INTG-03) - Optional**

If integrations configured:

1. Start server
2. Modify integrations config file (add/remove integration)
3. Wait 500ms (debounce period)
4. Check logs for "Config reloaded, restarting integrations"
5. Verify tools list updates via MCP endpoint

**Expected Outcomes:**
- ✅ Single port 8080 serves REST, UI, and MCP
- ✅ MCP endpoint /v1/mcp responds to StreamableHTTP protocol
- ✅ Integration tools registered and visible via tools/list
- ✅ Server shuts down cleanly in under 10 seconds
- ✅ --stdio flag works alongside HTTP

**Note on Requirement Discrepancies:**
During verification, note that:
- SRVR-02 requirement specifies `/mcp` path, but implementation correctly uses `/v1/mcp` for API versioning consistency
- SRVR-03 requirement specifies `--transport=stdio` flag, but implementation uses simpler `--stdio` boolean flag
These are intentional implementation decisions. Requirement documentation should be updated to match.
  </how-to-verify>

  <resume-signal>
Type one of:
- "approved" - All tests passed, phase complete
- "partial: [description]" - Some tests passed, issues found (describe them)
- "failed: [description]" - Critical failures (describe them)

Include any error messages or unexpected behavior observed.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 6 requirements validation:

- **SRVR-01**: Single HTTP server on port 8080 serves REST API, UI, and MCP
  - Verified by: Tests 1 and 4 - all three services respond on :8080

- **SRVR-02**: MCP endpoint available at `/v1/mcp` path on main server
  - Verified by: Test 1 step 4 - MCP initialize request succeeds
  - Note: Requirement docs say `/mcp`, implementation uses `/v1/mcp` for API versioning

- **SRVR-03**: MCP stdio transport remains available via `--stdio` flag
  - Verified by: Test 4 - --stdio flag works
  - Note: Requirement docs say `--transport=stdio`, implementation uses `--stdio` (simpler)

- **SRVR-04**: Graceful shutdown handles all components (REST, MCP, integrations)
  - Verified by: Test 3 - shutdown completes within 10s timeout

- **INTG-01**: Integration manager initializes with MCP server in consolidated mode
  - Verified by: Server startup logs show integration manager with MCP registry

- **INTG-02**: Dynamic tool registration works on consolidated server
  - Verified by: Test 2 - integration tools appear in tools/list

- **INTG-03**: Config hot-reload continues to work for integrations
  - Verified by: Test 5 (optional) - config changes trigger reload
</verification>

<success_criteria>
- [ ] Server starts successfully on port 8080
- [ ] REST API /health endpoint responds
- [ ] MCP endpoint /v1/mcp responds to StreamableHTTP initialize request
- [ ] MCP tools/list includes built-in tools (cluster_health, resource_timeline, etc.)
- [ ] Integration tools appear in tools/list if integrations configured
- [ ] Server shuts down cleanly within 10 seconds on SIGTERM
- [ ] --stdio flag enables stdio transport alongside HTTP
- [ ] HTTP continues to work when --stdio flag present
- [ ] No port conflicts or binding errors
- [ ] No "connection refused" errors to localhost:8080 from MCP server
</success_criteria>

<output>
After verification approved, create `.planning/phases/06-consolidated-server/06-02-SUMMARY.md`
</output>
