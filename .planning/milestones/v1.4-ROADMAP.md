# Milestone v1.4: Grafana Alerts Integration

**Shipped:** 2026-01-23
**Duration:** 1 day (2026-01-23)
**Phases:** 20-23 (4 phases)
**Plans:** 10 completed
**Requirements:** 22 satisfied
**LOC:** ~4,630 (internal/integration/grafana/)

## Milestone Goal

Extend Grafana integration with alert rule ingestion, graph linking, and progressive disclosure MCP tools for incident response.

## What Was Delivered

### Phase 20: Alert API Client & Graph Schema
**Goal:** Alert rules are synced from Grafana and stored in FalkorDB with links to existing Metrics and Services.
**Completed:** 2026-01-23

Key deliverables:
- Alert rule fetching via Grafana Alerting API (ListAlertRules)
- AlertNode schema with 9 metadata fields (name, severity, labels, state, integration)
- Incremental sync based on version/updated timestamp (ISO8601 string comparison)
- Alert→Metric relationships via MONITORS edges (reuses PromQL parser)
- Alert→Service relationships transitive through Metric nodes (no direct edge)
- AlertQuery.Model as json.RawMessage for flexible PromQL parsing

### Phase 21: Alert Sync Pipeline
**Goal:** Alert state is continuously tracked with full state transition timeline stored in graph.
**Completed:** 2026-01-23

Key deliverables:
- Prometheus-compatible /api/prometheus/grafana/api/v1/rules endpoint for states
- STATE_TRANSITION self-edges with 7-day TTL (expires_at RFC3339)
- State deduplication via getLastKnownState comparison
- State normalization ("alerting" → "firing", lowercase)
- AlertStateSyncer with 5-minute periodic sync
- Worst-case state aggregation across alert instances

### Phase 22: Historical Analysis
**Goal:** AI can identify flapping alerts and compare current alert behavior to 7-day baseline.
**Completed:** 2026-01-23

Key deliverables:
- Flappiness detection with exponential scaling (1 - exp(-k*count))
- 7-day rolling baseline with LOCF daily buckets
- Multi-label categorization (onset: NEW, RECENT, CHRONIC; pattern: flapping, stable)
- AlertAnalysisService with 1000-entry LRU cache (5-minute TTL)
- Duration multipliers penalize short-lived states (1.3x) vs long-lived (0.8x)
- Sample variance (N-1) via gonum/stat.StdDev

### Phase 23: MCP Tools
**Goal:** AI can discover firing alerts, analyze state progression, and drill into full timeline through three progressive disclosure tools.
**Completed:** 2026-01-23

Key deliverables:
- `grafana_{name}_alerts_overview` — counts by severity with flappiness indicators
- `grafana_{name}_alerts_aggregated` — specific alerts with 1h state timeline [F F N N]
- `grafana_{name}_alerts_details` — full 7-day state history with rule definition
- 10-minute bucket timeline with LOCF interpolation
- All filter parameters optional for maximum flexibility
- Category display format: "CHRONIC + flapping" combines onset and pattern
- 959 lines of integration tests with progressive disclosure workflow validation

## Key Decisions Made

| Decision | Rationale |
|----------|-----------|
| Self-edge pattern for state transitions | (Alert)-[STATE_TRANSITION]->(Alert) simpler than separate node |
| 7-day TTL via expires_at timestamp | Query-time filtering, no cleanup job needed |
| 5-minute state sync interval | More responsive than 1-hour rule sync |
| Exponential flappiness scaling | Penalizes rapid transitions more than linear |
| LOCF interpolation for timelines | Fills gaps realistically |
| Flappiness threshold 0.7 | Balances sensitivity and noise |
| Optional filter parameters | Maximum flexibility for AI queries |
| 10-minute timeline buckets | Compact notation, 6 buckets per hour |

## Files Created

**Phase 20 (Alert API & Schema):**
- Alert methods in `internal/integration/grafana/client.go`
- AlertNode in `internal/integration/grafana/types.go`
- Alert graph builder in `internal/integration/grafana/graph_builder.go`

**Phase 21 (Sync Pipeline):**
- `internal/integration/grafana/alert_syncer.go`
- `internal/integration/grafana/alert_syncer_test.go`
- `internal/integration/grafana/alert_state_syncer.go`
- `internal/integration/grafana/alert_state_syncer_test.go`
- `internal/integration/grafana/transitions.go`

**Phase 22 (Historical Analysis):**
- `internal/integration/grafana/flappiness.go`
- `internal/integration/grafana/flappiness_test.go`
- `internal/integration/grafana/baseline.go` (alert-specific)
- `internal/integration/grafana/baseline_test.go`
- `internal/integration/grafana/categorization.go`
- `internal/integration/grafana/categorization_test.go`
- `internal/integration/grafana/alert_analysis_service.go`
- `internal/integration/grafana/alert_analysis_service_test.go`

**Phase 23 (MCP Tools):**
- `internal/integration/grafana/tools_alerts_overview.go`
- `internal/integration/grafana/tools_alerts_aggregated.go`
- `internal/integration/grafana/tools_alerts_details.go`
- `internal/integration/grafana/tools_alerts_integration_test.go`

## Audit Results

| Category | Score |
|----------|-------|
| Requirements | 22/22 (100%) |
| Phases | 4/4 (100%) |
| Integration | 15/15 exports connected |
| E2E Flows | 4/4 complete |

**No gaps. No tech debt. All tests passing.**

## Stats Summary

| Metric | Value |
|--------|-------|
| Phases | 4 |
| Plans | 10 |
| Requirements | 22 |
| LOC added | ~4,630 |
| Test LOC | ~1,500 |
| Duration | 1 day |

---
*Milestone archived: 2026-01-23*
