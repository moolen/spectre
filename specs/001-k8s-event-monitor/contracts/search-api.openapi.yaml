openapi: 3.0.0
info:
  title: Kubernetes Event Monitor - Search API
  version: 1.0.0
  description: |
    API for querying historical Kubernetes resource events captured by the monitoring system.

    Supports querying events within a time window with flexible filtering by resource dimensions.

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: http://k8s-event-monitor:8080
    description: Kubernetes cluster service

paths:
  /v1/search:
    get:
      summary: Search historical events
      description: |
        Query events from the storage system with optional filtering by resource dimensions.

        Returns all events within the specified time window, optionally filtered by:
        - Individual dimension (e.g., kind=Deployment)
        - Multiple dimensions (e.g., kind=Deployment AND namespace=default)
        - Any combination of group, version, kind, namespace

        If no filters are specified, returns all events in the time window.
        If namespace is specified alone, returns all resources in that namespace regardless of type.

      operationId: searchEvents
      parameters:
        - name: start
          in: query
          required: true
          schema:
            type: integer
            format: int64
            description: Start timestamp (Unix seconds, inclusive)
          example: 1700000000

        - name: end
          in: query
          required: true
          schema:
            type: integer
            format: int64
            description: End timestamp (Unix seconds, inclusive)
          example: 1700086400

        - name: kind
          in: query
          required: false
          schema:
            type: string
            description: Resource kind (e.g., Deployment, Pod, Node, Service)
          example: Deployment

        - name: namespace
          in: query
          required: false
          schema:
            type: string
            description: Kubernetes namespace (omit for cluster-scoped resources)
          example: default

        - name: group
          in: query
          required: false
          schema:
            type: string
            description: API group (e.g., apps, batch, empty string for core API)
          example: apps

        - name: version
          in: query
          required: false
          schema:
            type: string
            description: API version (e.g., v1, v1beta1)
          example: v1

      responses:
        '200':
          description: Successful query, returns matching events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
              examples:
                deploymentEvents:
                  summary: Deployments in default namespace
                  value:
                    count: 3
                    events:
                      - id: 550e8400-e29b-41d4-a716-446655440000
                        timestamp: 1700000000000000000
                        type: CREATE
                        resource:
                          group: apps
                          version: v1
                          kind: Deployment
                          namespace: default
                          name: nginx-deployment
                          uid: 550e8400-e29b-41d4-a716-446655440001
                        data:
                          metadata:
                            name: nginx-deployment
                            namespace: default
                          spec:
                            replicas: 3
                      - id: 550e8400-e29b-41d4-a716-446655440002
                        timestamp: 1700003600000000000
                        type: UPDATE
                        resource:
                          group: apps
                          version: v1
                          kind: Deployment
                          namespace: default
                          name: nginx-deployment
                          uid: 550e8400-e29b-41d4-a716-446655440001
                        data:
                          metadata:
                            name: nginx-deployment
                            namespace: default
                          spec:
                            replicas: 5
                      - id: 550e8400-e29b-41d4-a716-446655440003
                        timestamp: 1700007200000000000
                        type: DELETE
                        resource:
                          group: apps
                          version: v1
                          kind: Deployment
                          namespace: default
                          name: nginx-deployment
                          uid: 550e8400-e29b-41d4-a716-446655440001
                        data: null
                    executionTimeMs: 145
                    segmentsScanned: 24
                    segmentsSkipped: 0
                    filesSearched: 1

        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidTimestamps:
                  value:
                    error: INVALID_REQUEST
                    message: start timestamp must be less than or equal to end timestamp

        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                internalError:
                  value:
                    error: INTERNAL_ERROR
                    message: failed to read storage files

components:
  schemas:
    SearchResponse:
      type: object
      required:
        - count
        - events
        - executionTimeMs
        - segmentsScanned
        - filesSearched
      properties:
        count:
          type: integer
          format: int32
          description: Number of events returned
          minimum: 0
        events:
          type: array
          description: Array of matching events
          items:
            $ref: '#/components/schemas/Event'
        executionTimeMs:
          type: integer
          format: int32
          description: Query execution time in milliseconds
          minimum: 0
        segmentsScanned:
          type: integer
          format: int32
          description: Number of storage segments examined
          minimum: 0
        segmentsSkipped:
          type: integer
          format: int32
          description: Number of storage segments skipped via metadata filtering
          minimum: 0
        filesSearched:
          type: integer
          format: int32
          description: Number of hourly storage files searched
          minimum: 0

    Event:
      type: object
      required:
        - id
        - timestamp
        - type
        - resource
      properties:
        id:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: integer
          format: int64
          description: Event capture timestamp (Unix nanoseconds)
        type:
          type: string
          enum:
            - CREATE
            - UPDATE
            - DELETE
          description: Type of resource change
        resource:
          $ref: '#/components/schemas/ResourceMetadata'
        data:
          type: object
          nullable: true
          description: |
            Full Kubernetes resource object (for CREATE/UPDATE events).
            Null for DELETE events.
            Has managedFields removed.
        dataSize:
          type: integer
          format: int32
          description: Uncompressed size of data in bytes
        compressedSize:
          type: integer
          format: int32
          description: Compressed size of data in bytes

    ResourceMetadata:
      type: object
      required:
        - group
        - version
        - kind
        - name
        - uid
      properties:
        group:
          type: string
          description: |
            API group of the resource.
            Empty string for core API resources (Pod, Service, etc.)
          example: apps
        version:
          type: string
          description: API version of the resource
          example: v1
        kind:
          type: string
          description: Resource kind
          example: Deployment
        namespace:
          type: string
          description: |
            Kubernetes namespace.
            Empty string for cluster-scoped resources (Node, ClusterRole, etc.)
          example: default
        name:
          type: string
          description: Resource name
          example: nginx-deployment
        uid:
          type: string
          format: uuid
          description: Unique identifier for this resource in the cluster

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          enum:
            - INVALID_REQUEST
            - NOT_FOUND
            - INTERNAL_ERROR
          description: Error code
        message:
          type: string
          description: Human-readable error message

tags:
  - name: Search
    description: Event search and retrieval operations
