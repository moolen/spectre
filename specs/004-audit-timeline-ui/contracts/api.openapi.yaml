openapi: 3.0.0
info:
  title: Audit Timeline UI API
  version: 1.0.0
  description: Backend API for Audit Timeline UI - provides metadata and audit event data

servers:
  - url: /api
    description: API server

paths:
  /metadata:
    get:
      summary: Get metadata for filter dropdowns
      description: Returns available namespaces and resource kinds with resource counts
      operationId: getMetadata
      tags:
        - Metadata
      responses:
        '200':
          description: Metadata retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetadataResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /resources:
    get:
      summary: Get all timeline resources and segments
      description: Fetch complete timeline data including all resources and their status segments
      operationId: getResources
      tags:
        - Resources
      parameters:
        - name: namespace
          in: query
          required: false
          description: Filter by specific namespace (comma-separated for multiple)
          schema:
            type: string
            example: "default,kube-system"
        - name: kind
          in: query
          required: false
          description: Filter by resource kind (comma-separated for multiple)
          schema:
            type: string
            example: "Pod,Deployment"
        - name: startTime
          in: query
          required: false
          description: Filter segments after this timestamp (RFC3339)
          schema:
            type: string
            format: date-time
        - name: endTime
          in: query
          required: false
          description: Filter segments before this timestamp (RFC3339)
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Resources and segments retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResourcesResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /events/{resourceId}:
    get:
      summary: Get audit events for a specific resource
      description: Returns all audit events associated with a resource, optionally filtered by time window
      operationId: getResourceEvents
      tags:
        - Events
      parameters:
        - name: resourceId
          in: path
          required: true
          description: Resource identifier (format: namespace-name-kind)
          schema:
            type: string
            example: "default-nginx-pod"
        - name: startTime
          in: query
          required: false
          description: Filter events after this timestamp (RFC3339)
          schema:
            type: string
            format: date-time
        - name: endTime
          in: query
          required: false
          description: Filter events before this timestamp (RFC3339)
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Events retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'
        '404':
          description: Resource not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    MetadataResponse:
      type: object
      required:
        - namespaces
        - kinds
      properties:
        namespaces:
          type: array
          items:
            $ref: '#/components/schemas/Namespace'
          description: Available Kubernetes namespaces
        kinds:
          type: array
          items:
            $ref: '#/components/schemas/Kind'
          description: Available resource kinds
      example:
        namespaces:
          - name: "default"
            resourceCount: 15
          - name: "kube-system"
            resourceCount: 42
        kinds:
          - name: "Pod"
            group: ""
            version: "v1"
            resourceCount: 10
          - name: "Deployment"
            group: "apps"
            version: "v1"
            resourceCount: 5

    Namespace:
      type: object
      required:
        - name
        - resourceCount
      properties:
        name:
          type: string
          description: Kubernetes namespace identifier
          example: "default"
        displayName:
          type: string
          description: Human-readable display name (defaults to name)
          example: "Default Namespace"
        resourceCount:
          type: integer
          minimum: 0
          description: Number of audited resources in this namespace
          example: 15

    Kind:
      type: object
      required:
        - name
        - resourceCount
      properties:
        name:
          type: string
          description: Resource kind name
          example: "Pod"
        group:
          type: string
          description: API group (empty string for core v1)
          example: "apps"
        version:
          type: string
          description: API version
          example: "v1"
        displayName:
          type: string
          description: Human-readable display name
          example: "Pod"
        resourceCount:
          type: integer
          minimum: 0
          description: Number of resources of this kind
          example: 10

    ResourcesResponse:
      type: object
      required:
        - resources
      properties:
        resources:
          type: array
          items:
            $ref: '#/components/schemas/Resource'
          description: Array of resources with their segments

    Resource:
      type: object
      required:
        - id
        - name
        - kind
        - namespace
        - createdAt
        - segments
      properties:
        id:
          type: string
          description: Unique resource identifier
          example: "default-nginx-1"
        name:
          type: string
          description: Resource name
          example: "nginx"
        kind:
          type: string
          description: Resource kind
          example: "Pod"
        apiVersion:
          type: string
          description: API version
          example: "v1"
        namespace:
          type: string
          description: Kubernetes namespace
          example: "default"
        createdAt:
          type: string
          format: date-time
          description: Resource creation timestamp
          example: "2025-11-20T10:00:00Z"
        deletedAt:
          type: string
          format: date-time
          nullable: true
          description: Resource deletion timestamp (null if still exists)
          example: null
        labels:
          type: object
          additionalProperties:
            type: string
          description: Kubernetes labels
          example:
            app: "nginx"
            env: "production"
        segments:
          type: array
          items:
            $ref: '#/components/schemas/Segment'
          description: Status segments for this resource, chronologically ordered

    Segment:
      type: object
      required:
        - id
        - status
        - startTime
        - endTime
        - configuration
      properties:
        id:
          type: string
          description: Unique segment identifier
          example: "seg-uuid-1"
        status:
          type: string
          enum:
            - Ready
            - Warning
            - Error
            - Terminating
            - Unknown
          description: Resource status during this segment
          example: "Ready"
        startTime:
          type: string
          format: date-time
          description: Segment start timestamp
          example: "2025-11-20T10:00:00Z"
        endTime:
          type: string
          format: date-time
          description: Segment end timestamp
          example: "2025-11-21T14:30:00Z"
        message:
          type: string
          nullable: true
          description: Status message
          example: "Pod is running normally"
        configuration:
          type: object
          description: JSON configuration snapshot at segment start
          example:
            spec:
              containers:
                - name: "nginx"
                  image: "nginx:latest"

    EventsResponse:
      type: object
      required:
        - events
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/AuditEvent'
          description: Array of audit events for the resource

    AuditEvent:
      type: object
      required:
        - id
        - timestamp
        - eventType
      properties:
        id:
          type: string
          description: Unique event identifier
          example: "evt-uuid-1"
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
          example: "2025-11-20T10:00:15Z"
        eventType:
          type: string
          description: Type of audit event
          enum:
            - create
            - update
            - patch
            - delete
            - status
          example: "create"
        user:
          type: string
          nullable: true
          description: User or service account that triggered the event
          example: "kubectl"
        changes:
          type: object
          nullable: true
          description: Structured representation of what changed
          example:
            added:
              spec.replicas: 3
            modified:
              metadata.labels.version: "1.0"
            removed:
              metadata.annotations.note: "old value"
        message:
          type: string
          nullable: true
          description: Human-readable event description
          example: "Pod created successfully"

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: "Invalid query parameters"
        details:
          type: string
          nullable: true
          description: Additional error details
          example: "namespace filter contains invalid characters"

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalError:
      description: Server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
