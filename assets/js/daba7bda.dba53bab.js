"use strict";(globalThis.webpackChunkspectre_docs=globalThis.webpackChunkspectre_docs||[]).push([[6815],{1909:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"architecture/query-execution","title":"Query Execution","description":"Query pipeline, optimization, and performance characteristics","source":"@site/docs/architecture/query-execution.md","sourceDirName":"architecture","slug":"/architecture/query-execution","permalink":"/spectre/docs/architecture/query-execution","draft":false,"unlisted":false,"editUrl":"https://github.com/moolen/spectre/tree/master/docs/docs/architecture/query-execution.md","tags":[],"version":"current","lastUpdatedBy":"Moritz Johner","lastUpdatedAt":1765616329000,"frontMatter":{"title":"Query Execution","description":"Query pipeline, optimization, and performance characteristics","keywords":["architecture","query","execution","cache","performance"]},"sidebar":"docsSidebar","previous":{"title":"Compression","permalink":"/spectre/docs/architecture/compression"},"next":{"title":"Data Flow","permalink":"/spectre/docs/architecture/data-flow"}}');var t=s(4848),r=s(8453);const c={title:"Query Execution",description:"Query pipeline, optimization, and performance characteristics",keywords:["architecture","query","execution","cache","performance"]},l="Query Execution",d={},a=[{value:"Query Pipeline Overview",id:"query-pipeline-overview",level:2},{value:"Stage 1: Request Validation",id:"stage-1-request-validation",level:2},{value:"Stage 2: File Selection",id:"stage-2-file-selection",level:2},{value:"Stage 3: Per-File Query",id:"stage-3-per-file-query",level:2},{value:"3.1 Index Loading",id:"31-index-loading",level:3},{value:"3.2 Block Filtering (Inverted Indexes)",id:"32-block-filtering-inverted-indexes",level:3},{value:"3.3 Time Range Filtering",id:"33-time-range-filtering",level:3},{value:"3.4 Block Decompression (with Cache)",id:"34-block-decompression-with-cache",level:3},{value:"Stage 4: Result Merging",id:"stage-4-result-merging",level:2},{value:"4.1 Combining Events",id:"41-combining-events",level:3},{value:"4.2 State Snapshot Integration",id:"42-state-snapshot-integration",level:3},{value:"4.3 Sorting and Limiting",id:"43-sorting-and-limiting",level:3},{value:"Stage 5: Response Serialization",id:"stage-5-response-serialization",level:2},{value:"Block Cache",id:"block-cache",level:2},{value:"LRU Cache Design",id:"lru-cache-design",level:3},{value:"Cache Operations",id:"cache-operations",level:3},{value:"Cache Metrics",id:"cache-metrics",level:3},{value:"Cache Hit Rate Scenarios",id:"cache-hit-rate-scenarios",level:3},{value:"Performance Metrics",id:"performance-metrics",level:2},{value:"Query Response Time",id:"query-response-time",level:3},{value:"Query Performance by Time Range",id:"query-performance-by-time-range",level:3},{value:"Cache Impact on Performance",id:"cache-impact-on-performance",level:3},{value:"Optimization Strategies",id:"optimization-strategies",level:2},{value:"\u2705 Do",id:"-do",level:3},{value:"\u274c Don&#39;t",id:"-dont",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"query-execution",children:"Query Execution"})}),"\n",(0,t.jsx)(n.p,{children:"This document explains how Spectre executes queries efficiently using multi-stage filtering, caching, and state snapshot integration."}),"\n",(0,t.jsx)(n.h2,{id:"query-pipeline-overview",children:"Query Pipeline Overview"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  API Request: GET /api/v1/query?kind=Pod&time=[10:00,11:00]     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                         \u2502\n                         v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Stage 1: Request Validation                                     \u2502\n\u2502  - Parse query parameters                                        \u2502\n\u2502  - Validate time range, filters                                  \u2502\n\u2502  - Apply defaults (limit, ordering)                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                         \u2502\n                         v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Stage 2: File Selection (by time)                               \u2502\n\u2502  - List hourly files in data directory                           \u2502\n\u2502  - Filter by hour overlap with query time range                  \u2502\n\u2502  - Include one file before start (for state snapshots)           \u2502\n\u2502  Result: 1-24 files (typical: 2-3 files)                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                         \u2502\n                         v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Stage 3: Per-File Query (parallel)                              \u2502\n\u2502  For each file:                                                   \u2502\n\u2502    \u251c\u2500 Read footer \u2192 index section                                \u2502\n\u2502    \u251c\u2500 Filter blocks (inverted index + Bloom filters + time)      \u2502\n\u2502    \u251c\u2500 Decompress candidate blocks (with cache)                   \u2502\n\u2502    \u251c\u2500 Parse events from protobuf                                 \u2502\n\u2502    \u251c\u2500 Apply in-memory filters                                    \u2502\n\u2502    \u2514\u2500 Collect matching events                                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                         \u2502\n                         v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Stage 4: Result Merging                                         \u2502\n\u2502  - Combine events from all files                                 \u2502\n\u2502  - Add state snapshot events (for pre-existing resources)        \u2502\n\u2502  - Sort by timestamp (ascending)                                 \u2502\n\u2502  - Apply limit                                                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                         \u2502\n                         v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Stage 5: Response Serialization                                 \u2502\n\u2502  - Convert events to API format                                  \u2502\n\u2502  - Add query metadata (total, duration)                          \u2502\n\u2502  - Return JSON response                                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,t.jsx)(n.h2,{id:"stage-1-request-validation",children:"Stage 1: Request Validation"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Input:"})," HTTP query parameters\n",(0,t.jsx)(n.strong,{children:"Output:"})," Validated QueryRequest"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type QueryRequest struct {\n    StartTime int64  // Unix nanoseconds\n    EndTime   int64  // Unix nanoseconds\n    Kind      string // Optional filter\n    Namespace string // Optional filter\n    Group     string // Optional filter\n    Limit     int32  // Max results (default: 1000)\n    OrderBy   string // "asc" or "desc"\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Validation:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"StartTime"})," must be before ",(0,t.jsx)(n.code,{children:"EndTime"})]}),"\n",(0,t.jsx)(n.li,{children:"Time range must be reasonable (not > 1 year)"}),"\n",(0,t.jsx)(n.li,{children:"Limit must be 1-10,000"}),"\n",(0,t.jsx)(n.li,{children:"Filter values must be valid (no SQL injection)"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Performance:"})," <1 ms"]}),"\n",(0,t.jsx)(n.h2,{id:"stage-2-file-selection",children:"Stage 2: File Selection"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Goal:"})," Identify hourly files that overlap the query time range"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'func SelectFiles(dataDir string, startTime, endTime int64) ([]string, error) {\n    var selectedFiles []string\n\n    // List all .bin files\n    files, _ := os.ReadDir(dataDir)\n\n    for _, file := range files {\n        // Parse hour from filename: YYYY-MM-DD-HH.bin\n        fileHour := ParseHourFromFilename(file.Name())\n\n        // Check if file hour overlaps query range\n        fileStart := fileHour.Unix()\n        fileEnd := fileHour.Add(1 * time.Hour).Unix()\n\n        if fileEnd >= startTime && fileStart \\<= endTime {\n            selectedFiles = append(selectedFiles, file.Name())\n        }\n    }\n\n    // Include one file before start time (for state snapshots)\n    if len(selectedFiles) > 0 {\n        previousFile := GetPreviousHourFile(selectedFiles[0])\n        if previousFile != "" {\n            selectedFiles = append([]string{previousFile}, selectedFiles...)\n        }\n    }\n\n    return selectedFiles, nil\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Query: [2025-12-12 10:30:00, 2025-12-12 11:15:00]\nFiles:\n  2025-12-12-09.bin (for state snapshots)\n  2025-12-12-10.bin (overlaps query)\n  2025-12-12-11.bin (overlaps query)\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Performance:"})," <5 ms (directory listing + parsing)"]}),"\n",(0,t.jsx)(n.h2,{id:"stage-3-per-file-query",children:"Stage 3: Per-File Query"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Most Complex Stage:"})," Multi-level filtering and decompression"]}),"\n",(0,t.jsx)(n.h3,{id:"31-index-loading",children:"3.1 Index Loading"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// Read footer to locate index\nfooter := ReadFileFooter(filePath)\n\n// Read index section\nindexData := ReadAt(filePath, footer.IndexOffset, footer.IndexLength)\nindex := json.Unmarshal(indexData)\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Performance:"})," ~10-20 ms per file (depends on index size)"]}),"\n",(0,t.jsx)(n.h3,{id:"32-block-filtering-inverted-indexes",children:"3.2 Block Filtering (Inverted Indexes)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'// Build filter map from query\nfilters := map[string]string{\n    "kind": query.Kind,\n    "namespace": query.Namespace,\n    "group": query.Group,\n}\n\n// Get candidate blocks using inverted indexes\ncandidateBlocks := GetCandidateBlocks(index.InvertedIndexes, filters)\n\n// Example:\n// kind=Pod \u2192 blocks [0, 1, 3, 7, 9]\n// namespace=default \u2192 blocks [0, 1, 2, 3]\n// Intersection \u2192 blocks [0, 1, 3]\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Performance:"})," <2 ms (map lookups + intersection)\n",(0,t.jsx)(n.strong,{children:"Skip Rate:"})," 90-98% of blocks (typical)"]}),"\n",(0,t.jsx)(n.h3,{id:"33-time-range-filtering",children:"3.3 Time Range Filtering"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"var timeFilteredBlocks []int32\n\nfor _, blockID := range candidateBlocks {\n    blockMeta := index.BlockMetadata[blockID]\n\n    // Check if block overlaps query time range\n    if blockMeta.TimestampMax >= query.StartTime &&\n       blockMeta.TimestampMin <= query.EndTime {\n        timeFilteredBlocks = append(timeFilteredBlocks, blockID)\n    }\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Performance:"})," <1 ms (linear scan of candidate blocks)\n",(0,t.jsx)(n.strong,{children:"Additional Skip Rate:"})," 30-60% of candidates"]}),"\n",(0,t.jsx)(n.h3,{id:"34-block-decompression-with-cache",children:"3.4 Block Decompression (with Cache)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'for _, blockID := range timeFilteredBlocks {\n    blockMeta := index.BlockMetadata[blockID]\n\n    // Check cache first\n    cacheKey := fmt.Sprintf("%s:%d", filePath, blockID)\n    if cachedEvents, ok := cache.Get(cacheKey); ok {\n        // Cache hit - use decompressed events\n        events = cachedEvents\n    } else {\n        // Cache miss - read and decompress\n        compressedData := ReadBlockData(filePath, blockMeta.Offset, blockMeta.CompressedLength)\n        uncompressedData := gzip.Decompress(compressedData)\n        events := protobuf.Parse(uncompressedData)\n\n        // Store in cache\n        cache.Set(cacheKey, events)\n    }\n\n    // Filter events in memory\n    for _, event := range events {\n        if MatchesFilters(event, query) {\n            results = append(results, event)\n        }\n    }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Performance per block:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Cache hit: ~1 ms"}),"\n",(0,t.jsx)(n.li,{children:"Cache miss: ~30-50 ms (10 MB block)"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Cache Impact:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"First query: 100% cache misses"}),"\n",(0,t.jsx)(n.li,{children:"Repeated query: 80-90% cache hits"}),"\n",(0,t.jsx)(n.li,{children:"Dashboard queries: 60-80% cache hits"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"stage-4-result-merging",children:"Stage 4: Result Merging"}),"\n",(0,t.jsx)(n.h3,{id:"41-combining-events",children:"4.1 Combining Events"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"var allEvents []*Event\n\n// Collect from all files\nfor _, file := range files {\n    fileEvents := QueryFile(file, query)\n    allEvents = append(allEvents, fileEvents...)\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"42-state-snapshot-integration",children:"4.2 State Snapshot Integration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'// Get state snapshots from previous hour\'s file\nstateSnapshots := ReadStateSnapshots(files[0])\n\n// For each resource in snapshots\nfor resourceKey, state := range stateSnapshots {\n    // Check if resource has events in query range\n    hasEvents := false\n    for _, event := range allEvents {\n        if event.Resource.Key() == resourceKey {\n            hasEvents = true\n            break\n        }\n    }\n\n    // If no events but resource exists \u2192 create synthetic event\n    if !hasEvents && state.EventType != "DELETE" {\n        syntheticEvent := CreateStateEvent(state)\n        allEvents = append(allEvents, syntheticEvent)\n    }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Purpose:"})," Show resources that exist but have no events in query window"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'Previous hour: Deployment "nginx" created\nQuery hour: No events for "nginx"\nResult: Synthetic "state-" event shows Deployment still exists\n'})}),"\n",(0,t.jsx)(n.h3,{id:"43-sorting-and-limiting",children:"4.3 Sorting and Limiting"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// Sort by timestamp\nsort.Slice(allEvents, func(i, j int) bool {\n    return allEvents[i].Timestamp < allEvents[j].Timestamp\n})\n\n// Apply limit\nif len(allEvents) > query.Limit {\n    allEvents = allEvents[:query.Limit]\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Performance:"})," O(N log N) where N = result count"]}),"\n",(0,t.jsx)(n.h2,{id:"stage-5-response-serialization",children:"Stage 5: Response Serialization"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type QueryResponse struct {\n    Events     []*Event  `json:"events"`\n    Total      int32     `json:"total"`\n    Duration   int64     `json:"duration_ms"`\n    FilesScanned int32   `json:"files_scanned"`\n    BlocksRead int32     `json:"blocks_read"`\n}\n\n// Serialize to JSON\nresponseJSON := json.Marshal(response)\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Performance:"})," ~10-50 ms (depends on result size)"]}),"\n",(0,t.jsx)(n.h2,{id:"block-cache",children:"Block Cache"}),"\n",(0,t.jsx)(n.h3,{id:"lru-cache-design",children:"LRU Cache Design"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type BlockCache struct {\n    maxMemory int64                       // Max cache size (MB)\n    cache     map[string]*CachedBlock     // Key \u2192 cached block\n    lru       *list.List                  // LRU ordering\n    mutex     sync.RWMutex                // Thread-safe access\n\n    // Metrics\n    hits              int64\n    misses            int64\n    evictions         int64\n    bytesDecompressed int64\n}\n\ntype CachedBlock struct {\n    Key    string\n    Events []*Event\n    Size   int64\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"cache-operations",children:"Cache Operations"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Get (Read):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func (c *BlockCache) Get(key string) ([]*Event, bool) {\n    c.mutex.RLock()\n    defer c.mutex.RUnlock()\n\n    if block, ok := c.cache[key]; ok {\n        // Move to front of LRU\n        c.lru.MoveToFront(block.lruElement)\n        atomic.AddInt64(&c.hits, 1)\n        return block.Events, true\n    }\n\n    atomic.AddInt64(&c.misses, 1)\n    return nil, false\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Set (Write):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func (c *BlockCache) Set(key string, events []*Event, size int64) {\n    c.mutex.Lock()\n    defer c.mutex.Unlock()\n\n    // Evict if over capacity\n    for c.currentSize+size > c.maxMemory && c.lru.Len() > 0 {\n        oldest := c.lru.Back()\n        delete(c.cache, oldest.Value.Key)\n        c.currentSize -= oldest.Value.Size\n        c.lru.Remove(oldest)\n        atomic.AddInt64(&c.evictions, 1)\n    }\n\n    // Add to cache\n    c.cache[key] = &CachedBlock{Key: key, Events: events, Size: size}\n    c.currentSize += size\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"cache-metrics",children:"Cache Metrics"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type CacheMetrics struct {\n    MaxMemory         int64   `json:"max_memory_mb"`\n    UsedMemory        int64   `json:"used_memory_mb"`\n    Items             int64   `json:"items"`\n    Hits              int64   `json:"hits"`\n    Misses            int64   `json:"misses"`\n    HitRate           float64 `json:"hit_rate"`\n    Evictions         int64   `json:"evictions"`\n    BytesDecompressed int64   `json:"bytes_decompressed"`\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"API Endpoint:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'curl http://localhost:8080/api/v1/cache/stats\n\n{\n  "max_memory_mb": 100,\n  "used_memory_mb": 85,\n  "items": 42,\n  "hits": 1250,\n  "misses": 180,\n  "hit_rate": 0.87,\n  "evictions": 15,\n  "bytes_decompressed": 420000000\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"cache-hit-rate-scenarios",children:"Cache Hit Rate Scenarios"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Scenario"}),(0,t.jsx)(n.th,{children:"Hit Rate"}),(0,t.jsx)(n.th,{children:"Explanation"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Repeated query"}),(0,t.jsx)(n.td,{children:"90-95%"}),(0,t.jsx)(n.td,{children:"Same blocks accessed repeatedly"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Dashboard (5min refresh)"}),(0,t.jsx)(n.td,{children:"80-85%"}),(0,t.jsx)(n.td,{children:"Recent blocks stay hot"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Time-series query"}),(0,t.jsx)(n.td,{children:"60-70%"}),(0,t.jsx)(n.td,{children:"Some overlap, some new blocks"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Historical analysis"}),(0,t.jsx)(n.td,{children:"20-30%"}),(0,t.jsx)(n.td,{children:"Old blocks not in cache"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Ad-hoc exploration"}),(0,t.jsx)(n.td,{children:"10-20%"}),(0,t.jsx)(n.td,{children:"Random access pattern"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"performance-metrics",children:"Performance Metrics"}),"\n",(0,t.jsx)(n.h3,{id:"query-response-time",children:"Query Response Time"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Breakdown by stage:"})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Stage"}),(0,t.jsx)(n.th,{children:"Latency"}),(0,t.jsx)(n.th,{children:"Percentage"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Request validation"}),(0,t.jsx)(n.td,{children:"<1 ms"}),(0,t.jsx)(n.td,{children:"<1%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"File selection"}),(0,t.jsx)(n.td,{children:"~5 ms"}),(0,t.jsx)(n.td,{children:"~2%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Index loading"}),(0,t.jsx)(n.td,{children:"~20 ms"}),(0,t.jsx)(n.td,{children:"~8%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Block filtering"}),(0,t.jsx)(n.td,{children:"~3 ms"}),(0,t.jsx)(n.td,{children:"~1%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Decompression"}),(0,t.jsx)(n.td,{children:"~240 ms"}),(0,t.jsx)(n.td,{children:"~85%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Result merging"}),(0,t.jsx)(n.td,{children:"~10 ms"}),(0,t.jsx)(n.td,{children:"~4%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Total"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"~280 ms"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"100%"})})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Decompression dominates query time"})," (85% of latency)"]}),"\n",(0,t.jsx)(n.h3,{id:"query-performance-by-time-range",children:"Query Performance by Time Range"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Time Range"}),(0,t.jsx)(n.th,{children:"Files"}),(0,t.jsx)(n.th,{children:"Blocks Scanned"}),(0,t.jsx)(n.th,{children:"Decompression"}),(0,t.jsx)(n.th,{children:"Total Time"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"1 hour"}),(0,t.jsx)(n.td,{children:"1-2"}),(0,t.jsx)(n.td,{children:"5-10"}),(0,t.jsx)(n.td,{children:"~150 ms"}),(0,t.jsx)(n.td,{children:"~200 ms"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"6 hours"}),(0,t.jsx)(n.td,{children:"6-7"}),(0,t.jsx)(n.td,{children:"20-30"}),(0,t.jsx)(n.td,{children:"~600 ms"}),(0,t.jsx)(n.td,{children:"~700 ms"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"24 hours"}),(0,t.jsx)(n.td,{children:"24-25"}),(0,t.jsx)(n.td,{children:"80-120"}),(0,t.jsx)(n.td,{children:"~2400 ms"}),(0,t.jsx)(n.td,{children:"~2500 ms"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"7 days"}),(0,t.jsx)(n.td,{children:"168+"}),(0,t.jsx)(n.td,{children:"500-800"}),(0,t.jsx)(n.td,{children:"~15000 ms"}),(0,t.jsx)(n.td,{children:"~16000 ms"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Key Insight:"})," Query time scales linearly with blocks scanned (not total data size)"]}),"\n",(0,t.jsx)(n.h3,{id:"cache-impact-on-performance",children:"Cache Impact on Performance"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Scenario:"})," Repeated 1-hour query"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Attempt"}),(0,t.jsx)(n.th,{children:"Cache Hit Rate"}),(0,t.jsx)(n.th,{children:"Decompression Time"}),(0,t.jsx)(n.th,{children:"Total Time"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"First"}),(0,t.jsx)(n.td,{children:"0%"}),(0,t.jsx)(n.td,{children:"150 ms"}),(0,t.jsx)(n.td,{children:"200 ms"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Second"}),(0,t.jsx)(n.td,{children:"90%"}),(0,t.jsx)(n.td,{children:"15 ms"}),(0,t.jsx)(n.td,{children:"65 ms"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Third+"}),(0,t.jsx)(n.td,{children:"95%"}),(0,t.jsx)(n.td,{children:"7 ms"}),(0,t.jsx)(n.td,{children:"57 ms"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Improvement:"})," 3.5\xd7 faster with warm cache"]}),"\n",(0,t.jsx)(n.h2,{id:"optimization-strategies",children:"Optimization Strategies"}),"\n",(0,t.jsx)(n.h3,{id:"-do",children:"\u2705 Do"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Enable caching"})," (",(0,t.jsx)(n.code,{children:"--cache-enabled=true"}),") - 3\xd7 faster repeated queries"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Increase cache size"})," (",(0,t.jsx)(n.code,{children:"--cache-max-mb=200+"}),") - For read-heavy workloads"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Use specific filters"})," - Reduces blocks scanned (kind + namespace better than kind alone)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Limit time ranges"})," - Query last hour instead of last week when possible"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Apply limits"})," - Use ",(0,t.jsx)(n.code,{children:"limit=100"})," for dashboards vs unbounded queries"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"-dont",children:"\u274c Don't"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Don't query without filters"})," - Scans all blocks (slow)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Don't use very wide time ranges"})," - 7+ days takes 10+ seconds"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Don't disable cache"})," - Repeated queries will be slow"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Don't set limit too high"})," - Large result sets take time to serialize"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Don't query deleted resources"})," - Filter ",(0,t.jsx)(n.code,{children:"event_type != DELETE"})," for active resources"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/spectre/docs/architecture/storage-design",children:"Storage Design"})," - Overall architecture"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/spectre/docs/architecture/indexing-strategy",children:"Indexing Strategy"})," - Block filtering techniques"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/spectre/docs/architecture/compression",children:"Compression"})," - Decompression performance"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/spectre/docs/configuration/storage-settings",children:"Storage Settings"})," - Cache configuration"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>l});var i=s(6540);const t={},r=i.createContext(t);function c(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);