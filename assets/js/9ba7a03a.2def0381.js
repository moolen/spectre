"use strict";(globalThis.webpackChunkspectre_docs=globalThis.webpackChunkspectre_docs||[]).push([[1465],{4745:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"architecture/data-flow","title":"Data Flow","description":"End-to-end data flow through Spectre\'s write and read paths","source":"@site/docs/architecture/data-flow.md","sourceDirName":"architecture","slug":"/architecture/data-flow","permalink":"/spectre/docs/architecture/data-flow","draft":false,"unlisted":false,"editUrl":"https://github.com/moolen/spectre/tree/master/docs/docs/architecture/data-flow.md","tags":[],"version":"current","lastUpdatedBy":"Moritz Johner","lastUpdatedAt":1765616329000,"frontMatter":{"title":"Data Flow","description":"End-to-end data flow through Spectre\'s write and read paths","keywords":["architecture","data flow","write path","read path","pipeline"]},"sidebar":"docsSidebar","previous":{"title":"Query Execution","permalink":"/spectre/docs/architecture/query-execution"}}');var s=r(4848),i=r(8453);const d={title:"Data Flow",description:"End-to-end data flow through Spectre's write and read paths",keywords:["architecture","data flow","write path","read path","pipeline"]},l="Data Flow",c={},a=[{value:"System Overview",id:"system-overview",level:2},{value:"Write Path: Events to Storage",id:"write-path-events-to-storage",level:2},{value:"Complete Write Flow",id:"complete-write-flow",level:3},{value:"Write Path Timing",id:"write-path-timing",level:3},{value:"Concurrency Model (Write Path)",id:"concurrency-model-write-path",level:3},{value:"Error Handling (Write Path)",id:"error-handling-write-path",level:3},{value:"Read Path: Query to Results",id:"read-path-query-to-results",level:2},{value:"Complete Read Flow",id:"complete-read-flow",level:3},{value:"Read Path Timing",id:"read-path-timing",level:3},{value:"Concurrency Model (Read Path)",id:"concurrency-model-read-path",level:3},{value:"Query Optimization Examples",id:"query-optimization-examples",level:3},{value:"Example 1: No Filters (Full Scan)",id:"example-1-no-filters-full-scan",level:4},{value:"Example 2: Kind Filter",id:"example-2-kind-filter",level:4},{value:"Example 3: Kind + Namespace Filter",id:"example-3-kind--namespace-filter",level:4},{value:"Error Handling (Read Path)",id:"error-handling-read-path",level:3},{value:"Data Transformations",id:"data-transformations",level:2},{value:"Event Size Transformations",id:"event-size-transformations",level:3},{value:"Metadata Evolution",id:"metadata-evolution",level:3},{value:"Performance Characteristics",id:"performance-characteristics",level:2},{value:"Write Path Throughput",id:"write-path-throughput",level:3},{value:"Read Path Latency",id:"read-path-latency",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"data-flow",children:"Data Flow"})}),"\n",(0,s.jsx)(n.p,{children:"This document traces the complete journey of data through Spectre - from Kubernetes events arriving at the watcher to query results returned to the user."}),"\n",(0,s.jsx)(n.h2,{id:"system-overview",children:"System Overview"}),"\n",(0,s.jsx)(n.p,{children:"Spectre processes data through two independent paths:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Write Path"}),": Kubernetes events \u2192 Watcher \u2192 Storage"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Read Path"}),": API request \u2192 Query engine \u2192 Response"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"These paths are designed to minimize interference - writes happen continuously in the background while queries execute concurrently without blocking writes."}),"\n",(0,s.jsx)(n.h2,{id:"write-path-events-to-storage",children:"Write Path: Events to Storage"}),"\n",(0,s.jsx)(n.h3,{id:"complete-write-flow",children:"Complete Write Flow"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         Write Path                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nKubernetes API Server\n     \u2502 (Resource ADD/UPDATE/DELETE)\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 1. Watcher Component (internal/watcher/)                           \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502   ResourceEventHandler.OnAdd/OnUpdate/OnDelete                     \u2502\n\u2502   \u2514\u2500> Receives: Kubernetes runtime.Object                          \u2502\n\u2502   \u2514\u2500> Converts: Object \u2192 ResourceEvent struct                      \u2502\n\u2502        - ExtractMetadata(name, namespace, kind, apiVersion)        \u2502\n\u2502        - Capture timestamp, operation type, UID                    \u2502\n\u2502        - Marshal full object to JSON                               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 ResourceEvent (with managedFields ~10KB)\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 2. Pruning (internal/watcher/pruner.go)                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502   Remove metadata.managedFields                                    \u2502\n\u2502   \u2514\u2500> Typical size reduction: 80-90%                               \u2502\n\u2502   \u2514\u2500> Example: 10KB \u2192 1-2KB                                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 Pruned ResourceEvent (~1-2KB)\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 3. Validation (internal/watcher/validator.go)                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502   Check required fields exist:                                     \u2502\n\u2502   - UID, timestamp, kind, namespace, name                          \u2502\n\u2502   \u2514\u2500> Invalid events: Logged and discarded                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 Valid ResourceEvent\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 4. Event Queue (internal/watcher/event_queue.go)                   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502   Concurrent buffering: Channel-based queue                        \u2502\n\u2502   \u2514\u2500> Buffer size: 10000 events (configurable)                     \u2502\n\u2502   \u2514\u2500> Backpressure: Blocks watcher if queue full                   \u2502\n\u2502   \u2514\u2500> Batch drain: Worker goroutine processes events               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 Batched events (up to 100 at a time)\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 5. Storage Layer (internal/storage/)                               \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 storage.WriteEvent(event)                                          \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Get or Create Hourly File                                    \u2502\n\u2502   \u2502   - Check current hour: time.Now().Truncate(time.Hour)         \u2502\n\u2502   \u2502   - If hour changed: Close previous file, create new           \u2502\n\u2502   \u2502   - Carryover finalResourceStates to new file                  \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> blockStorageFile.WriteEvent(event)                           \u2502\n\u2502   \u2502   \u2502                                                             \u2502\n\u2502   \u2502   \u251c\u2500> Marshal event to JSON                                    \u2502\n\u2502   \u2502   \u2502   \u2514\u2500> json.Marshal(event) \u2192 []byte                         \u2502\n\u2502   \u2502   \u2502                                                             \u2502\n\u2502   \u2502   \u251c\u2500> Check buffer capacity                                    \u2502\n\u2502   \u2502   \u2502   \u2514\u2500> if currentBuffer.IsFull(len(eventJSON)):             \u2502\n\u2502   \u2502   \u2502       - Finalize current block (compress + write)          \u2502\n\u2502   \u2502   \u2502       - Create new EventBuffer                             \u2502\n\u2502   \u2502   \u2502                                                             \u2502\n\u2502   \u2502   \u251c\u2500> Add to EventBuffer                                       \u2502\n\u2502   \u2502   \u2502   - Append event JSON to buffer                            \u2502\n\u2502   \u2502   \u2502   - Update metadata sets (kinds, namespaces, groups)       \u2502\n\u2502   \u2502   \u2502   - Update Bloom filters                                   \u2502\n\u2502   \u2502   \u2502   - Track timestamp min/max                                \u2502\n\u2502   \u2502   \u2502                                                             \u2502\n\u2502   \u2502   \u2514\u2500> Update Final Resource States                             \u2502\n\u2502   \u2502       - Map key: group/version/kind/namespace/name             \u2502\n\u2502   \u2502       - Store: UID, EventType, Timestamp, ResourceData         \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u2514\u2500> Return (non-blocking)                                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 Event buffered in memory\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 6. Block Finalization (when buffer full)                           \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 currentBuffer.Finalize(blockID, "gzip")                            \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Encode events as Protobuf stream                             \u2502\n\u2502   \u2502   - Length-prefixed messages                                   \u2502\n\u2502   \u2502   - Each event: [length(4B)][protobuf_data]                    \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Compress with gzip                                           \u2502\n\u2502   \u2502   - Algorithm: klauspost/compress/gzip                         \u2502\n\u2502   \u2502   - Level: DefaultCompression (6)                              \u2502\n\u2502   \u2502   - Typical ratio: 75% reduction                               \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Create Block structure                                       \u2502\n\u2502   \u2502   - ID: sequential block number                                \u2502\n\u2502   \u2502   - Offset: current file position                              \u2502\n\u2502   \u2502   - Length: compressed data size                               \u2502\n\u2502   \u2502   - UncompressedLength: original size                          \u2502\n\u2502   \u2502   - EventCount: number of events                               \u2502\n\u2502   \u2502   - TimestampMin/Max: time range                               \u2502\n\u2502   \u2502   - Metadata: kinds, namespaces, groups, Bloom filters         \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Write compressed data to disk                                \u2502\n\u2502   \u2502   - Append to hourly file                                      \u2502\n\u2502   \u2502   - fsync() for durability (optional)                          \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u2514\u2500> Store block metadata for index                               \u2502\n\u2502       - Append to blockMetadataList (in-memory)                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 Block written to disk\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 7. File Closing (hour boundary or shutdown)                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 blockStorageFile.Close()                                           \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Finalize last buffer (if non-empty)                          \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Build Inverted Indexes                                       \u2502\n\u2502   \u2502   - KindToBlocks: "Pod" \u2192 [0, 2, 5, ...]                       \u2502\n\u2502   \u2502   - NamespaceToBlocks: "default" \u2192 [0, 1, 3, ...]              \u2502\n\u2502   \u2502   - GroupToBlocks: "apps" \u2192 [1, 2, 4, ...]                     \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Create IndexSection                                          \u2502\n\u2502   \u2502   - BlockMetadata: Array of block metadata                     \u2502\n\u2502   \u2502   - InvertedIndexes: Kind/namespace/group maps                 \u2502\n\u2502   \u2502   - Statistics: Event counts, compression ratios               \u2502\n\u2502   \u2502   - FinalResourceStates: Last state of each resource           \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Write index section (JSON)                                   \u2502\n\u2502   \u2502   - Record indexOffset = currentFilePosition                   \u2502\n\u2502   \u2502   - Write JSON-encoded IndexSection                            \u2502\n\u2502   \u2502   - Record indexLength = bytes written                         \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Write File Footer (324 bytes)                                \u2502\n\u2502   \u2502   - IndexSectionOffset: int64 (8 bytes)                        \u2502\n\u2502   \u2502   - IndexSectionLength: int32 (4 bytes)                        \u2502\n\u2502   \u2502   - Checksum: MD5 hash (256 bytes)                             \u2502\n\u2502   \u2502   - Reserved: padding (16 bytes)                               \u2502\n\u2502   \u2502   - MagicBytes: "RPKEND" (8 bytes)                             \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u2514\u2500> Close file handle                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 File sealed (immutable)\n     v\n  Ready for queries\n'})}),"\n",(0,s.jsx)(n.h3,{id:"write-path-timing",children:"Write Path Timing"}),"\n",(0,s.jsx)(n.p,{children:"For a typical event processing cycle:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Stage"}),(0,s.jsx)(n.th,{children:"Time"}),(0,s.jsx)(n.th,{children:"Notes"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Kubernetes API \u2192 Watcher"}),(0,s.jsx)(n.td,{children:"<1 ms"}),(0,s.jsx)(n.td,{children:"Watch stream notification"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Event conversion"}),(0,s.jsx)(n.td,{children:"~10 \xb5s"}),(0,s.jsx)(n.td,{children:"Object \u2192 ResourceEvent struct"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Pruning"}),(0,s.jsx)(n.td,{children:"~5 \xb5s"}),(0,s.jsx)(n.td,{children:"Remove managedFields"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Validation"}),(0,s.jsx)(n.td,{children:"~1 \xb5s"}),(0,s.jsx)(n.td,{children:"Check required fields"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Queue buffering"}),(0,s.jsx)(n.td,{children:"<1 \xb5s"}),(0,s.jsx)(n.td,{children:"Channel send"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Queue drain"}),(0,s.jsx)(n.td,{children:"~100 \xb5s"}),(0,s.jsx)(n.td,{children:"Batch processing"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"JSON marshal"}),(0,s.jsx)(n.td,{children:"~10 \xb5s"}),(0,s.jsx)(n.td,{children:"Event \u2192 JSON bytes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Buffer accumulation"}),(0,s.jsx)(n.td,{children:"~1 \xb5s"}),(0,s.jsx)(n.td,{children:"Append + metadata update"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Total (per event)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"~130 \xb5s"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Sustained: 7,500 events/sec"})})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Block finalization (periodic)"}),":"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Stage"}),(0,s.jsx)(n.th,{children:"Time"}),(0,s.jsx)(n.th,{children:"Notes"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Protobuf encode"}),(0,s.jsx)(n.td,{children:"~20 ms"}),(0,s.jsx)(n.td,{children:"10 MB uncompressed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"gzip compression"}),(0,s.jsx)(n.td,{children:"~100 ms"}),(0,s.jsx)(n.td,{children:"10 MB \u2192 2.5 MB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Disk write"}),(0,s.jsx)(n.td,{children:"~10 ms"}),(0,s.jsx)(n.td,{children:"Append to file"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Metadata tracking"}),(0,s.jsx)(n.td,{children:"~1 ms"}),(0,s.jsx)(n.td,{children:"Update indexes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Total"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"~130 ms"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Every ~800 events"})})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"File closing (hourly)"}),":"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Stage"}),(0,s.jsx)(n.th,{children:"Time"}),(0,s.jsx)(n.th,{children:"Notes"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Finalize last block"}),(0,s.jsx)(n.td,{children:"~130 ms"}),(0,s.jsx)(n.td,{children:"Same as block finalization"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Build inverted indexes"}),(0,s.jsx)(n.td,{children:"~50 ms"}),(0,s.jsx)(n.td,{children:"Process ~300 blocks"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Encode index JSON"}),(0,s.jsx)(n.td,{children:"~20 ms"}),(0,s.jsx)(n.td,{children:"Serialize index"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Write index"}),(0,s.jsx)(n.td,{children:"~10 ms"}),(0,s.jsx)(n.td,{children:"Write to disk"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Write footer"}),(0,s.jsx)(n.td,{children:"<1 ms"}),(0,s.jsx)(n.td,{children:"324 bytes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Total"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"~210 ms"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Once per hour"})})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"concurrency-model-write-path",children:"Concurrency Model (Write Path)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         Goroutines                              \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                 \u2502\n\u2502  Watcher Goroutines (one per resource type):                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u2502\n\u2502  \u2502 Pod Watcher  \u2502  \u2502 Deploy Watch \u2502  \u2502 Service Watch\u2502          \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2502\n\u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                  \u2502\n\u2502                           \u2502 Events                              \u2502\n\u2502                           v                                     \u2502\n\u2502                   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                             \u2502\n\u2502                   \u2502  Event Queue  \u2502 (buffered channel)          \u2502\n\u2502                   \u2502  cap=10000    \u2502                             \u2502\n\u2502                   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                             \u2502\n\u2502                           \u2502                                     \u2502\n\u2502                           v                                     \u2502\n\u2502                   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                             \u2502\n\u2502                   \u2502 Queue Worker  \u2502 (single goroutine)          \u2502\n\u2502                   \u2502 Drains queue  \u2502                             \u2502\n\u2502                   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                             \u2502\n\u2502                           \u2502                                     \u2502\n\u2502                           v                                     \u2502\n\u2502                   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                             \u2502\n\u2502                   \u2502 Storage Writer\u2502 (synchronized)              \u2502\n\u2502                   \u2502 Single writer \u2502                             \u2502\n\u2502                   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                             \u2502\n\u2502                                                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Key Points"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Multiple watchers"}),": One goroutine per resource type (parallelism)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Single queue"}),": All watchers feed into one event queue (serialization)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Single writer"}),": Only one goroutine writes to storage (no locking)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Buffered channel"}),": Decouples watchers from storage (backpressure tolerance)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"error-handling-write-path",children:"Error Handling (Write Path)"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Error Type"}),(0,s.jsx)(n.th,{children:"Handling"}),(0,s.jsx)(n.th,{children:"Impact"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Invalid event"})}),(0,s.jsx)(n.td,{children:"Log warning, discard event"}),(0,s.jsx)(n.td,{children:"Single event lost"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Queue full"})}),(0,s.jsx)(n.td,{children:"Block watcher until space available"}),(0,s.jsx)(n.td,{children:"Watcher backpressure"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Disk full"})}),(0,s.jsx)(n.td,{children:"Log error, return error to caller"}),(0,s.jsx)(n.td,{children:"Stops all writes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Compression error"})}),(0,s.jsx)(n.td,{children:"Log error, skip block finalization"}),(0,s.jsx)(n.td,{children:"Block data lost"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"File write error"})}),(0,s.jsx)(n.td,{children:"Retry 3 times with exponential backoff"}),(0,s.jsx)(n.td,{children:"Potential data loss if persistent"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Index build error"})}),(0,s.jsx)(n.td,{children:"Log error, file marked incomplete"}),(0,s.jsx)(n.td,{children:"File can't be queried"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Hour rotation error"})}),(0,s.jsx)(n.td,{children:"Log error, continue with same file"}),(0,s.jsx)(n.td,{children:"No new file created"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"read-path-query-to-results",children:"Read Path: Query to Results"}),"\n",(0,s.jsx)(n.h3,{id:"complete-read-flow",children:"Complete Read Flow"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                          Read Path                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nHTTP Client\n     \u2502 GET /api/search?start=X&end=Y&kind=Pod&namespace=default\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 1. API Server (internal/api/)                                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 search_handler.go:ServeHTTP()                                      \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Parse query parameters                                       \u2502\n\u2502   \u2502   - start (required): Unix timestamp (seconds or ms)           \u2502\n\u2502   \u2502   - end (required): Unix timestamp                             \u2502\n\u2502   \u2502   - kind (optional): e.g., "Pod", "Deployment"                 \u2502\n\u2502   \u2502   - namespace (optional): e.g., "default", "kube-system"       \u2502\n\u2502   \u2502   - group (optional): e.g., "apps", ""                         \u2502\n\u2502   \u2502   - version (optional): e.g., "v1"                             \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Validate parameters                                          \u2502\n\u2502   \u2502   - start < end (time range valid)                             \u2502\n\u2502   \u2502   - Range not too large (max 30 days)                          \u2502\n\u2502   \u2502   - Timestamps in valid format                                 \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u2514\u2500> Create Filter struct                                         \u2502\n\u2502       - TimeRange: [start, end]                                    \u2502\n\u2502       - ResourceFilters: {kind, namespace, group, version}         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 Filter{start, end, kind, namespace, group}\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 2. Query Engine (internal/storage/query.go)                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 storage.Query(filter)                                              \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Select Files by Time Window                                  \u2502\n\u2502   \u2502   - Hourly files: YYYY-MM-DD-HH.bin                            \u2502\n\u2502   \u2502   - Example: [10:00-14:00] \u2192 [10.bin, 11.bin, 12.bin, 13.bin] \u2502\n\u2502   \u2502   - Include one file before start (for state snapshots)        \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u2514\u2500> For each file (sequential):                                  \u2502\n\u2502       query_file.go:queryFile(path, filter)                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 File paths: [file1.bin, file2.bin, ...]\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 3. Per-File Query (internal/storage/query_file.go)                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 For each file:                                                     \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Read File Header (77 bytes)                                  \u2502\n\u2502   \u2502   - Validate magic bytes: "RPKBLOCK"                           \u2502\n\u2502   \u2502   - Check format version                                       \u2502\n\u2502   \u2502   - Read compression algorithm                                 \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Read File Footer (324 bytes from end)                        \u2502\n\u2502   \u2502   - Validate magic bytes: "RPKEND"                             \u2502\n\u2502   \u2502   - Extract indexSectionOffset                                 \u2502\n\u2502   \u2502   - Extract indexSectionLength                                 \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Read Index Section                                           \u2502\n\u2502   \u2502   - Seek to indexSectionOffset                                 \u2502\n\u2502   \u2502   - Read indexSectionLength bytes                              \u2502\n\u2502   \u2502   - Parse JSON \u2192 IndexSection struct                           \u2502\n\u2502   \u2502   - Load: BlockMetadata, InvertedIndexes, FinalResourceStates  \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Filter Blocks (by inverted indexes)                          \u2502\n\u2502   \u2502   - If filter.kind specified:                                  \u2502\n\u2502   \u2502     candidates = InvertedIndexes.KindToBlocks[filter.kind]     \u2502\n\u2502   \u2502   - If filter.namespace specified:                             \u2502\n\u2502   \u2502     candidates \u2229= InvertedIndexes.NamespaceToBlocks[ns]        \u2502\n\u2502   \u2502   - If filter.group specified:                                 \u2502\n\u2502   \u2502     candidates \u2229= InvertedIndexes.GroupToBlocks[group]         \u2502\n\u2502   \u2502   - Result: Subset of block IDs to decompress                  \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Binary Search Timestamp Index                                \u2502\n\u2502   \u2502   - BlockMetadata sorted by timestampMin                       \u2502\n\u2502   \u2502   - Find first block: block.timestampMax >= filter.start       \u2502\n\u2502   \u2502   - Find last block: block.timestampMin <= filter.end          \u2502\n\u2502   \u2502   - Intersect with candidates from inverted indexes            \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> For each candidate block:                                    \u2502\n\u2502   \u2502   \u2502                                                             \u2502\n\u2502   \u2502   \u251c\u2500> Read Block Data                                          \u2502\n\u2502   \u2502   \u2502   - Seek to block.offset                                   \u2502\n\u2502   \u2502   \u2502   - Read block.length bytes                                \u2502\n\u2502   \u2502   \u2502                                                             \u2502\n\u2502   \u2502   \u251c\u2500> Decompress Block                                         \u2502\n\u2502   \u2502   \u2502   - gzip.Decompress(compressedData)                        \u2502\n\u2502   \u2502   \u2502   - Result: Protobuf-encoded event stream                  \u2502\n\u2502   \u2502   \u2502                                                             \u2502\n\u2502   \u2502   \u251c\u2500> Decode Protobuf Events                                   \u2502\n\u2502   \u2502   \u2502   - Read length-prefixed messages                          \u2502\n\u2502   \u2502   \u2502   - Unmarshal each: protobuf \u2192 ResourceEvent               \u2502\n\u2502   \u2502   \u2502                                                             \u2502\n\u2502   \u2502   \u251c\u2500> Filter Events (exact match)                              \u2502\n\u2502   \u2502   \u2502   - Check timestamp in [filter.start, filter.end]          \u2502\n\u2502   \u2502   \u2502   - Check kind == filter.kind (if specified)               \u2502\n\u2502   \u2502   \u2502   - Check namespace == filter.namespace (if specified)     \u2502\n\u2502   \u2502   \u2502   - Check group == filter.group (if specified)             \u2502\n\u2502   \u2502   \u2502                                                             \u2502\n\u2502   \u2502   \u2514\u2500> Collect matching events                                  \u2502\n\u2502   \u2502       - Append to results array                                \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u2514\u2500> Include Final Resource States (if in time range)             \u2502\n\u2502       - For resources with no events in window but state exists    \u2502\n\u2502       - Generate synthetic "state-" events                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 Events from all files\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 4. Result Aggregation (internal/storage/query.go)                  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502   Combine results from all files                                  \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Merge event arrays                                           \u2502\n\u2502   \u2502   - Concatenate results from each file                         \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Sort by timestamp (ascending)                                \u2502\n\u2502   \u2502   - Sort all events chronologically                            \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u251c\u2500> Apply result limit (if specified)                            \u2502\n\u2502   \u2502   - Truncate to max results (e.g., 10000)                      \u2502\n\u2502   \u2502                                                                 \u2502\n\u2502   \u2514\u2500> Collect metrics                                              \u2502\n\u2502       - Total events returned                                      \u2502\n\u2502       - Files searched                                             \u2502\n\u2502       - Blocks scanned (decompressed)                              \u2502\n\u2502       - Blocks skipped (via indexes)                               \u2502\n\u2502       - Execution time (milliseconds)                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 Sorted events + metrics\n     v\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 5. Response Formatting (internal/api/)                             \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Format JSON response:                                              \u2502\n\u2502   {                                                                 \u2502\n\u2502     "events": [...],           // Array of ResourceEvent objects   \u2502\n\u2502     "count": 150,               // Total events returned           \u2502\n\u2502     "executionTimeMs": 45,      // Query duration                  \u2502\n\u2502     "filesSearched": 4,         // Hourly files accessed           \u2502\n\u2502     "segmentsScanned": 12,      // Blocks decompressed             \u2502\n\u2502     "segmentsSkipped": 88       // Blocks skipped (indexes)        \u2502\n\u2502   }                                                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 JSON response\n     v\nHTTP Client receives results\n'})}),"\n",(0,s.jsx)(n.h3,{id:"read-path-timing",children:"Read Path Timing"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Single-hour query with filters"})," (best case):"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Stage"}),(0,s.jsx)(n.th,{children:"Time"}),(0,s.jsx)(n.th,{children:"Notes"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Parameter parsing"}),(0,s.jsx)(n.td,{children:"<1 ms"}),(0,s.jsx)(n.td,{children:"Parse query string"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"File selection"}),(0,s.jsx)(n.td,{children:"<1 ms"}),(0,s.jsx)(n.td,{children:"Calculate hourly file names"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Read header/footer"}),(0,s.jsx)(n.td,{children:"~1 ms"}),(0,s.jsx)(n.td,{children:"77 + 324 bytes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Read index section"}),(0,s.jsx)(n.td,{children:"~10 ms"}),(0,s.jsx)(n.td,{children:"~2 MB JSON, parse"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Binary search timestamp"}),(0,s.jsx)(n.td,{children:"<1 ms"}),(0,s.jsx)(n.td,{children:"O(log N) on ~300 blocks"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Inverted index intersection"}),(0,s.jsx)(n.td,{children:"~1 ms"}),(0,s.jsx)(n.td,{children:"Set operations"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Block filtering result"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"2-10 blocks"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"90-98% skipped"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Read block data"}),(0,s.jsx)(n.td,{children:"~2 ms"}),(0,s.jsx)(n.td,{children:"Seek + read compressed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Decompress blocks"}),(0,s.jsx)(n.td,{children:"~30 ms"}),(0,s.jsx)(n.td,{children:"gzip decompress 10 MB total"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Decode protobuf"}),(0,s.jsx)(n.td,{children:"~20 ms"}),(0,s.jsx)(n.td,{children:"Parse events"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Event filtering"}),(0,s.jsx)(n.td,{children:"~5 ms"}),(0,s.jsx)(n.td,{children:"Exact match checks"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Sort + format"}),(0,s.jsx)(n.td,{children:"~5 ms"}),(0,s.jsx)(n.td,{children:"Sort by timestamp"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Total"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"~75 ms"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Typical filtered query"})})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"24-hour query with filters"})," (multi-file):"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Stage"}),(0,s.jsx)(n.th,{children:"Time"}),(0,s.jsx)(n.th,{children:"Notes"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"File selection"}),(0,s.jsx)(n.td,{children:"~1 ms"}),(0,s.jsx)(n.td,{children:"24 hourly files"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Per-file processing"}),(0,s.jsx)(n.td,{children:"~75 ms \xd7 24"}),(0,s.jsx)(n.td,{children:"Sequential file reads"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Result merge"}),(0,s.jsx)(n.td,{children:"~50 ms"}),(0,s.jsx)(n.td,{children:"Combine + sort results"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Total"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"~1.8 seconds"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"24 files"})})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Optimization opportunity"}),": Parallel file reads (planned v2.0)"]}),"\n",(0,s.jsx)(n.h3,{id:"concurrency-model-read-path",children:"Concurrency Model (Read Path)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Concurrent Queries                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                 \u2502\n\u2502  HTTP Request 1                HTTP Request 2                  \u2502\n\u2502         \u2502                              \u2502                        \u2502\n\u2502         v                              v                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                  \u2502\n\u2502  \u2502 Query 1     \u2502              \u2502 Query 2     \u2502                  \u2502\n\u2502  \u2502 Goroutine   \u2502              \u2502 Goroutine   \u2502                  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                  \u2502\n\u2502        \u2502                            \u2502                           \u2502\n\u2502        v                            v                           \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                   \u2502\n\u2502  \u2502   Read Files (immutable)                \u2502                   \u2502\n\u2502  \u2502   - No locking required                 \u2502                   \u2502\n\u2502  \u2502   - Each query reads independently      \u2502                   \u2502\n\u2502  \u2502   - OS page cache shared                \u2502                   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                   \u2502\n\u2502                                                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Key Points"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"One goroutine per request"}),": Each HTTP request handled independently"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"No coordination"}),": Files are immutable, no locks needed"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Shared page cache"}),": OS caches frequently accessed blocks"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Unlimited concurrency"}),": Only limited by OS resources"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"query-optimization-examples",children:"Query Optimization Examples"}),"\n",(0,s.jsx)(n.h4,{id:"example-1-no-filters-full-scan",children:"Example 1: No Filters (Full Scan)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Query: All events from 10:00-11:00\n\nFile: 2025-12-12-10.bin\n- Total blocks: 300\n- Blocks matching time range: 300 (all)\n- Blocks to decompress: 300\n- Events scanned: 60,000\n- Events returned: 60,000\n\nExecution time: ~400ms (decompress all blocks)\n"})}),"\n",(0,s.jsx)(n.h4,{id:"example-2-kind-filter",children:"Example 2: Kind Filter"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'Query: kind=Pod, 10:00-11:00\n\nFile: 2025-12-12-10.bin\n- Inverted index: KindToBlocks["Pod"] = [0, 2, 5, 7, ..., 290] (30 blocks)\n- Blocks to decompress: 30 (90% skip rate!)\n- Events scanned: 6,000\n- Events returned: 6,000\n\nExecution time: ~50ms (decompress 10% of blocks)\n'})}),"\n",(0,s.jsx)(n.h4,{id:"example-3-kind--namespace-filter",children:"Example 3: Kind + Namespace Filter"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'Query: kind=Pod, namespace=default, 10:00-11:00\n\nFile: 2025-12-12-10.bin\n- KindToBlocks["Pod"] = [0, 2, 5, 7, ..., 290] (30 blocks)\n- NamespaceToBlocks["default"] = [0, 1, 2, 3, 4, 5] (50 blocks)\n- Intersection: [0, 2, 5] (3 blocks, 99% skip rate!)\n- Blocks to decompress: 3\n- Events scanned: 600\n- Events returned: 200 (after exact match)\n\nExecution time: ~15ms (decompress 1% of blocks)\n'})}),"\n",(0,s.jsx)(n.h3,{id:"error-handling-read-path",children:"Error Handling (Read Path)"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Error Type"}),(0,s.jsx)(n.th,{children:"Handling"}),(0,s.jsx)(n.th,{children:"Response"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Invalid parameters"})}),(0,s.jsx)(n.td,{children:"Return 400 Bad Request"}),(0,s.jsx)(n.td,{children:"Error message to client"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"File not found"})}),(0,s.jsx)(n.td,{children:"Skip file, continue query"}),(0,s.jsx)(n.td,{children:"Partial results returned"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Corrupted header"})}),(0,s.jsx)(n.td,{children:"Skip file, log error"}),(0,s.jsx)(n.td,{children:"Partial results"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Corrupted footer"})}),(0,s.jsx)(n.td,{children:"Skip file, log error"}),(0,s.jsx)(n.td,{children:"Partial results"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Invalid index JSON"})}),(0,s.jsx)(n.td,{children:"Skip file, log error"}),(0,s.jsx)(n.td,{children:"Partial results"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Decompression error"})}),(0,s.jsx)(n.td,{children:"Skip block, log error"}),(0,s.jsx)(n.td,{children:"Partial results"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Protobuf decode error"})}),(0,s.jsx)(n.td,{children:"Skip event, log error"}),(0,s.jsx)(n.td,{children:"Partial results"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Timeout"})}),(0,s.jsx)(n.td,{children:"Return 504 Gateway Timeout"}),(0,s.jsx)(n.td,{children:"Client can retry"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Philosophy"}),": Partial results better than no results. Errors logged for debugging."]}),"\n",(0,s.jsx)(n.h2,{id:"data-transformations",children:"Data Transformations"}),"\n",(0,s.jsx)(n.h3,{id:"event-size-transformations",children:"Event Size Transformations"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Original Kubernetes Object (with managedFields)\n     \u2502  Size: ~10 KB\n     \u2502  Format: runtime.Object (Go struct)\n     v\nPruned ResourceEvent (managedFields removed)\n     \u2502  Size: ~1-2 KB (80-90% reduction)\n     \u2502  Format: ResourceEvent struct\n     v\nJSON-encoded Event\n     \u2502  Size: ~1.5 KB\n     \u2502  Format: JSON bytes\n     v\nProtobuf-encoded Event\n     \u2502  Size: ~1.2 KB (20% smaller than JSON)\n     \u2502  Format: Protobuf bytes\n     v\nCompressed Block (gzip)\n     \u2502  Size: ~300 bytes per event (~75% reduction)\n     \u2502  Format: gzip-compressed protobuf stream\n     v\nStored on Disk\n     \u2502  Size: ~300 bytes per event\n     \u2502  Includes: Event data + metadata + indexes\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Total reduction: 10 KB \u2192 300 bytes = 97% savings"})}),"\n",(0,s.jsx)(n.h3,{id:"metadata-evolution",children:"Metadata Evolution"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"ResourceEvent (original)\n     \u2502  Fields: UID, Kind, Namespace, Name, Timestamp, Operation, Object\n     v\nEventBuffer Metadata (aggregated)\n     \u2502  Fields: KindSet, NamespaceSet, GroupSet, TimestampMin/Max\n     \u2502  Purpose: Track block contents for indexing\n     v\nBlock Metadata (per block)\n     \u2502  Fields: ID, Offset, Length, EventCount, TimestampRange, Sets, Bloom filters\n     \u2502  Purpose: Enable filtering without decompression\n     v\nInverted Indexes (per file)\n     \u2502  Fields: KindToBlocks, NamespaceToBlocks, GroupToBlocks\n     \u2502  Purpose: Map filters \u2192 candidate blocks\n     v\nQuery Results\n     \u2502  Fields: Events[], Count, ExecutionTimeMs, FilesSearched, SegmentsScanned\n     \u2502  Purpose: Provide results + performance metrics\n"})}),"\n",(0,s.jsx)(n.h2,{id:"performance-characteristics",children:"Performance Characteristics"}),"\n",(0,s.jsx)(n.h3,{id:"write-path-throughput",children:"Write Path Throughput"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Component"}),(0,s.jsx)(n.th,{children:"Throughput"}),(0,s.jsx)(n.th,{children:"Bottleneck"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Watcher"}),(0,s.jsx)(n.td,{children:"10,000 events/sec"}),(0,s.jsx)(n.td,{children:"Kubernetes API rate limit"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Pruning"}),(0,s.jsx)(n.td,{children:"50,000 events/sec"}),(0,s.jsx)(n.td,{children:"CPU (JSON parsing)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Validation"}),(0,s.jsx)(n.td,{children:"100,000 events/sec"}),(0,s.jsx)(n.td,{children:"Minimal overhead"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Event queue"}),(0,s.jsx)(n.td,{children:"Unlimited"}),(0,s.jsx)(n.td,{children:"Memory-based channel"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"JSON marshal"}),(0,s.jsx)(n.td,{children:"20,000 events/sec"}),(0,s.jsx)(n.td,{children:"CPU (serialization)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Buffer accumulation"}),(0,s.jsx)(n.td,{children:"50,000 events/sec"}),(0,s.jsx)(n.td,{children:"Memory operations"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Block finalization"}),(0,s.jsx)(n.td,{children:"~800 events/130ms"}),(0,s.jsx)(n.td,{children:"gzip compression (CPU)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Sustained write rate"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"7,500 events/sec"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Bottleneck: compression"})})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"read-path-latency",children:"Read Path Latency"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Query Type"}),(0,s.jsx)(n.th,{children:"Latency (P50)"}),(0,s.jsx)(n.th,{children:"Latency (P99)"}),(0,s.jsx)(n.th,{children:"Bottleneck"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"1-hour, no filters"}),(0,s.jsx)(n.td,{children:"350 ms"}),(0,s.jsx)(n.td,{children:"500 ms"}),(0,s.jsx)(n.td,{children:"Decompression"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"1-hour, kind filter"}),(0,s.jsx)(n.td,{children:"45 ms"}),(0,s.jsx)(n.td,{children:"80 ms"}),(0,s.jsx)(n.td,{children:"I/O (block reads)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"1-hour, multi-filter"}),(0,s.jsx)(n.td,{children:"12 ms"}),(0,s.jsx)(n.td,{children:"25 ms"}),(0,s.jsx)(n.td,{children:"Inverted index ops"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"24-hour, filtered"}),(0,s.jsx)(n.td,{children:"180 ms"}),(0,s.jsx)(n.td,{children:"400 ms"}),(0,s.jsx)(n.td,{children:"Sequential file reads"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"7-day, filtered"}),(0,s.jsx)(n.td,{children:"1.2 s"}),(0,s.jsx)(n.td,{children:"2.5 s"}),(0,s.jsx)(n.td,{children:"File count"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Optimization"}),": Parallel file reads can reduce 24-hour query to ~50ms (planned v2.0)"]}),"\n",(0,s.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/spectre/docs/architecture/overview",children:"Architecture Overview"})," - System design and components"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/spectre/docs/architecture/storage-design",children:"Storage Design"})," - File organization and blocks"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/spectre/docs/architecture/query-execution",children:"Query Execution"})," - Query optimization details"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/spectre/docs/architecture/indexing-strategy",children:"Indexing Strategy"})," - Inverted indexes and bloom filters"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/spectre/docs/architecture/compression",children:"Compression"})," - Compression algorithms and performance"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>d,x:()=>l});var t=r(6540);const s={},i=t.createContext(s);function d(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:d(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);