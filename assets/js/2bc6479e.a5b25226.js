"use strict";(globalThis.webpackChunkspectre_docs=globalThis.webpackChunkspectre_docs||[]).push([[8945],{5802:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"configuration/watcher-config","title":"Watcher Configuration","description":"Configure which Kubernetes resources to monitor","source":"@site/docs/configuration/watcher-config.md","sourceDirName":"configuration","slug":"/configuration/watcher-config","permalink":"/spectre/docs/configuration/watcher-config","draft":false,"unlisted":false,"editUrl":"https://github.com/moolen/spectre/tree/master/docs/docs/configuration/watcher-config.md","tags":[],"version":"current","lastUpdatedBy":"Moritz Johner","lastUpdatedAt":1765669028000,"frontMatter":{"title":"Watcher Configuration","description":"Configure which Kubernetes resources to monitor","keywords":["watcher","resources","monitoring","gvk"]},"sidebar":"docsSidebar","previous":{"title":"Configuration","permalink":"/spectre/docs/configuration/"},"next":{"title":"Storage Settings","permalink":"/spectre/docs/configuration/storage-settings"}}');var r=s(4848),o=s(8453);const c={title:"Watcher Configuration",description:"Configure which Kubernetes resources to monitor",keywords:["watcher","resources","monitoring","gvk"]},l="Watcher Configuration",t={},a=[{value:"Overview",id:"overview",level:2},{value:"Default Configuration",id:"default-configuration",level:2},{value:"Resource Specification Format",id:"resource-specification-format",level:2},{value:"Required Fields",id:"required-fields",level:3},{value:"Optional Fields",id:"optional-fields",level:3},{value:"Examples",id:"examples",level:3},{value:"Automatic RBAC Permissions",id:"automatic-rbac-permissions",level:2},{value:"Static Permissions",id:"static-permissions",level:3},{value:"Dynamic Permissions",id:"dynamic-permissions",level:3},{value:"Namespace Management",id:"namespace-management",level:2},{value:"How It Works",id:"how-it-works",level:3},{value:"Cluster-Wide Watching",id:"cluster-wide-watching",level:3},{value:"Single Namespace",id:"single-namespace",level:3},{value:"Multiple Namespaces",id:"multiple-namespaces",level:3},{value:"Mixing Cluster-Wide and Namespaced",id:"mixing-cluster-wide-and-namespaced",level:3},{value:"Configuration Examples",id:"configuration-examples",level:2},{value:"Basic Setup",id:"basic-setup",level:3},{value:"Production Monitoring",id:"production-monitoring",level:3},{value:"Custom Resources (CRDs)",id:"custom-resources-crds",level:3},{value:"Multi-Environment",id:"multi-environment",level:3},{value:"Hot Reload",id:"hot-reload",level:2},{value:"How It Works",id:"how-it-works-1",level:3},{value:"Updating Configuration",id:"updating-configuration",level:3},{value:"Monitoring Reloads",id:"monitoring-reloads",level:3},{value:"Performance Considerations",id:"performance-considerations",level:2},{value:"Memory Usage",id:"memory-usage",level:3},{value:"Watch Efficiency",id:"watch-efficiency",level:3},{value:"Storage Optimization",id:"storage-optimization",level:3},{value:"Recommendations",id:"recommendations",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"\u2705 Do",id:"-do",level:3},{value:"\u274c Don&#39;t",id:"-dont",level:3},{value:"Validation Checklist",id:"validation-checklist",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Resource Not Being Watched",id:"resource-not-being-watched",level:3},{value:"CRD Not Found",id:"crd-not-found",level:3},{value:"Events Being Dropped",id:"events-being-dropped",level:3},{value:"High Memory Usage",id:"high-memory-usage",level:3},{value:"Configuration Not Reloading",id:"configuration-not-reloading",level:3},{value:"Integration Details",id:"integration-details",level:2},{value:"ConfigMap Mounting",id:"configmap-mounting",level:3},{value:"Command-Line Flags",id:"command-line-flags",level:3},{value:"Storage Integration",id:"storage-integration",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"watcher-configuration",children:"Watcher Configuration"})}),"\n",(0,r.jsx)(n.p,{children:"The Spectre watcher monitors Kubernetes resources and captures their state changes over time. This page explains how to configure which resources to watch and how namespace filtering works."}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.p,{children:"The watcher:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Monitors any Kubernetes resource type (built-in or custom)"}),"\n",(0,r.jsx)(n.li,{children:"Captures CREATE, UPDATE, and DELETE events"}),"\n",(0,r.jsx)(n.li,{children:"Supports namespace filtering for focused monitoring"}),"\n",(0,r.jsx)(n.li,{children:"Automatically reloads configuration without restarts"}),"\n",(0,r.jsx)(n.li,{children:"Efficiently uses a single watcher per resource type (GVR)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"default-configuration",children:"Default Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["By default, Spectre monitors ",(0,r.jsx)(n.strong,{children:"7 core Kubernetes resource types"})," as defined in ",(0,r.jsx)(n.code,{children:"chart/values.yaml"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'config:\n  watcher:\n    resources:\n      - group: ""\n        version: "v1"\n        kind: "Pod"\n      - group: "apps"\n        version: "v1"\n        kind: "Deployment"\n      - group: ""\n        version: "v1"\n        kind: "Service"\n      - group: ""\n        version: "v1"\n        kind: "Node"\n      - group: "apps"\n        version: "v1"\n        kind: "StatefulSet"\n      - group: "apps"\n        version: "v1"\n        kind: "DaemonSet"\n      - group: ""\n        version: "v1"\n        kind: "ConfigMap"\n'})}),"\n",(0,r.jsx)(n.p,{children:"These defaults cover the most commonly monitored workload and infrastructure resources."}),"\n",(0,r.jsx)(n.h2,{id:"resource-specification-format",children:"Resource Specification Format"}),"\n",(0,r.jsx)(n.p,{children:"Each resource specification requires three fields:"}),"\n",(0,r.jsx)(n.h3,{id:"required-fields",children:"Required Fields"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"group"})}),": API group (use empty string ",(0,r.jsx)(n.code,{children:'""'})," for core API resources like Pod, Service, Node)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"version"})}),": API version (e.g., ",(0,r.jsx)(n.code,{children:'"v1"'}),", ",(0,r.jsx)(n.code,{children:'"v1beta1"'}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"kind"})}),": Resource kind in PascalCase (e.g., ",(0,r.jsx)(n.code,{children:'"Pod"'}),", ",(0,r.jsx)(n.code,{children:'"Deployment"'}),")"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"optional-fields",children:"Optional Fields"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"namespace"})}),": Specific namespace to watch (omit or leave empty for cluster-wide watching)"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"examples",children:"Examples"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Core API resource (Pod):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'- group: ""          # Core API uses empty string\n  version: "v1"\n  kind: "Pod"\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Apps API resource (Deployment):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'- group: "apps"\n  version: "v1"\n  kind: "Deployment"\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Custom Resource (CRD):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'- group: "cert-manager.io"\n  version: "v1"\n  kind: "Certificate"\n'})}),"\n",(0,r.jsx)(n.h2,{id:"automatic-rbac-permissions",children:"Automatic RBAC Permissions"}),"\n",(0,r.jsxs)(n.p,{children:["The Helm chart ",(0,r.jsx)(n.strong,{children:"automatically grants RBAC permissions"})," for all configured resources via ",(0,r.jsx)(n.code,{children:"chart/templates/clusterrole.yaml"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"static-permissions",children:"Static Permissions"}),"\n",(0,r.jsx)(n.p,{children:"The ClusterRole includes static permissions for common Kubernetes resources:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# Core API resources\n- apiGroups: [""]\n  resources: [pods, services, configmaps, secrets, nodes, ...]\n  verbs: ["watch", "list", "get"]\n\n# Apps API group\n- apiGroups: ["apps"]\n  resources: [deployments, statefulsets, daemonsets, replicasets]\n  verbs: ["watch", "list", "get"]\n\n# Batch, Storage, Networking, Policy, RBAC...\n'})}),"\n",(0,r.jsx)(n.h3,{id:"dynamic-permissions",children:"Dynamic Permissions"}),"\n",(0,r.jsxs)(n.p,{children:["For resources defined in ",(0,r.jsx)(n.code,{children:"config.watcher.resources"}),", permissions are ",(0,r.jsx)(n.strong,{children:"automatically generated"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'{{- $watchResources := .Values.config.watcher.resources | default list }}\n{{- range $watchResources }}\n- apiGroups:\n    - {{ default "" .group | quote }}\n  resources:\n    - {{ include "spectre.kindToResource" . }}\n  verbs: ["watch", "list", "get"]\n{{- end }}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"spectre.kindToResource"})," helper converts Kind names to resource names:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Pod"})," \u2192 ",(0,r.jsx)(n.code,{children:"pods"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Deployment"})," \u2192 ",(0,r.jsx)(n.code,{children:"deployments"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Ingress"})," \u2192 ",(0,r.jsx)(n.code,{children:"ingresses"})," (special case)"]}),"\n",(0,r.jsx)(n.li,{children:"Generally: lowercase + 's' suffix"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Important:"})," When you add new resources to ",(0,r.jsx)(n.code,{children:"config.watcher.resources"}),", you must run ",(0,r.jsx)(n.code,{children:"helm upgrade"})," to update the ClusterRole. Once the config changes, spectre will pick up the change at runtime. No need to re-deploy."]}),"\n",(0,r.jsx)(n.h2,{id:"namespace-management",children:"Namespace Management"}),"\n",(0,r.jsxs)(n.p,{children:["Spectre supports both ",(0,r.jsx)(n.strong,{children:"cluster-wide"})," and ",(0,r.jsx)(n.strong,{children:"namespace-scoped"})," watching."]}),"\n",(0,r.jsx)(n.h3,{id:"how-it-works",children:"How It Works"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cluster-wide watching"})," (default): Monitors resources across all namespaces"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Namespace filtering"}),": Client-side filtering of events from specific namespaces"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Efficiency"}),": One watcher per GVR (Group/Version/Resource), regardless of namespace count"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note:"})," The watcher always watches at the cluster level but filters events client-side. This means:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u2705 Simple configuration"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 No missed resources in new namespaces (when cluster-wide)"}),"\n",(0,r.jsx)(n.li,{children:"\u274c Cannot reduce Kubernetes API server load via namespace scoping"}),"\n",(0,r.jsx)(n.li,{children:"\u274c Namespace changes require config reload"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"cluster-wide-watching",children:"Cluster-Wide Watching"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'resources:\n  - group: ""\n    version: "v1"\n    kind: "Pod"\n    # No namespace specified = all namespaces\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Use when:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"You want complete cluster visibility"}),"\n",(0,r.jsx)(n.li,{children:"Namespaces are dynamic"}),"\n",(0,r.jsx)(n.li,{children:"Storage is not a concern"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"single-namespace",children:"Single Namespace"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'resources:\n  - group: ""\n    version: "v1"\n    kind: "Pod"\n    namespace: "production"\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Use when:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"You only care about specific namespaces"}),"\n",(0,r.jsx)(n.li,{children:"Want to reduce storage usage"}),"\n",(0,r.jsx)(n.li,{children:"Have many namespaces but monitor few"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"multiple-namespaces",children:"Multiple Namespaces"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'resources:\n  - group: ""\n    version: "v1"\n    kind: "Pod"\n    namespace: "production"\n  - group: ""\n    version: "v1"\n    kind: "Pod"\n    namespace: "staging"\n  - group: ""\n    version: "v1"\n    kind: "Pod"\n    namespace: "development"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["This creates a ",(0,r.jsx)(n.strong,{children:"single watcher"})," for ",(0,r.jsx)(n.code,{children:"v1/pods"})," that filters for all three namespaces."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Use when:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"You have a known set of important namespaces"}),"\n",(0,r.jsx)(n.li,{children:"Want to exclude noisy namespaces (kube-system, etc.)"}),"\n",(0,r.jsx)(n.li,{children:"Need to balance visibility and storage"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"mixing-cluster-wide-and-namespaced",children:"Mixing Cluster-Wide and Namespaced"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'resources:\n  # Cluster-wide for Nodes (cluster-scoped resource)\n  - group: ""\n    version: "v1"\n    kind: "Node"\n\n  # All namespaces for Deployments\n  - group: "apps"\n    version: "v1"\n    kind: "Deployment"\n\n  # Specific namespace for Pods\n  - group: ""\n    version: "v1"\n    kind: "Pod"\n    namespace: "production"\n'})}),"\n",(0,r.jsx)(n.h2,{id:"configuration-examples",children:"Configuration Examples"}),"\n",(0,r.jsx)(n.h3,{id:"basic-setup",children:"Basic Setup"}),"\n",(0,r.jsx)(n.p,{children:"Monitor essential workload resources:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'config:\n  watcher:\n    resources:\n      - group: ""\n        version: "v1"\n        kind: "Pod"\n      - group: "apps"\n        version: "v1"\n        kind: "Deployment"\n      - group: "apps"\n        version: "v1"\n        kind: "StatefulSet"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"production-monitoring",children:"Production Monitoring"}),"\n",(0,r.jsx)(n.p,{children:"Focus on production namespace with key resources:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'config:\n  watcher:\n    resources:\n      # Production workloads\n      - group: ""\n        version: "v1"\n        kind: "Pod"\n        namespace: "production"\n      - group: "apps"\n        version: "v1"\n        kind: "Deployment"\n        namespace: "production"\n      - group: "apps"\n        version: "v1"\n        kind: "StatefulSet"\n        namespace: "production"\n\n      # Cluster-wide infrastructure\n      - group: ""\n        version: "v1"\n        kind: "Node"\n      - group: ""\n        version: "v1"\n        kind: "PersistentVolume"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"custom-resources-crds",children:"Custom Resources (CRDs)"}),"\n",(0,r.jsx)(n.p,{children:"Monitor Flux CD resources:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'config:\n  watcher:\n    resources:\n      # Flux GitOps resources\n      - group: "source.toolkit.fluxcd.io"\n        version: "v1"\n        kind: "GitRepository"\n      - group: "kustomize.toolkit.fluxcd.io"\n        version: "v1"\n        kind: "Kustomization"\n      - group: "helm.toolkit.fluxcd.io"\n        version: "v2"\n        kind: "HelmRelease"\n\n      # Cert-Manager\n      - group: "cert-manager.io"\n        version: "v1"\n        kind: "Certificate"\n      - group: "cert-manager.io"\n        version: "v1"\n        kind: "CertificateRequest"\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note:"})," CRDs must exist in the cluster before Spectre starts, or they will be logged as errors (non-fatal)."]}),"\n",(0,r.jsx)(n.h3,{id:"multi-environment",children:"Multi-Environment"}),"\n",(0,r.jsx)(n.p,{children:"Monitor multiple environments separately:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'config:\n  watcher:\n    resources:\n      # Production\n      - group: "apps"\n        version: "v1"\n        kind: "Deployment"\n        namespace: "prod-frontend"\n      - group: "apps"\n        version: "v1"\n        kind: "Deployment"\n        namespace: "prod-backend"\n\n      # Staging\n      - group: "apps"\n        version: "v1"\n        kind: "Deployment"\n        namespace: "staging"\n\n      # Shared infrastructure (all namespaces)\n      - group: ""\n        version: "v1"\n        kind: "Service"\n      - group: "networking.k8s.io"\n        version: "v1"\n        kind: "Ingress"\n'})}),"\n",(0,r.jsx)(n.h2,{id:"hot-reload",children:"Hot Reload"}),"\n",(0,r.jsxs)(n.p,{children:["Spectre ",(0,r.jsx)(n.strong,{children:"automatically reloads"})," watcher configuration without restarts."]}),"\n",(0,r.jsx)(n.h3,{id:"how-it-works-1",children:"How It Works"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Configuration file is checked every ",(0,r.jsx)(n.strong,{children:"5 seconds"})]}),"\n",(0,r.jsx)(n.li,{children:"Changes are detected via SHA256 hash comparison"}),"\n",(0,r.jsx)(n.li,{children:"Watchers are gracefully stopped and restarted"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Zero downtime"})," - readiness stays true during reload"]}),"\n",(0,r.jsx)(n.li,{children:"Invalid configurations are logged but don't stop existing watchers"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"updating-configuration",children:"Updating Configuration"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Via Helm:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Update values.yaml\nhelm upgrade spectre ./chart -f values.yaml\n\n# The ConfigMap is updated and Spectre detects it within 5 seconds\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Via kubectl:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Edit ConfigMap directly\nkubectl edit configmap spectre -n monitoring\n\n# Changes take effect within 5 seconds\n"})}),"\n",(0,r.jsx)(n.h3,{id:"monitoring-reloads",children:"Monitoring Reloads"}),"\n",(0,r.jsx)(n.p,{children:"Check logs for reload activity:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl logs -n monitoring deployment/spectre | grep -i reload\n"})}),"\n",(0,r.jsx)(n.p,{children:"Expected output:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"[INFO] watcher: Configuration changed, reloading watchers...\n[INFO] watcher: Successfully reloaded 5 watchers\n"})}),"\n",(0,r.jsx)(n.h2,{id:"performance-considerations",children:"Performance Considerations"}),"\n",(0,r.jsx)(n.h3,{id:"memory-usage",children:"Memory Usage"}),"\n",(0,r.jsx)(n.p,{children:"Typical resource usage:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Cluster Size"}),(0,r.jsx)(n.th,{children:"Resources Watched"}),(0,r.jsx)(n.th,{children:"Memory Request"}),(0,r.jsx)(n.th,{children:"Memory Limit"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Small (50 resources)"}),(0,r.jsx)(n.td,{children:"1-10 types"}),(0,r.jsx)(n.td,{children:"128Mi"}),(0,r.jsx)(n.td,{children:"512Mi"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Medium (50-500)"}),(0,r.jsx)(n.td,{children:"5-20 types"}),(0,r.jsx)(n.td,{children:"256Mi"}),(0,r.jsx)(n.td,{children:"1Gi"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Large (>500)"}),(0,r.jsx)(n.td,{children:"10-30 types"}),(0,r.jsx)(n.td,{children:"512Mi"}),(0,r.jsx)(n.td,{children:"2Gi"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Default from ",(0,r.jsx)(n.code,{children:"values.yaml"}),":"]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'resources:\n  requests:\n    memory: "128Mi"\n    cpu: "100m"\n  limits:\n    memory: "512Mi"\n    cpu: "500m"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"watch-efficiency",children:"Watch Efficiency"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"One watcher per GVR"}),": Watching Pods in 10 namespaces = 1 watcher, not 10"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Pagination"}),": Lists resources in batches of 500"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Client-side filtering"}),": Namespace filtering happens in Spectre, not at API server"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Retry logic"}),": Exponential backoff on errors (5s initial delay)"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"storage-optimization",children:"Storage Optimization"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"ManagedFields pruning"}),": Removes Kubernetes metadata to reduce object size by ~30-50%"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Compression"}),": Events are compressed before storage"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Event queue"}),": Buffered queue prevents memory spikes (drops events when full)"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"recommendations",children:"Recommendations"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Start Simple:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# Begin with defaults\nconfig:\n  watcher:\n    resources:\n      - group: ""\n        version: "v1"\n        kind: "Pod"\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Add Gradually:"}),"\nMonitor resource usage as you add more resource types."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Use Namespace Filtering:"}),"\nIf you have many namespaces but only care about a few, use namespace filtering to reduce event volume:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'resources:\n  - group: ""\n    version: "v1"\n    kind: "Pod"\n    namespace: "critical-app"\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Watch Cluster-Scoped Resources Sparingly:"}),"\nResources like Nodes, PersistentVolumes, and ClusterRoles change less frequently but can't be namespace-filtered."]}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"-do",children:"\u2705 Do"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Start with defaults"})," and add resources as needed"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use namespace filtering"})," to reduce noise in large clusters"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Monitor memory usage"})," and adjust limits accordingly"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Group related resources"})," in your configuration for clarity"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Include CRDs"})," that are critical to your infrastructure (GitOps, service mesh, etc.)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test configuration changes"})," in development before production"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Monitor queue metrics"})," to ensure events aren't being dropped"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"-dont",children:"\u274c Don't"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Don't watch resources you don't query"})," - it wastes storage"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Don't add all CRDs blindly"})," - only watch what you need"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Don't ignore memory limits"})," - set them based on your cluster size"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Don't forget RBAC updates"})," - ",(0,r.jsx)(n.code,{children:"helm upgrade"})," when adding new resource types"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Don't mix versions"})," - if you watch ",(0,r.jsx)(n.code,{children:"apps/v1/Deployment"}),", don't also watch ",(0,r.jsx)(n.code,{children:"apps/v1beta1/Deployment"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"validation-checklist",children:"Validation Checklist"}),"\n",(0,r.jsx)(n.p,{children:"Before deploying a new watcher configuration:"}),"\n",(0,r.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","All required fields present (group, version, kind)"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","API versions match your cluster (check with ",(0,r.jsx)(n.code,{children:"kubectl api-resources"}),")"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","CRDs exist if watching custom resources"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","RBAC permissions will be granted (via Helm upgrade)"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Namespace names are correct (if using namespace filtering)"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Memory limits adjusted for cluster size"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Configuration validated locally:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Validate YAML syntax\ncat watcher.yaml | yq eval\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.h3,{id:"resource-not-being-watched",children:"Resource Not Being Watched"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," Added a resource but not seeing events"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Check if resource exists: ",(0,r.jsx)(n.code,{children:"kubectl api-resources | grep <resource>"})]}),"\n",(0,r.jsxs)(n.li,{children:["Verify RBAC: ",(0,r.jsx)(n.code,{children:"kubectl auth can-i watch <resource> --as=system:serviceaccount:monitoring:spectre"})]}),"\n",(0,r.jsxs)(n.li,{children:["Check logs: ",(0,r.jsx)(n.code,{children:"kubectl logs -n monitoring deployment/spectre | grep -i <kind>"})]}),"\n",(0,r.jsxs)(n.li,{children:["Confirm Helm upgrade ran: ",(0,r.jsx)(n.code,{children:"kubectl get clusterrole spectre -o yaml"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"crd-not-found",children:"CRD Not Found"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"}),' Logs show "failed to resolve GVR" for custom resource']}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"}),"\nThe CRD doesn't exist. Install it first:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Check if CRD exists\nkubectl get crd | grep <name>\n\n# Install the CRD (example for cert-manager)\nkubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.crds.yaml\n"})}),"\n",(0,r.jsx)(n.h3,{id:"events-being-dropped",children:"Events Being Dropped"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"}),' Logs show "Event queue is full, dropping event"']}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Increase queue size (requires code change)"}),"\n",(0,r.jsx)(n.li,{children:"Reduce watched resources"}),"\n",(0,r.jsx)(n.li,{children:"Add namespace filtering"}),"\n",(0,r.jsx)(n.li,{children:"Increase CPU/memory limits"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"high-memory-usage",children:"High Memory Usage"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," Spectre pod using more memory than expected"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Check number of resources being watched"}),"\n",(0,r.jsx)(n.li,{children:"Add namespace filtering to reduce event volume"}),"\n",(0,r.jsx)(n.li,{children:"Verify managedFields pruning is working (check event sizes in storage)"}),"\n",(0,r.jsxs)(n.li,{children:["Increase memory limits in ",(0,r.jsx)(n.code,{children:"values.yaml"}),":","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'resources:\n  limits:\n    memory: "1Gi"  # Increase from 512Mi\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"configuration-not-reloading",children:"Configuration Not Reloading"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," Changed ConfigMap but Spectre still using old config"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Solutions:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Check if ConfigMap was updated: ",(0,r.jsx)(n.code,{children:"kubectl get cm spectre -n monitoring -o yaml"})]}),"\n",(0,r.jsx)(n.li,{children:"Wait 5 seconds (reload interval)"}),"\n",(0,r.jsx)(n.li,{children:"Check logs for reload messages"}),"\n",(0,r.jsxs)(n.li,{children:["Restart pod if necessary: ",(0,r.jsx)(n.code,{children:"kubectl rollout restart deployment/spectre -n monitoring"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"integration-details",children:"Integration Details"}),"\n",(0,r.jsx)(n.h3,{id:"configmap-mounting",children:"ConfigMap Mounting"}),"\n",(0,r.jsx)(n.p,{children:"Configuration is stored in a Kubernetes ConfigMap and mounted into the pod:"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"ConfigMap:"})," ",(0,r.jsx)(n.code,{children:"chart/templates/configmap.yaml"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: spectre\ndata:\n  watcher.yaml: |\n    resources:\n    {{- range .Values.config.watcher.resources }}\n      - group: {{ .group | quote }}\n        version: {{ .version | quote }}\n        kind: {{ .kind | quote }}\n        {{- if .namespace }}\n        namespace: {{ .namespace | quote }}\n        {{- end }}\n    {{- end }}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Mount Point:"})," ",(0,r.jsx)(n.code,{children:"/etc/watcher/watcher.yaml"})]}),"\n",(0,r.jsx)(n.h3,{id:"command-line-flags",children:"Command-Line Flags"}),"\n",(0,r.jsx)(n.p,{children:"Spectre binary is started with:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"spectre --watcher-config=/etc/watcher/watcher.yaml\n"})}),"\n",(0,r.jsx)(n.h3,{id:"storage-integration",children:"Storage Integration"}),"\n",(0,r.jsx)(n.p,{children:"Each event captured by the watcher includes:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Event ID"}),": Unique UUID"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Timestamp"}),": Unix nanoseconds"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Type"}),": CREATE, UPDATE, or DELETE"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Resource Metadata"}),": Group, version, kind, namespace, name, UID"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Data"}),": Full resource JSON (with managedFields pruned)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sizes"}),": Original and compressed sizes"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Events are written to block-based storage for efficient querying."})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>l});var i=s(6540);const r={},o=i.createContext(r);function c(e){const n=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);